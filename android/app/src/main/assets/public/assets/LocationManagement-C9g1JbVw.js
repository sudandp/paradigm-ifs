import{u as ae,j as e,T as re,I as x,B as w,m as l,H as ne,J}from"./index-D5q3SS3D.js";import{b as n,R as oe}from"./react-vendor-BUaIliXj.js";import{A as ie}from"./AdminPageHeader-wINx_pXe.js";import{S as de}from"./Select-Dz12MdxG.js";import{P as ce}from"./Pagination-DXf7cs0z.js";import{L as le}from"./LoadingScreen-_hPz2y_i.js";import{M as O,a_ as me,aJ as Q,ao as ue,z as he,aj as xe,as as _,at as K}from"./ui-vendor-B8EvWqdc.js";import"./pdf-vendor-CB_F1AVu.js";import"./capacitor-vendor-CqiIOUn1.js";import"./utils-vendor-DmorxLnX.js";import"./supabase-7WG3J4rU.js";const ge=(L,i,g,p)=>{const m=L*Math.PI/180,d=g*Math.PI/180,b=(g-L)*Math.PI/180,c=(p-i)*Math.PI/180,j=Math.sin(b/2)*Math.sin(b/2)+Math.cos(m)*Math.cos(d)*Math.sin(c/2)*Math.sin(c/2);return 6371e3*(2*Math.atan2(Math.sqrt(j),Math.sqrt(1-j)))},Pe=()=>{const{user:L}=ae(),[i,g]=n.useState([]),[p,I]=n.useState([]),[m,d]=n.useState(""),[b,c]=n.useState("100"),[j,u]=n.useState(""),[R,N]=n.useState(""),[C,f]=n.useState(""),[A,D]=n.useState(""),[P,E]=n.useState([]),[V,W]=n.useState(!0),[M,r]=n.useState(null),[T,B]=n.useState(!1),[F,X]=n.useState(1),[k,Y]=n.useState(10),[v,Z]=n.useState(""),[h,U]=n.useState(null);n.useEffect(()=>{(async()=>{try{const[a,t]=await Promise.all([l.getLocations(),l.getUsers()]);g(a),I(t)}catch(a){console.error(a),r({message:"Failed to load locations or users.",type:"error"})}finally{await new Promise(a=>setTimeout(a,1e4)),W(!1)}})()},[]);const q=oe.useMemo(()=>{const s=new Map;return p.forEach(a=>s.set(a.id,a.name)),s},[p]),z=async()=>{try{const s=await l.getLocations();g(s)}catch(s){console.error(s),r({message:"Failed to refresh locations.",type:"error"})}},ee=async()=>{B(!0),r({message:"Acquiring your location, please wait...",type:"success"});try{const s=await ne(),{latitude:a,longitude:t}=s.coords;u(a.toString()),N(t.toString());try{const o=await J(a,t);C||f(o),m||d(o)}catch(o){console.warn("Reverse geocode failed",o)}r({message:"Location acquired successfully! Coordinates and address have been filled.",type:"success"})}catch(s){console.error(s);const a=s.message?.toLowerCase().includes("permission")?"Location permission denied. Please enable it in settings.":"Unable to acquire location fix. Please ensure GPS is on and you are in an open area.";r({message:a,type:"error"})}finally{B(!1)}},H=async()=>{const s=parseFloat(b),a=parseFloat(j),t=parseFloat(R);if(isNaN(s)||s<10||s>1e3){r({message:"Radius must be between 10 and 1000 meters.",type:"error"});return}if(isNaN(a)||isNaN(t)){r({message:"Please provide valid latitude and longitude.",type:"error"});return}try{const o=C||await J(a,t);if(!h){const y=i.find(S=>ge(a,t,S.latitude,S.longitude)<10);if(y){const S=y.name||y.address||"Unnamed Location";r({message:`A location already exists at these coordinates: "${S}".`,type:"error"});return}}h?(await l.updateLocation(h,{name:m||o,latitude:a,longitude:t,radius:s,address:o}),r({message:"Location updated successfully.",type:"success"}),U(null)):(await l.createLocation({name:m||o,latitude:a,longitude:t,radius:s,address:o,createdBy:L?.id||null}),r({message:"Location created successfully.",type:"success"})),d(""),c("100"),u(""),N(""),f(""),await z()}catch(o){console.error(o);const y=o?.message||(h?"Failed to update location.":"Failed to create location.");r({message:y,type:"error"})}},se=async()=>{if(!A||P.length===0){r({message:"Please select a user and at least one location.",type:"error"});return}try{await Promise.all(P.map(s=>l.assignLocationToUser(A,s))),r({message:"Location(s) assigned to user.",type:"success"}),D(""),E([])}catch(s){console.error(s),r({message:"Failed to assign location(s).",type:"error"})}},$=s=>{U(s.id),d(s.name||""),c(s.radius.toString()),u(s.latitude.toString()),N(s.longitude.toString()),f(s.address||""),window.scrollTo({top:0,behavior:"smooth"})},te=()=>{U(null),d(""),c("100"),u(""),N(""),f("")},G=async s=>{if(window.confirm("Are you sure you want to delete this location? This will remove it from all users and the database."))try{await l.deleteLocation(s),r({message:"Location deleted successfully from all users and database.",type:"success"}),await z()}catch(a){console.error(a);const t=a?.message||"Failed to delete location.";r({message:t,type:"error"})}};return V?e.jsx(le,{message:"Loading locations..."}):e.jsxs("div",{className:"p-4 md:p-6 w-full",children:[M&&e.jsx(re,{message:M.message,type:M.type,onDismiss:()=>r(null)}),e.jsxs("div",{className:"border-0 shadow-none md:bg-card md:p-6 md:rounded-xl md:shadow-card",children:[e.jsx(ie,{title:"Location Management"}),e.jsx("p",{className:"text-muted -mt-4 mb-6",children:"Define geofenced locations and assign them to staff. Only checkâ€‘ins within these locations will be accepted."})]}),e.jsxs("div",{className:"mt-6 space-y-6",children:[e.jsxs("section",{className:"bg-card border border-border rounded-lg p-4",children:[e.jsxs("h3",{className:"text-lg font-semibold text-primary-text mb-4 flex items-center",children:[e.jsx(O,{className:"h-5 w-5 mr-2 text-muted"})," ",h?"Edit Location":"Add New Location"]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4",children:[e.jsx(x,{label:"Name (optional)",id:"locName",name:"locationName",autoComplete:"organization",value:m,onChange:s=>d(s.target.value),placeholder:"e.g. Office HQ"}),e.jsx(x,{label:"Radius (meters)",id:"locRadius",name:"locationRadius",type:"number",value:b,onChange:s=>c(s.target.value),min:"10",max:"1000"}),e.jsx(x,{label:"Latitude",id:"locLat",name:"locationLat",type:"number",value:j,onChange:s=>u(s.target.value),placeholder:"12.9716"}),e.jsx(x,{label:"Longitude",id:"locLng",name:"locationLng",type:"number",value:R,onChange:s=>N(s.target.value),placeholder:"77.5946"}),e.jsx(x,{label:"Address (optional)",id:"locAddr",name:"locationAddress",autoComplete:"street-address",value:C,onChange:s=>f(s.target.value),placeholder:"Street, City, State"})]}),e.jsxs("div",{className:"flex flex-wrap mt-4 gap-4",children:[e.jsxs(w,{variant:"secondary",onClick:ee,isLoading:T,disabled:T,children:[e.jsx(me,{className:"h-4 w-4 mr-2"})," Use Current Location"]}),h?e.jsxs(e.Fragment,{children:[e.jsxs(w,{onClick:H,children:[e.jsx(Q,{className:"h-4 w-4 mr-2"})," Save Changes"]}),e.jsx(w,{variant:"secondary",onClick:te,children:"Cancel"})]}):e.jsxs(w,{onClick:H,children:[e.jsx(ue,{className:"h-4 w-4 mr-2"})," Add Location"]})]})]}),e.jsxs("section",{className:"bg-card border border-border rounded-lg p-4",children:[e.jsxs("h3",{className:"text-lg font-semibold text-primary-text mb-4 flex items-center",children:[e.jsx(he,{className:"h-5 w-5 mr-2 text-muted"})," Assign Location to User"]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs(de,{label:"Select User",id:"assignUser",name:"assignUser",value:A,onChange:s=>D(s.target.value),children:[e.jsx("option",{value:"",children:"-- Select User --"}),p.map(s=>e.jsx("option",{value:s.id,children:s.name},s.id))]}),e.jsxs("div",{children:[e.jsx("p",{className:"block text-sm font-medium text-muted mb-2",children:"Select Location(s)"}),e.jsx("div",{className:"border border-border rounded-lg p-3 max-h-48 overflow-y-auto bg-page",children:i.length===0?e.jsx("p",{className:"text-muted text-sm",children:"No locations available."}):i.map(s=>e.jsxs("label",{className:"flex items-center justify-start gap-2 py-1 text-sm",children:[e.jsx("input",{type:"checkbox",className:"form-checkbox h-4 w-4 text-accent border-gray-300 rounded",checked:P.includes(s.id),onChange:a=>{E(t=>a.target.checked?[...t,s.id]:t.filter(o=>o!==s.id))}}),e.jsx("span",{children:s.name||s.address||`${s.latitude.toFixed(4)}, ${s.longitude.toFixed(4)}`})]},s.id))})]})]}),e.jsx("div",{className:"flex justify-end mt-4",children:e.jsxs(w,{onClick:se,className:"w-full md:w-auto",children:[e.jsx(Q,{className:"h-4 w-4 mr-2"})," Assign"]})})]}),e.jsxs("section",{children:[e.jsxs("h3",{className:"text-xl font-semibold text-primary-text mb-4 flex items-center",children:[e.jsx(O,{className:"h-5 w-5 mr-2 text-muted"})," Existing Locations"]}),e.jsx("div",{className:"mb-4",children:e.jsx(x,{id:"locations-search",name:"locationsSearch",placeholder:"Search locations by name...",value:v,onChange:s=>Z(s.target.value),icon:e.jsx(xe,{className:"h-4 w-4"})})}),i.length===0?e.jsx("p",{className:"text-muted text-center md:text-left",children:"No locations defined yet."}):(()=>{const s=i.filter(t=>v===""||t.name&&t.name.toLowerCase().includes(v.toLowerCase())||t.address&&t.address.toLowerCase().includes(v.toLowerCase())),a=s.slice((F-1)*k,F*k);return e.jsxs("div",{className:"space-y-4 md:space-y-0",children:[e.jsx("div",{className:"md:hidden space-y-4",children:a.map(t=>e.jsxs("div",{className:"bg-card rounded-lg shadow-card p-4 border border-border",children:[e.jsxs("div",{className:"flex justify-between items-start",children:[e.jsxs("div",{children:[e.jsx("h4",{className:"font-bold text-primary-text",children:t.name||"Unnamed Location"}),e.jsx("p",{className:"text-sm text-muted",children:t.address})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx("button",{type:"button",className:"text-blue-500 hover:text-blue-700 p-1",title:"Edit",onClick:()=>$(t),children:e.jsx(_,{className:"h-5 w-5"})}),e.jsx("button",{type:"button",className:"p-2 hover:bg-red-500/10 rounded-full transition-colors",title:"Delete",onClick:()=>G(t.id),children:e.jsx(K,{className:"h-5 w-5 text-red-500"})})]})]}),e.jsxs("div",{className:"mt-4 pt-4 border-t border-border grid grid-cols-2 gap-4 text-sm",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-muted",children:"Radius"}),e.jsxs("p",{children:[t.radius,"m"]})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-muted",children:"Coordinates"}),e.jsxs("p",{children:[t.latitude.toFixed(4),", ",t.longitude.toFixed(4)]})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-muted",children:"Created By"}),e.jsx("p",{children:t.createdByName||q.get(t.createdBy||"")||"-"})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-muted",children:"Created At"}),e.jsx("p",{children:t.createdAt?new Date(t.createdAt).toLocaleDateString():"-"})]})]})]},t.id))}),e.jsx("div",{className:"hidden md:block overflow-x-auto border border-border rounded-lg",children:e.jsxs("table",{className:"min-w-full border-collapse text-sm",children:[e.jsx("thead",{className:"bg-page text-primary-text",children:e.jsxs("tr",{children:[e.jsx("th",{className:"p-3 border-b border-border text-left",children:"Name"}),e.jsx("th",{className:"p-3 border-b border-border text-left",children:"Radius (m)"}),e.jsx("th",{className:"p-3 border-b border-border text-left",children:"Coordinates"}),e.jsx("th",{className:"p-3 border-b border-border text-left",children:"Address"}),e.jsx("th",{className:"p-3 border-b border-border text-left",children:"Created By"}),e.jsx("th",{className:"p-3 border-b border-border text-left",children:"Created At"}),e.jsx("th",{className:"p-3 border-b border-border text-left",children:"Actions"})]})}),e.jsx("tbody",{children:a.map(t=>e.jsxs("tr",{className:"border-b border-border",children:[e.jsx("td",{className:"p-3",children:t.name||"-"}),e.jsx("td",{className:"p-3",children:t.radius}),e.jsxs("td",{className:"p-3",children:[t.latitude.toFixed(4),", ",t.longitude.toFixed(4)]}),e.jsx("td",{className:"p-3",children:t.address||"-"}),e.jsx("td",{className:"p-3",children:t.createdByName||q.get(t.createdBy||"")||"-"}),e.jsx("td",{className:"p-3",children:t.createdAt?new Date(t.createdAt).toLocaleString():"-"}),e.jsxs("td",{className:"p-3 whitespace-nowrap",children:[e.jsx("button",{type:"button",className:"text-blue-600 hover:text-blue-800 mr-3",title:"Edit",onClick:()=>$(t),children:e.jsx(_,{className:"h-4 w-4"})}),e.jsx("button",{type:"button",className:"p-2 hover:bg-red-500/10 rounded-full transition-colors",title:"Delete",onClick:()=>G(t.id),children:e.jsx(K,{className:"h-5 w-5 text-red-500"})})]})]},t.id))})]})}),e.jsx(ce,{currentPage:F,totalItems:s.length,pageSize:k,onPageChange:X,onPageSizeChange:Y,className:"mt-4"})]})})()]})]})]})};export{Pe as default};
