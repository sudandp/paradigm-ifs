import{h as U,j as e,T as M,B as L,m as N,c as A,u as O,C as B,I as D}from"./index-D5q3SS3D.js";import{b as f,u as _,j as W,R as H}from"./react-vendor-BUaIliXj.js";import{S as T}from"./Select-Dz12MdxG.js";import{M as J}from"./Modal-CR2aBU6L.js";import{a2 as V,R as K,n as X,as as Y,at as Z,J as ee,ao as se,aJ as te}from"./ui-vendor-B8EvWqdc.js";import{f as ae}from"./utils-vendor-DmorxLnX.js";import"./pdf-vendor-CB_F1AVu.js";import"./capacitor-vendor-CqiIOUn1.js";import"./supabase-7WG3J4rU.js";const ie=({status:g})=>{const l={Pending:"bg-yellow-900/50 text-yellow-300 border border-yellow-500/50",Approved:"bg-blue-900/50 text-blue-300 border border-blue-500/50",Issued:"bg-green-900/50 text-green-300 border border-green-500/50",Rejected:"bg-red-900/50 text-red-300 border border-red-500/50"};return e.jsx("span",{className:`fo-status-badge ${l[g]}`,children:g})},P=({title:g,sizes:l,headers:j,control:o,quantityType:c})=>{const S=Array.from(new Set(l.map(a=>a.fit))),d=Array.from(new Set(l.map(a=>a.size))).sort((a,x)=>{const u=parseInt(String(a)),i=parseInt(String(x));return!isNaN(u)&&!isNaN(i)?u-i:String(a).localeCompare(String(x))});return e.jsxs("div",{className:"border border-border rounded-lg",children:[e.jsx("h4",{className:"p-3 font-semibold bg-accent text-white border-b border-accent",children:g}),e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"min-w-full text-sm",children:[e.jsx("thead",{className:"bg-page",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-3 py-2 text-left font-medium text-muted",children:"Size"}),j.map(a=>e.jsx("th",{className:"px-3 py-2 text-left font-medium text-muted",children:a.label},String(a.key))),e.jsx("th",{className:"px-3 py-2 text-left font-medium text-muted w-24",children:"Quantity"})]})}),e.jsx("tbody",{className:"divide-y divide-border",children:d.map(a=>e.jsx(H.Fragment,{children:S.map((x,u)=>{const i=l.find(t=>t.size===a&&t.fit===x);return i?e.jsxs("tr",{children:[u===0&&e.jsx("td",{rowSpan:S.filter(t=>l.some(h=>h.size===a&&h.fit===t)).length,className:"px-3 py-2 align-middle font-semibold border-r",children:a}),j.map(t=>e.jsx("td",{className:"px-3 py-2",children:i[t.key]},String(t.key))),e.jsx("td",{className:"px-3 py-2",children:e.jsx(B,{name:`${c}.${i.id}`,control:o,render:({field:t})=>e.jsx(D,{"aria-label":`Quantity for ${g} size ${a} ${x}`,type:"number",...t,value:t.value||"",onChange:h=>t.onChange(parseInt(h.target.value)||null),className:"!py-1.5"})})})]},i.id):null})},a))})]})})]})},ne=({onSave:g,onCancel:l,sites:j,masterUniforms:o,initialData:c})=>{const{register:S,control:d,handleSubmit:a,watch:x,reset:u}=A({defaultValues:{siteId:"",gender:"Gents",pantsQuantities:{},shirtsQuantities:{}}}),{data:i}=U(),{user:t}=O(),h=x("gender"),k=x("siteId");f.useEffect(()=>{if(c){const n={},y={};c.items.forEach(m=>{m.category==="Pants"?n[m.sizeId]=m.quantity:y[m.sizeId]=m.quantity}),u({siteId:c.siteId,gender:c.gender,pantsQuantities:n,shirtsQuantities:y})}else{const n=i.organization.organizationId||"",m=i.personal.gender==="Female"?"Ladies":"Gents";u({siteId:n,gender:m,pantsQuantities:{},shirtsQuantities:{}})}},[c,u,i]);const z=n=>{const y=j.find(r=>r.id===n.siteId);if(!y||!t)return;const m=h==="Gents"?[...o.gents.pants,...o.gents.shirts]:[...o.ladies.pants,...o.ladies.shirts],v=[];for(const[r,p]of Object.entries(n.pantsQuantities))if(p&&p>0){const b=m.find(R=>R.id===r);b&&v.push({sizeId:r,quantity:p,category:"Pants",sizeLabel:b.size,fit:b.fit})}for(const[r,p]of Object.entries(n.shirtsQuantities))if(p&&p>0){const b=m.find(R=>R.id===r);b&&v.push({sizeId:r,quantity:p,category:"Shirts",sizeLabel:b.size,fit:b.fit})}const I={id:c?.id||`new_${Date.now()}`,siteId:n.siteId,siteName:y.shortName,gender:n.gender,requestedDate:c?.requestedDate||new Date().toISOString(),status:c?.status||"Pending",items:v,source:"Individual",requestedById:t.id,requestedByName:t.name,employeeDetails:[{employeeName:`${i.personal.firstName} ${i.personal.lastName}`,employeeId:i.personal.employeeId,items:v.map(r=>({itemName:r.category,sizeLabel:r.sizeLabel,fit:r.fit,quantity:r.quantity}))}]};g(I)};return e.jsx("form",{onSubmit:a(z),children:e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:[e.jsxs(T,{label:"Select Site",value:k,...S("siteId"),required:!0,disabled:!0,children:[e.jsx("option",{value:"",children:"-- Select a Site --"}),j.map(n=>e.jsx("option",{value:n.id,children:n.shortName},n.id))]}),e.jsxs(T,{label:"Select Uniform Type",value:h,...S("gender"),disabled:!0,children:[e.jsx("option",{children:"Gents"}),e.jsx("option",{children:"Ladies"})]})]}),e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:h==="Gents"?e.jsxs(e.Fragment,{children:[e.jsx(P,{title:"Gents' Pants",sizes:o.gents.pants,headers:[{key:"length",label:"L"},{key:"waist",label:"W"},{key:"hip",label:"H"},{key:"fit",label:"Fit"}],control:d,quantityType:"pantsQuantities"}),e.jsx(P,{title:"Gents' Shirts",sizes:o.gents.shirts,headers:[{key:"length",label:"L"},{key:"sleeves",label:"S"},{key:"chest",label:"C"},{key:"fit",label:"Fit"}],control:d,quantityType:"shirtsQuantities"})]}):e.jsxs(e.Fragment,{children:[e.jsx(P,{title:"Ladies' Pants",sizes:o.ladies.pants,headers:[{key:"length",label:"L"},{key:"waist",label:"W"},{key:"hip",label:"H"},{key:"fit",label:"Fit"}],control:d,quantityType:"pantsQuantities"}),e.jsx(P,{title:"Ladies' Shirts",sizes:o.ladies.shirts,headers:[{key:"length",label:"L"},{key:"sleeves",label:"S"},{key:"bust",label:"B"},{key:"shoulder",label:"Sh"},{key:"fit",label:"Fit"}],control:d,quantityType:"shirtsQuantities"})]})}),e.jsxs("div",{className:"flex justify-end gap-3 pt-4 border-t border-[#374151]",children:[e.jsx(L,{type:"button",variant:"secondary",onClick:l,children:"Cancel"}),e.jsxs(L,{type:"submit",children:[e.jsx(te,{className:"mr-2 h-4 w-4"})," Save Request"]})]})]})})},pe=()=>{const[g,l]=f.useState("list"),[j,o]=f.useState([]),[c,S]=f.useState([]),[d,a]=f.useState(null),[x,u]=f.useState(!0),[i,t]=f.useState(null),[h,k]=f.useState(null),[z,n]=f.useState(null),y=_(),[m]=W(),{updateUniforms:v}=U(),I=m.get("from")==="onboarding",r=async()=>{u(!0);try{const[s,q,C,w]=await Promise.all([N.getUniformRequests(),N.getOrganizations(),N.getMasterGentsUniforms(),N.getMasterLadiesUniforms()]);o(s.sort((F,Q)=>new Date(Q.requestedDate).getTime()-new Date(F.requestedDate).getTime())),S(q),a({gents:C,ladies:w})}catch{t({message:"Failed to load uniform data.",type:"error"})}finally{u(!1)}};f.useEffect(()=>{r()},[]),f.useEffect(()=>{I&&(l("form"),k(null))},[I]);const p=()=>{k(null),l("form")},b=s=>{k(s),l("form")},R=async s=>{if(I&&d){const q=s.gender==="Ladies"?[...d.ladies.pants,...d.ladies.shirts]:[...d.gents.pants,...d.gents.shirts],C=s.items.map(w=>{const F=q.find(E=>E.id===w.sizeId),Q=w.category==="Pants"?`${s.gender}' Pants`:`${s.gender}' Shirts`;return{itemId:`generic_${s.gender.toLowerCase()}_${w.category==="Pants"?"pants":"shirts"}`,itemName:Q,sizeId:w.sizeId,sizeLabel:F?.size||"",fit:F?.fit||"",quantity:w.quantity}});v(C),await N.submitUniformRequest(s),y(-1);return}try{s.id.startsWith("new_")?(await N.submitUniformRequest(s),t({message:"New request submitted.",type:"success"})):(await N.updateUniformRequest(s),t({message:"Request updated.",type:"success"})),l("list"),r()}catch{t({message:"Failed to save request.",type:"error"})}},$=async()=>{if(z)try{await N.deleteUniformRequest(z.id),t({message:"Request deleted.",type:"success"}),n(null),r()}catch{t({message:"Failed to delete request.",type:"error"})}},G=s=>s.reduce((q,C)=>q+C.quantity,0);if(x||!d)return e.jsx("div",{className:"flex justify-center items-center h-full",children:e.jsx(V,{className:"h-8 w-8 animate-spin text-muted"})});if(g==="form"){const s=()=>{I?y(-1):l("list")};return e.jsxs("div",{className:"h-full flex flex-col",children:[e.jsxs("header",{className:"p-4 flex-shrink-0 flex items-center gap-4 fo-mobile-header",children:[e.jsx("button",{onClick:s,"aria-label":"Go back",children:e.jsx(K,{className:"h-6 w-6"})}),e.jsxs("h1",{children:[h?"Edit":"New"," Request"]})]}),e.jsx("main",{className:"flex-1 overflow-y-auto p-4",children:e.jsx(ne,{onSave:R,onCancel:s,sites:c,masterUniforms:d,initialData:h})})]})}return e.jsxs("div",{className:"h-full flex flex-col",children:[i&&e.jsx(M,{message:i.message,type:i.type,onDismiss:()=>t(null)}),e.jsx(J,{isOpen:!!z,onClose:()=>n(null),onConfirm:$,title:"Confirm Deletion",children:"Are you sure you want to delete this uniform request? This cannot be undone."}),e.jsxs("header",{className:"p-4 flex-shrink-0 flex items-center justify-between fo-mobile-header",children:[e.jsx("h1",{className:"text-lg font-semibold",children:"Uniform Requests"}),e.jsx("button",{onClick:p,"aria-label":"New Uniform Request",children:e.jsx(X,{className:"h-6 w-6"})})]}),e.jsx("main",{className:"flex-1 overflow-y-auto p-4 space-y-3",children:j.length>0?j.map(s=>e.jsxs("div",{className:"bg-[#243524] p-3 rounded-xl border border-[#374151]",children:[e.jsxs("div",{className:"flex justify-between items-start",children:[e.jsxs("div",{children:[e.jsx("p",{className:"font-semibold text-white",children:s.siteName}),e.jsx("p",{className:"text-xs text-gray-400",children:ae(new Date(s.requestedDate),"dd MMM, yyyy")})]}),e.jsx(ie,{status:s.status})]}),e.jsxs("div",{className:"mt-3 flex justify-between items-end",children:[e.jsxs("div",{className:"text-sm text-gray-300",children:[e.jsxs("p",{children:[s.gender," Uniforms"]}),e.jsxs("p",{className:"font-semibold",children:[G(s.items)," Items"]})]}),s.status==="Pending"&&e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(L,{variant:"icon",size:"sm",onClick:()=>b(s),children:e.jsx(Y,{className:"h-4 w-4 text-gray-400"})}),e.jsx(L,{variant:"icon",size:"sm",onClick:()=>n(s),children:e.jsx(Z,{className:"h-4 w-4 text-red-500"})})]})]})]},s.id)):e.jsxs("div",{className:"text-center text-muted pt-16",children:[e.jsx(ee,{className:"h-12 w-12 mx-auto mb-4"}),e.jsx("p",{children:"No uniform requests found."}),e.jsxs(L,{onClick:p,className:"mt-4",children:[e.jsx(se,{className:"mr-2 h-4 w-4"})," Create First Request"]})]})})]})};export{pe as default};
