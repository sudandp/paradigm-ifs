import{m as v,j as e,T as B,I as w,B as y,L as H}from"./index-D5q3SS3D.js";import{b as r}from"./react-vendor-BUaIliXj.js";import{A as X}from"./AdminPageHeader-wINx_pXe.js";import{P as J}from"./Pagination-DXf7cs0z.js";import{a2 as k,aj as K,aq as Q,ak as U,$,X as W}from"./ui-vendor-B8EvWqdc.js";import{f as P}from"./utils-vendor-DmorxLnX.js";import"./pdf-vendor-CB_F1AVu.js";import"./capacitor-vendor-CqiIOUn1.js";import"./supabase-7WG3J4rU.js";const Y=({status:a})=>{if(!a)return e.jsx("span",{className:"text-xs text-muted",children:"-"});const x={"Not Generated":"bg-slate-700 text-white dark:bg-slate-600 dark:text-slate-200",Generated:"bg-sky-100 text-sky-800 dark:bg-sky-500/20 dark:text-sky-300",Sent:"bg-amber-100 text-amber-800 dark:bg-amber-500/20 dark:text-amber-300",Paid:"bg-emerald-100 text-emerald-800 dark:bg-emerald-500/20 dark:text-emerald-300"};return e.jsx("span",{className:`px-2.5 py-0.5 inline-flex text-xs leading-5 font-semibold rounded-full ${x[a]}`,children:a})},Z=({invoiceData:a,discount:x,setDiscount:C,roundOff:b,setRoundOff:f})=>{const l=t=>new Intl.NumberFormat("en-IN",{minimumFractionDigits:2,maximumFractionDigits:2}).format(t),d=r.useMemo(()=>{if(!a)return null;const t=a.lineItems.reduce((j,u)=>{const p=u.deployment*u.ratePerMonth;return u.description.toLowerCase().includes("deduction")?j-p:j+p},0),n=t*.1,h=t+n-x,i=h*.09,m=h+i+i+b;return{subTotal:t,serviceCharge:n,grandTotal:h,gst:i,finalTotal:m}},[a,x,b]);return d?e.jsxs("div",{className:"p-4 bg-white text-black text-[10px] printable-area",children:[e.jsxs("div",{className:"grid grid-cols-2",children:[e.jsxs("div",{children:[e.jsxs("p",{children:["Name : ",a.siteName]}),e.jsxs("p",{children:["Address : ",a.siteAddress]}),e.jsxs("p",{children:["City : ",a.siteAddress.split(",").pop()?.trim()]})]}),e.jsxs("div",{className:"border border-black",children:[e.jsxs("div",{className:"grid grid-cols-2",children:[e.jsx("div",{className:"p-1 border-r border-b border-black",children:"Invoice No"}),e.jsx("div",{className:"p-1 border-b border-black",children:a.invoiceNumber})]}),e.jsxs("div",{className:"grid grid-cols-2",children:[e.jsx("div",{className:"p-1 border-r border-b border-black",children:"Date"}),e.jsx("div",{className:"p-1 border-b border-black",children:a.invoiceDate})]}),e.jsxs("div",{className:"grid grid-cols-2",children:[e.jsx("div",{className:"p-1 border-r border-b border-black",children:"Month"}),e.jsx("div",{className:"p-1 border-b border-black",children:a.statementMonth.split("-")[0]})]}),e.jsxs("div",{className:"grid grid-cols-2",children:[e.jsx("div",{className:"p-1 border-r border-black",children:"Due Date"}),e.jsx("div",{className:"p-1",children:"January 15, 2023"})]})]})]}),e.jsx("div",{className:"my-4 flex justify-center",children:e.jsx(H,{className:"h-10"})}),e.jsxs("h2",{className:"text-center font-bold text-sm underline mb-2",children:[a.siteName," Summary Statement for the month of ",a.statementMonth]}),e.jsxs("table",{className:"w-full border-collapse border border-black",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"font-bold bg-gray-200",children:[e.jsx("td",{className:"border p-1 border-black",children:"Sl.No"}),e.jsx("td",{className:"border p-1 border-black",children:"Description"}),e.jsx("td",{className:"border p-1 border-black",children:"Deployment"}),e.jsx("td",{className:"border p-1 border-black",children:"No of Days"}),e.jsx("td",{className:"border p-1 border-black",children:"Rate/Day"}),e.jsx("td",{className:"border p-1 border-black",children:"Rate/Month"}),e.jsx("td",{className:"border p-1 border-black",children:"Amount(Rs)"})]})}),e.jsxs("tbody",{children:[e.jsx("tr",{children:e.jsxs("td",{className:"border p-1 border-black font-bold",colSpan:7,children:["SERVICES (01/",P(new Date(a.statementMonth),"MM/yyyy")," to ",P(new Date(a.invoiceDate),"dd/MM/yyyy"),")"]})}),a.lineItems.map((t,n)=>{const h=t.deployment*t.ratePerMonth,i=t.description.toLowerCase().includes("deduction"),m=t.deployment===0;return e.jsxs("tr",{children:[e.jsx("td",{className:"border p-1 border-black text-center",children:n+1}),e.jsx("td",{className:`border p-1 border-black ${i?"text-red-600":""}`,children:t.description}),e.jsx("td",{className:"border p-1 border-black text-center",children:m?"-":t.deployment}),e.jsx("td",{className:"border p-1 border-black text-center",children:m?"-":t.noOfDays}),e.jsx("td",{className:"border p-1 border-black text-right",children:m?"-":l(t.ratePerDay)}),e.jsx("td",{className:"border p-1 border-black text-right",children:m?"-":l(t.ratePerMonth)}),e.jsx("td",{className:`border p-1 border-black text-right ${i?"text-red-600":""}`,children:l(h)})]},t.id)}),Array.from({length:Math.max(0,10-a.lineItems.length)}).map((t,n)=>e.jsx("tr",{children:e.jsx("td",{className:"border p-1 border-black h-6",colSpan:7})},`spacer-${n}`))]}),e.jsxs("tfoot",{children:[e.jsxs("tr",{children:[e.jsx("td",{colSpan:5,className:"border p-1 border-black font-bold",children:"Sub Total"}),e.jsx("td",{colSpan:2,className:"border p-1 border-black text-right font-bold",children:l(d.subTotal)})]}),e.jsxs("tr",{children:[e.jsx("td",{colSpan:5,className:"border p-1 border-black",children:"Admin,Overheads and Service Charges 10% on Sub Total"}),e.jsx("td",{colSpan:2,className:"border p-1 border-black text-right",children:l(d.serviceCharge)})]}),e.jsxs("tr",{className:"no-print",children:[e.jsx("td",{colSpan:5,className:"border p-1 border-black font-bold text-red-600",children:"Discount"}),e.jsx("td",{colSpan:2,className:"border p-1 border-black text-right",children:e.jsx(w,{type:"number",value:x,onChange:t=>C(parseFloat(t.target.value)||0),className:"text-right !p-1"})})]}),e.jsxs("tr",{children:[e.jsx("td",{colSpan:5,className:"border p-1 border-black font-bold",children:"Grand Total"}),e.jsx("td",{colSpan:2,className:"border p-1 border-black text-right font-bold",children:l(d.grandTotal)})]}),e.jsxs("tr",{children:[e.jsx("td",{colSpan:3,className:"border p-1 border-black",children:"Central GST"}),e.jsx("td",{colSpan:2,className:"border p-1 border-black text-center",children:"9.00%"}),e.jsx("td",{colSpan:2,className:"border p-1 border-black text-right",children:l(d.gst)})]}),e.jsxs("tr",{children:[e.jsx("td",{colSpan:3,className:"border p-1 border-black",children:"State GST"}),e.jsx("td",{colSpan:2,className:"border p-1 border-black text-center",children:"9.00%"}),e.jsx("td",{colSpan:2,className:"border p-1 border-black text-right",children:l(d.gst)})]}),e.jsxs("tr",{children:[e.jsx("td",{colSpan:5,className:"border p-1 border-black",children:"Round off"}),e.jsxs("td",{colSpan:2,className:"border p-1 border-black text-right",children:[e.jsx("span",{className:"print-only",children:l(b)}),e.jsx("span",{className:"no-print",children:e.jsx(w,{type:"number",step:"0.01",value:b,onChange:t=>f(parseFloat(t.target.value)||0),className:"text-right !p-1"})})]})]}),e.jsxs("tr",{className:"bg-gray-200 font-bold text-base",children:[e.jsx("td",{colSpan:5,className:"border p-2 border-black",children:"Payable for Services rendered"}),e.jsx("td",{colSpan:2,className:"border p-2 border-black text-right",children:l(d.finalTotal)})]})]})]})]}):null},oe=()=>{const[a,x]=r.useState([]),[C,b]=r.useState(!0),[f,l]=r.useState(!1),[d,t]=r.useState(P(new Date,"yyyy-MM")),[n,h]=r.useState({}),[i,m]=r.useState(0),[j,u]=r.useState(1),[p,L]=r.useState(20),[D,T]=r.useState(""),[c,S]=r.useState({isOpen:!1,site:null,invoiceData:null,isLoading:!1}),[_,F]=r.useState(0),[V,A]=r.useState(.2),[I,N]=r.useState(null),G=r.useRef(null),[M,R]=r.useState(!1);r.useEffect(()=>{b(!0),v.getOrganizations({page:j,pageSize:p}).then(s=>{x(s.data),m(s.total)}).catch(()=>N({message:"Failed to load sites.",type:"error"})).finally(()=>b(!1))},[j,p]),r.useEffect(()=>{u(1)},[p]);const O=r.useCallback(async s=>{l(!0);try{const o=new Date(s+"-02"),g=await v.getInvoiceStatuses(o);h(g)}catch{N({message:"Failed to fetch invoice statuses.",type:"error"})}finally{l(!1)}},[]);r.useEffect(()=>{d&&O(d)},[d,O]);const E=async s=>{S({isOpen:!0,site:s,invoiceData:null,isLoading:!0});try{const o=new Date(d+"-02"),g=await v.getInvoiceSummaryData(s.id,o);S({isOpen:!0,site:s,invoiceData:g,isLoading:!1})}catch{N({message:"Failed to fetch invoice data.",type:"error"}),S({isOpen:!1,site:null,invoiceData:null,isLoading:!1})}},q=async()=>{const s=G.current;if(!s||!c.invoiceData){N({message:"Could not find invoice to export.",type:"error"});return}R(!0);try{const o=s.outerHTML,g={margin:.25,filename:`Invoice_${c.invoiceData.siteName.replace(" ","_")}_${c.invoiceData.statementMonth}.pdf`,image:{type:"jpeg",quality:.98},html2canvas:{scale:2,useCORS:!0},jsPDF:{unit:"in",format:"a4",orientation:"portrait"}};await v.generatePdf(o,g)}catch(o){console.error("PDF generation failed:",o),N({message:"Failed to generate PDF.",type:"error"})}finally{R(!1)}},z=()=>{S({isOpen:!1,site:null,invoiceData:null,isLoading:!1}),F(0),A(.2)};return C?e.jsx("div",{className:"flex justify-center items-center h-64",children:e.jsx(k,{className:"h-8 w-8 animate-spin text-accent"})}):e.jsxs("div",{className:"p-4 md:p-0",children:[I&&e.jsx(B,{message:I.message,type:I.type,onDismiss:()=>N(null)}),e.jsxs("div",{className:"border-0 shadow-none md:bg-card md:p-6 md:rounded-xl md:shadow-card",children:[e.jsx(X,{title:"Invoice Summary"}),e.jsxs("div",{className:"space-y-6",children:[e.jsx("div",{className:"flex flex-col md:flex-row justify-between md:items-center gap-4",children:e.jsxs("div",{className:"flex-grow flex flex-col md:flex-row gap-4 items-end",children:[e.jsx("div",{className:"flex-grow",children:e.jsx(w,{placeholder:"Search by site name...",value:D,onChange:s=>T(s.target.value),icon:e.jsx(K,{className:"h-4 w-4"})})}),e.jsx("div",{className:"w-full md:w-56",children:e.jsx(w,{label:"",id:"month-select",type:"month",value:d,onChange:s=>t(s.target.value)})}),e.jsx(y,{variant:"secondary",onClick:()=>T(""),disabled:!D,children:e.jsx(Q,{className:"h-4 w-4"})})]})}),e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"min-w-full text-sm responsive-table",children:[e.jsx("thead",{className:"bg-page",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-4 py-3 text-left font-medium text-muted",children:"Site Name"}),e.jsx("th",{className:"px-4 py-3 text-left font-medium text-muted",children:"Invoice Status"}),e.jsx("th",{className:"px-4 py-3 text-left font-medium text-muted",children:"Actions"})]})}),e.jsx("tbody",{className:"divide-y divide-border md:bg-card md:divide-y-0",children:a.filter(s=>s.shortName.toLowerCase().includes(D.toLowerCase())).map(s=>e.jsxs("tr",{children:[e.jsx("td",{"data-label":"Site Name",className:"px-4 py-3 font-medium",children:s.shortName}),e.jsx("td",{"data-label":"Status",className:"px-4 py-3",children:f?e.jsx(k,{className:"h-4 w-4 animate-spin"}):e.jsx(Y,{status:n[s.id]})}),e.jsx("td",{"data-label":"Actions",className:"px-4 py-3",children:e.jsxs("div",{className:"flex items-center gap-2 justify-end md:justify-start",children:[e.jsx(y,{variant:"icon",size:"sm",onClick:()=>E(s),disabled:n[s.id]==="Not Generated"||f,title:"View Invoice",children:e.jsx(U,{className:"h-4 w-4"})}),e.jsx(y,{variant:"icon",size:"sm",onClick:()=>E(s),disabled:n[s.id]==="Not Generated"||f,title:"Download Invoice",children:e.jsx($,{className:"h-4 w-4"})})]})})]},s.id))})]})}),e.jsx(J,{currentPage:j,totalItems:i,pageSize:p,onPageChange:u,onPageSizeChange:L,className:"mt-6"})]})]}),c.isOpen&&e.jsx("div",{className:"fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-60 p-4",onClick:z,children:e.jsxs("div",{className:"bg-card rounded-xl shadow-card w-full max-w-4xl m-4 animate-fade-in-scale flex flex-col",onClick:s=>s.stopPropagation(),children:[e.jsxs("div",{className:"p-4 border-b flex justify-between items-center no-print",children:[e.jsxs("h3",{className:"text-lg font-bold text-primary-text",children:["Invoice for ",c.site?.shortName]}),e.jsx(y,{variant:"icon",onClick:z,children:e.jsx(W,{className:"h-5 w-5"})})]}),e.jsx("div",{className:"flex-grow overflow-y-auto p-4 max-h-[70vh]",children:c.isLoading?e.jsx("div",{className:"flex justify-center items-center h-64",children:e.jsx(k,{className:"h-8 w-8 animate-spin text-accent"})}):c.invoiceData?e.jsx("div",{ref:G,children:e.jsx(Z,{invoiceData:c.invoiceData,discount:_,setDiscount:F,roundOff:V,setRoundOff:A})}):e.jsx("p",{className:"text-center text-muted",children:"No data to display."})}),e.jsx("div",{className:"p-4 border-t flex justify-end no-print",children:e.jsxs(y,{onClick:q,disabled:!c.invoiceData||M,children:[M?e.jsx(k,{className:"mr-2 h-4 w-4 animate-spin"}):e.jsx($,{className:"mr-2 h-4 w-4"}),M?"Generating...":"Download PDF"]})})]})})]})};export{oe as default};
