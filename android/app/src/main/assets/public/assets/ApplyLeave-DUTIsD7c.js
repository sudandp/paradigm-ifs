import{k as te,U as oe,j as e,u as ie,n as ce,d as de,c as ue,o as pe,T as me,B as K,C as L,S as xe,e as O,m as U}from"./index-D5q3SS3D.js";import{b as h,j as se,u as re,k as fe,R as _}from"./react-vendor-BUaIliXj.js";import{S as Z}from"./Select-Dz12MdxG.js";import{D as ee}from"./DatePicker-D2ulOwJx.js";import{i as ae,j as he,f as be,R as ye}from"./ui-vendor-B8EvWqdc.js";import{p as k,c as ge,h as ve,A as we,B as je,b as ke,f,D as Se,i as Q,r as G,E as V,k as Ne,s as v,z as De,y as Me,a as Y}from"./utils-vendor-DmorxLnX.js";import{U as Te}from"./UploadDocument-BAL6UInC.js";import"./pdf-vendor-CB_F1AVu.js";import"./capacitor-vendor-CqiIOUn1.js";import"./supabase-7WG3J4rU.js";import"./CameraCaptureModal-DQDGRnEP.js";const Ce=({label:d,id:n,error:l,startDate:i,endDate:o,onChange:S,maxDate:N,minDate:D,className:y})=>{const[g,z]=h.useState(!1),c=te("(max-width: 767px)"),B=h.useRef(null),{theme:M}=oe(),[$,T]=se(),x=re(),[s,p]=h.useState(i?k(i):null),[r,w]=h.useState(o?k(o):null),[C,E]=h.useState(s||new Date),R=c&&$.get("picker")===n,q=c?R:g;h.useEffect(()=>{q&&(p(i?k(i):null),w(o?k(o):null),E(i?k(i):new Date))},[q,i,o]);const a=()=>{c&&R?x(-1):z(!1)},u=()=>{if(c){const t=new URLSearchParams($);t.set("picker",n),T(t)}else z(!0)},P=t=>{D&&V(v(t),v(D))||N&&G(v(t),v(N))||(!s||s&&r?(p(t),w(null)):V(t,s)?p(t):w(t))},m=()=>{s&&r&&(S(f(s,"yyyy-MM-dd"),f(r,"yyyy-MM-dd")),a())},j=t=>{E(b=>t==="next"?De(b,1):Me(b))},I=h.useMemo(()=>{const t=ge(C),b=ve(t),W=we(t),A=je(b);return ke({start:W,end:A})},[C]),H=["Sun","Mon","Tue","Wed","Thu","Fri","Sat"],F=e.jsxs("div",{className:c?"date-picker-screen animate-slide-up isolate":"absolute mt-2 left-0 z-[70] rounded-2xl shadow-2xl border border-emerald-900/30 w-[320px] bg-[#041b0f] p-4 text-white animate-fade-in-scale",children:[c&&e.jsxs("header",{className:"flex items-center p-4 border-b border-white/10 bg-[#041b0f] sticky top-0 z-10 flex-shrink-0",children:[e.jsx("button",{onClick:a,className:"date-picker-btn p-3 -ml-2 bg-emerald-500/20 text-emerald-400 rounded-xl",children:e.jsx(ae,{className:"h-6 w-6"})}),e.jsx("h2",{className:"ml-4 text-xl font-bold text-white tracking-tight",children:"Select Date Range"})]}),e.jsxs("div",{className:c?"flex-1 flex flex-col justify-between overflow-hidden":"",children:[e.jsxs("div",{className:c?"flex-1 flex flex-col justify-center max-w-lg mx-auto w-full px-6":"",children:[e.jsxs("div",{className:`flex items-center justify-between px-1 flex-shrink-0 ${c?"mb-8":"mb-6 pt-2"}`,children:[e.jsx("button",{onClick:()=>j("prev"),className:"date-picker-btn p-3 rounded-2xl bg-emerald-500/10 text-emerald-400 scale-110",children:e.jsx(ae,{className:c?"h-7 w-7":"h-5 w-5"})}),e.jsx("div",{className:c?"text-2xl font-black uppercase tracking-[0.15em] text-emerald-50":"text-base font-bold text-white",children:f(C,"MMMM yyyy")}),e.jsx("button",{onClick:()=>j("next"),className:"date-picker-btn p-3 rounded-2xl bg-emerald-500/10 text-emerald-400 scale-110",children:e.jsx(he,{className:c?"h-7 w-7":"h-5 w-5"})})]}),e.jsx("div",{className:"grid grid-cols-7 w-full mb-4 flex-shrink-0",children:H.map(t=>e.jsx("div",{className:"text-center text-[10px] font-black uppercase tracking-[0.3em] text-emerald-500/40",children:t},t))}),e.jsx("div",{className:"grid grid-cols-7 w-full gap-1 flex-shrink-0",children:I.map((t,b)=>{const W=Se(t,C),A=s&&Q(t,s),J=r&&Q(t,r),ne=s&&r&&G(t,s)&&V(t,r),le=Ne(t),X=D&&V(v(t),v(D))||N&&G(v(t),v(N));return e.jsx("button",{type:"button",onClick:()=>P(t),disabled:X,className:`
                    date-picker-btn relative aspect-square text-sm font-bold transition-all duration-200
                    ${W?"text-white":"text-white/5 opacity-20"}
                    ${X?"opacity-5 cursor-not-allowed scale-90":"hover:bg-emerald-500/10"}
                    ${A||J?"!bg-emerald-500 !text-white z-10 rounded-full":""}
                    ${ne?"bg-emerald-500/20 text-emerald-300":""}
                    ${le&&!A&&!J?"ring-1 ring-emerald-500/30":""}
                  `,children:f(t,"d")},b)})})]}),c&&e.jsx("div",{className:"p-10 pb-[40vh] flex justify-end flex-shrink-0 mt-8 mb-auto",children:e.jsxs("div",{className:`p-6 bg-white/5 backdrop-blur-2xl rounded-[2.5rem] border border-white/10 flex flex-col items-center gap-4 transition-all duration-500 ${s?"translate-y-0 opacity-100":"translate-y-8 opacity-0"}`,children:[e.jsxs("div",{className:"text-center space-y-1",children:[e.jsx("span",{className:"block text-[10px] font-black uppercase tracking-[0.2em] text-white/30",children:"Active Selection"}),e.jsxs("span",{className:"block text-lg font-bold text-emerald-400 tabular-nums",children:[s?f(s,"dd MMM"):"â€”",r?` - ${f(r,"dd MMM, yyyy")}`:" - Select end"]})]}),e.jsx("button",{onClick:m,disabled:!s||!r,className:`date-picker-btn bg-emerald-500 text-white px-8 py-3 text-sm font-black uppercase tracking-widest rounded-2xl shadow-xl shadow-emerald-500/20 active:scale-95 ${!s||!r?"opacity-30":""}`,children:"Done"})]})})]})]});return e.jsxs("div",{ref:B,className:"w-full",children:[d&&e.jsx("label",{className:"block text-xs font-semibold mb-1.5 uppercase tracking-wider text-emerald-500/60",children:d}),e.jsxs("div",{className:"relative",children:[e.jsxs("div",{className:`fo-input flex justify-between items-center cursor-pointer ${y||""}`,onClick:u,children:[e.jsx("span",{className:i?"text-white":"text-white/30",children:i?`${f(k(i),"dd MMM")} - ${o?f(k(o),"dd MMM, yyyy"):"..."}`:"Select date range"}),e.jsx(be,{className:"h-4 w-4 text-emerald-500/50"})]}),q&&(c?fe.createPortal(F,document.body):F)]}),l&&e.jsx("p",{className:"mt-1.5 text-[10px] font-medium text-red-500 tracking-wide",children:l})]})},qe=d=>de({leaveType:O().oneOf(["Earned","Sick","Floating","Comp Off","Loss of Pay"]).required("Leave type is required"),startDate:O().required("Start date is required"),endDate:O().required("End date is required").test("is-after-start","End date must be on or after start date",function(n){const{startDate:l}=this.parent;return!l||!n?!0:new Date(n.replace(/-/g,"/"))>=new Date(l.replace(/-/g,"/"))}),reason:O().required("A reason for the leave is required").min(10,"Please provide a more detailed reason."),dayOption:O().oneOf(["full","half"]).optional(),doctorCertificate:xe().when(["leaveType","startDate","endDate"],{is:(n,l,i)=>n!=="Sick"||!l||!i?!1:Y(new Date(i.replace(/-/g,"/")),new Date(l.replace(/-/g,"/")))+1>d,then:n=>n.required(`A doctor's certificate is required for sick leave longer than ${d} days.`),otherwise:n=>n.nullable().optional()})}),ze=()=>{const{user:d}=ie(),n=re(),l=te("(max-width: 767px)"),[i,o]=_.useState(null),{attendance:{office:{sickLeaveCertificateThreshold:S}}}=ce(),N=h.useMemo(()=>qe(S),[S]),[D]=se(),y=D.get("edit"),g=!!y,[z,c]=_.useState(g),{register:B,control:M,handleSubmit:$,watch:T,setValue:x,formState:{errors:s}}=ue({resolver:pe(N),defaultValues:{leaveType:"Earned",startDate:f(new Date,"yyyy-MM-dd"),endDate:f(new Date,"yyyy-MM-dd"),dayOption:"full"}}),p=T("startDate"),r=T("endDate"),w=T("leaveType"),E=h.useMemo(()=>!p||!r?!1:Q(new Date(p.replace(/-/g,"/")),new Date(r.replace(/-/g,"/"))),[p,r])&&w==="Earned",R=h.useMemo(()=>w!=="Sick"||!p||!r?!1:Y(new Date(r.replace(/-/g,"/")),new Date(p.replace(/-/g,"/")))+1>S,[w,p,r,S]);_.useEffect(()=>{(async()=>{if(!(!y||!d))try{const m=((await U.getLeaveRequests({userId:d.id})).data||[]).find(j=>j.id===y);if(m){if(m.status!=="pending_manager_approval"){o({message:"Only pending requests can be edited.",type:"error"}),setTimeout(()=>n("/leaves/dashboard"),1500);return}x("leaveType",m.leaveType),x("startDate",m.startDate),x("endDate",m.endDate),x("reason",m.reason),x("dayOption",m.dayOption)}else o({message:"Request not found.",type:"error"}),n("/leaves/dashboard")}catch{o({message:"Failed to load request details.",type:"error"})}finally{c(!1)}})()},[y,d,x,n]);const q=async a=>{if(d)try{if(!g&&a.leaveType!=="Loss of Pay"){const u=await U.getLeaveBalancesForUser(d.id),P=new Date(a.startDate.replace(/-/g,"/")),m=new Date(a.endDate.replace(/-/g,"/")),j=a.dayOption==="half"?.5:Y(m,P)+1,I=`${a.leaveType.toLowerCase()}Total`.replace("earnedtotal","earnedTotal").replace("sicktotal","sickTotal").replace("floatingtotal","floatingTotal").replace("compofftotal","compOffTotal"),H=I.replace("Total","Used"),F=a.leaveType.toLowerCase().replace(" ","");if(u.expiryStates&&u.expiryStates[F]){o({message:`The ${a.leaveType} allocation has expired and is no longer available for use.`,type:"error"});return}const b=u[I]-u[H];if(b<j){o({message:`Insufficient ${a.leaveType} balance. You have ${b} days available, but requested ${j} days.`,type:"error"});return}}g&&y?(await U.updateLeaveRequest(y,a),o({message:"Leave request updated successfully!",type:"success"})):(await U.submitLeaveRequest({...a,userId:d.id,userName:d.name}),o({message:"Leave request submitted successfully!",type:"success"})),setTimeout(()=>n("/leaves/dashboard"),1500)}catch{o({message:g?"Failed to update leave request.":"Failed to submit leave request.",type:"error"})}};return d?e.jsxs("div",{className:`min-h-screen bg-page ${l?"pb-20":"p-6"}`,children:[i&&e.jsx(me,{message:i.message,type:i.type,onDismiss:()=>o(null)}),e.jsxs("div",{className:"w-full bg-card rounded-2xl shadow-card overflow-hidden",children:[e.jsxs("header",{className:`p-4 flex items-center gap-4 ${l?"fixed top-0 left-0 right-0 z-50 bg-[#041b0f] border-b border-[#1f3d2b]":"border-b"}`,style:l?{paddingTop:"calc(1rem + env(safe-area-inset-top))"}:{},children:[e.jsx(K,{variant:"icon",onClick:()=>n(-1),"aria-label":"Go back",children:e.jsx(ye,{className:"h-6 w-6"})}),e.jsx("h1",{className:"text-xl font-bold text-primary-text",children:g?"Edit Leave Request":"Apply for Leave"})]}),e.jsx("div",{className:`${l?"px-4":"p-6"}`,style:l?{paddingTop:"calc(5rem + env(safe-area-inset-top))"}:{},children:e.jsxs("form",{id:"leave-form",onSubmit:$(q),className:"space-y-6",children:[e.jsxs("div",{className:"bg-card/50 p-4 rounded-xl border border-border space-y-4",children:[e.jsx(L,{name:"leaveType",control:M,render:({field:a})=>e.jsxs(Z,{label:"Leave Type",...a,error:s.leaveType?.message,className:l?"pro-select pro-select-arrow":"",children:[e.jsx("option",{value:"Earned",children:"Earned"}),e.jsx("option",{value:"Sick",children:"Sick"}),e.jsx("option",{value:"Floating",children:"Floating Holiday"}),e.jsx("option",{value:"Comp Off",children:"Comp Off"}),e.jsx("option",{value:"Loss of Pay",children:"Loss of Pay"})]})}),l?e.jsx(Ce,{label:"Select Dates",id:"leaveRange",startDate:p,endDate:r,onChange:(a,u)=>{a&&x("startDate",a,{shouldValidate:!0}),u&&x("endDate",u,{shouldValidate:!0})},error:s.startDate?.message||s.endDate?.message}):e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsx(L,{name:"startDate",control:M,render:({field:a})=>e.jsx(ee,{label:"Start Date",id:"startDate",value:a.value,onChange:a.onChange,error:s.startDate?.message})}),e.jsx(L,{name:"endDate",control:M,render:({field:a})=>e.jsx(ee,{label:"End Date",id:"endDate",value:a.value,onChange:a.onChange,error:s.endDate?.message})})]}),E&&e.jsx(L,{name:"dayOption",control:M,render:({field:a})=>e.jsxs(Z,{label:"Day Option",...a,className:l?"pro-select pro-select-arrow":"",children:[e.jsx("option",{value:"full",children:"Full Day"}),e.jsx("option",{value:"half",children:"Half Day"})]})})]}),e.jsxs("div",{className:"bg-card/50 p-4 rounded-xl border border-border",children:[e.jsx("label",{className:"block text-sm font-medium text-muted mb-2",children:"Reason for Leave"}),e.jsx("textarea",{...B("reason"),rows:4,placeholder:"Please provide details about your leave request...",className:`w-full p-4 rounded-xl bg-page border border-border text-primary-text focus:ring-2 focus:ring-accent outline-none transition-all ${s.reason?"border-red-500":""}`}),s.reason&&e.jsx("p",{className:"mt-2 text-xs text-red-500",children:s.reason.message})]}),R&&e.jsx("div",{className:"bg-card/50 p-4 rounded-xl border border-border",children:e.jsx(L,{name:"doctorCertificate",control:M,render:({field:a,fieldState:u})=>e.jsx(Te,{label:"Doctor's Certificate (Required)",file:a.value,onFileChange:a.onChange,error:u.error?.message,allowCapture:!0})})}),e.jsxs("div",{className:`flex items-center gap-4 ${l?"fixed bottom-20 left-4 right-4":"pt-4"}`,children:[e.jsx(K,{type:"button",variant:"secondary",onClick:()=>n(-1),className:"flex-1",children:"Cancel"}),e.jsx(K,{type:"submit",form:"leave-form",className:"flex-2",children:g?"Update Request":"Submit Request"})]})]})})]})]}):null};export{ze as default};
