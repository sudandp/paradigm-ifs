import{j as e,I as K,B as L,u as Q,a as Z,z as ee,T as se,i as R,m as b}from"./index-D5q3SS3D.js";import{b as n,u as ae}from"./react-vendor-BUaIliXj.js";import{A as te}from"./AdminPageHeader-wINx_pXe.js";import{M as ne}from"./Modal-CR2aBU6L.js";import{T as z}from"./TableSkeleton-Bf5l1KHK.js";import{ao as ie,A as oe,bi as re,as as le,at as de,g as ce,X as me}from"./ui-vendor-B8EvWqdc.js";import"./pdf-vendor-CB_F1AVu.js";import"./capacitor-vendor-CqiIOUn1.js";import"./utils-vendor-DmorxLnX.js";import"./supabase-7WG3J4rU.js";import"./Skeleton-D0WWmlnq.js";const pe=({isOpen:g,onClose:u,onSave:w,title:S,initialName:v=""})=>{const[k,N]=n.useState(v),[o,x]=n.useState("");n.useEffect(()=>{g&&(N(v),x(""))},[g,v]);const _=()=>{if(!k.trim()){x("Role name cannot be empty.");return}w(k.trim()),u()};return g?e.jsx("div",{className:"fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50",onClick:u,children:e.jsx("div",{className:"bg-card rounded-xl shadow-card p-6 w-full max-w-sm m-4 animate-fade-in-scale",onClick:h=>h.stopPropagation(),children:e.jsxs("form",{onSubmit:h=>{h.preventDefault(),_()},children:[e.jsx("h3",{className:"text-lg font-bold text-primary-text mb-4",children:S}),e.jsx(K,{label:"Role Display Name",id:"role-name",value:k,onChange:h=>N(h.target.value),error:o,autoFocus:!0}),e.jsxs("div",{className:"mt-6 flex justify-end space-x-3",children:[e.jsx(L,{type:"button",onClick:u,variant:"secondary",children:"Cancel"}),e.jsx(L,{type:"submit",children:"Save"})]})]})})}):null},F=[{key:"apply_for_leave",name:"Apply for Leave",description:"Allows users to request time off."},{key:"create_enrollment",name:"Create Enrollment",description:"Access the multi-step form to onboard new employees."},{key:"view_developer_settings",name:"Developer Settings",description:"Access API settings and other developer tools."},{key:"download_attendance_report",name:"Download Attendance Report",description:"Generate and download attendance reports in CSV format."},{key:"manage_approval_workflow",name:"Manage Approval Workflow",description:"Set up reporting managers for leave approvals."},{key:"manage_attendance_rules",name:"Manage Attendance Rules",description:"Set work hours, holidays, and leave allocations."},{key:"manage_enrollment_rules",name:"Manage Enrollment Rules",description:"Set rules for ESI/GMC, manpower limits, and documents."},{key:"manage_insurance",name:"Manage Insurance",description:"Create and manage company insurance plans."},{key:"manage_leave_requests",name:"Manage Leave Requests",description:"Approve or reject leave requests for employees."},{key:"manage_modules",name:"Manage Modules",description:"Create, edit, and group permissions into modules."},{key:"manage_policies",name:"Manage Policies",description:"Create and manage company policies."},{key:"manage_roles_and_permissions",name:"Manage Roles & Permissions",description:"Access this page to edit role permissions."},{key:"manage_sites",name:"Manage Sites",description:"Create, edit, and delete organizations/sites."},{key:"manage_tasks",name:"Manage Tasks",description:"Create, assign, and manage all organizational tasks, including escalations."},{key:"manage_uniforms",name:"Manage Uniforms",description:"Manage uniform requests and site configurations."},{key:"manage_users",name:"Manage Users",description:"Create, edit, and delete user accounts."},{key:"view_operations_dashboard",name:"Operations Dashboard",description:"View the operations management dashboard."},{key:"view_site_dashboard",name:"Site Dashboard",description:"View the dashboard for a specific site/organization."},{key:"view_all_attendance",name:"View All Attendance",description:"Allows users to see attendance records for all employees."},{key:"view_all_submissions",name:"View All Submissions",description:"Access the main dashboard to view all employee submissions."},{key:"view_entity_management",name:"View Entity Management",description:"Access the HR dashboard for managing company entities."},{key:"view_field_staff_tracking",name:"View Field Staff Tracking",description:"Track user check-in/out locations and activity on a map."},{key:"view_invoice_summary",name:"View Invoice Summary",description:"View and generate monthly invoices for sites."},{key:"view_own_attendance",name:"View Own Attendance",description:"Allows users to see their own attendance records."},{key:"view_verification_costing",name:"View Verification Costing",description:"Analyze costs associated with third-party document verifications."},{key:"view_my_team",name:"View My Team",description:"Access the My Team page to view detailed team metrics."},{key:"view_field_reports",name:"View Field Reports",description:"Access and review daily reports submitted by field staff."},{key:"manage_biometric_devices",name:"Manage Biometric Devices",description:"Add, monitor, and remove biometric devices."},{key:"manage_geo_locations",name:"Manage Geo Locations",description:"Create and manage geofenced locations for attendance."},{key:"view_my_locations",name:"View My Locations",description:"View assigned geofenced locations for personal attendance."},{key:"view_profile",name:"View Profile",description:"Access personal profile and settings."},{key:"access_support_desk",name:"Access Support Desk",description:"Allows users to access the backend support and ticketing system."},{key:"view_mobile_nav_home",name:"Mobile Nav: Home",description:"Show Home tab in mobile navigation."},{key:"view_mobile_nav_attendance",name:"Mobile Nav: Attendance",description:"Show Attendance tab in mobile navigation."},{key:"view_mobile_nav_tasks",name:"Mobile Nav: Tasks",description:"Show Tasks tab in mobile navigation."},{key:"view_mobile_nav_profile",name:"Mobile Nav: Profile",description:"Show Profile tab in mobile navigation."},{key:"manage_finance_settings",name:"Manage Finance Settings",description:"Control over global finance configurations."},{key:"view_finance_reports",name:"View Finance Reports",description:"Access to consolidated financial reports."},{key:"view_attendance_tracker",name:"View Site Attendance Tracker",description:"Monitor and track site-level attendance records."}].sort((g,u)=>g.name.localeCompare(u.name)),Ne=()=>{const{user:g}=Q(),u=ae(),{permissions:w,setRolePermissions:S,addRolePermissionEntry:v,removeRolePermissionEntry:k,renameRolePermissionEntry:N}=Z(),[o,x]=n.useState([]),[_,h]=n.useState([]),[O,E]=n.useState(!0),[C,m]=n.useState(null),[I,q]=n.useState(!1),[U,A]=n.useState(!1),[l,B]=n.useState(null),[P,ue]=n.useState(!1),[V,M]=n.useState(null),D=n.useRef(null),{isMobile:j,isTablet:d}=ee();n.useEffect(()=>{(async()=>{E(!0);try{const[a,i]=await Promise.all([b.getRoles(),b.getModules()]),t=["bd","management","admin","developer","hr","operation_manager","finance","field_staff","site_manager","unverified"],p=a.sort((r,c)=>{const f=t.indexOf(r.id.toLowerCase()),y=t.indexOf(c.id.toLowerCase());return f!==-1&&y!==-1?f-y:f!==-1?-1:y!==-1?1:r.displayName.localeCompare(c.displayName)});x(p),h(i.sort((r,c)=>r.name.localeCompare(c.name)))}catch(a){console.error("Failed to load data",a),m({message:"Failed to load page data.",type:"error"})}finally{E(!1)}})()},[]),n.useEffect(()=>{const s=a=>{D.current&&!D.current.contains(a.target)&&M(null)};return document.addEventListener("mousedown",s),()=>document.removeEventListener("mousedown",s)},[]);const H=async(s,a,i)=>{const t=w[s]||[],p=i?[...t,a]:t.filter(r=>r!==a);S(s,p);try{const r=o.map(c=>c.id===s?{...c,permissions:p}:c);await b.saveRoles(r)}catch(r){console.error("Failed to sync permissions with database:",r),m({message:"Failed to save permissions. Please try again.",type:"error"})}},G=async s=>{const a=s.toLowerCase().replace(/\s+/g,"_");if(P&&l){if(R(l.id)){m({message:"The Admin role cannot be renamed.",type:"error"});return}if(o.some(t=>t.id===a&&t.id!==l.id)){m({message:`A role with ID '${a}' already exists.`,type:"error"});return}const i=o.map(t=>t.id===l.id?{...t,displayName:s,id:a}:t);await b.saveRoles(i),x(i),N(l.id,a),m({message:"Role renamed.",type:"success"})}else{if(o.some(p=>p.id===a)){m({message:`A role with ID '${a}' already exists.`,type:"error"});return}const i={id:a,displayName:s},t=[...o,i];await b.saveRoles(t),x(t),v(i),m({message:"Role added successfully.",type:"success"})}},W=async()=>{if(!l||R(l.id)){m({message:"This role cannot be deleted.",type:"error"}),A(!1);return}const s=o.filter(a=>a.id!==l.id);await b.saveRoles(s),x(s),k(l.id),m({message:`Role '${l.displayName}' deleted.`,type:"success"}),A(!1)},X=n.useMemo(()=>new Map(F.map(s=>[s.key,s])),[]),$=n.useMemo(()=>{const s=new Set(_.flatMap(a=>a.permissions));return F.filter(a=>!s.has(a.key))},[_]),T=s=>e.jsxs("tr",{children:[e.jsx("td",{"data-label":"Permission",className:`px-4 py-4 ${j?"":`sticky left-0 bg-page z-20 border-r border-border shadow-[2px_0_5px_rgba(0,0,0,0.05)] ${d?"min-w-[160px]":""}`}`,children:e.jsxs("div",{className:"flex flex-col items-end text-right md:items-start md:text-left",children:[e.jsx("div",{className:`font-semibold text-primary-text break-words leading-tight ${d?"text-xs":"text-sm"}`,children:s.name}),!d&&e.jsx("div",{className:"text-xs text-muted",children:s.description})]})}),o.map(a=>{const i=R(a.id)&&a.id.toLowerCase()!=="developer",t=g?.role===a.id,p=s.key==="manage_roles_and_permissions",r=s.key.startsWith("view_mobile_nav_"),c=i?r?w[a.id]?.includes(s.key)??!1:!0:w[a.id]?.includes(s.key)??!1,f=i&&!r,y=f||t&&p,Y=f?"Admin role has all permissions by default and cannot be changed.":t&&p?"You cannot disable your own access to Role Management.":"";return e.jsx("td",{"data-label":a.displayName,className:`${d?"px-2 py-3 min-w-[96px]":"px-4 py-4"} text-center align-middle`,children:e.jsx("div",{className:"flex justify-center",children:e.jsxs("label",{className:`relative flex items-center justify-center w-5 h-5 ${y?"cursor-not-allowed":"cursor-pointer"}`,children:[e.jsx("input",{type:"checkbox",className:"sr-only peer",checked:c,onChange:J=>H(a.id,s.key,J.target.checked),disabled:y,title:Y}),e.jsx("span",{className:`w-5 h-5 bg-white border border-gray-300 rounded flex items-center justify-center peer-focus-visible:ring-2 peer-focus-visible:ring-offset-2 peer-focus-visible:ring-accent-dark peer-checked:border-accent ${y?"opacity-50":""}`,children:c?e.jsx(ce,{className:"w-4 h-4 text-accent"}):e.jsx(me,{className:"w-4 h-4 text-red-500"})})]})})},a.id)})]},s.key);return e.jsxs("div",{className:`${d?"p-2":"p-4"} border-0 shadow-none md:bg-card md:p-6 md:rounded-xl md:shadow-card`,children:[C&&e.jsx(se,{message:C.message,type:C.type,onDismiss:()=>m(null)}),e.jsx(pe,{isOpen:I,onClose:()=>q(!1),onSave:G,title:P?"Rename Role":"Add New Role",initialName:P?l?.displayName:""}),e.jsxs(ne,{isOpen:U,onClose:()=>A(!1),onConfirm:W,title:"Confirm Deletion",children:['Are you sure you want to delete the role "',l?.displayName,'"? This action cannot be undone.']}),e.jsx(te,{title:"Role & Permission Management",children:e.jsxs("button",{onClick:()=>u("/admin/roles/add"),className:"btn btn-primary btn-md",children:[e.jsx(ie,{className:"mr-2 h-4 w-4"})," Add Role"]})}),e.jsx("p",{className:"text-muted text-sm -mt-4 mb-6",children:"Assign permissions to user roles. Changes are saved automatically."}),e.jsx("div",{className:`mb-6 p-4 bg-accent/5 dark:bg-accent/10 border border-accent/20 rounded-xl ${d?"p-2":""}`,children:e.jsxs("div",{className:"flex gap-3 items-start md:items-center",children:[e.jsx(oe,{className:`h-5 w-5 text-accent flex-shrink-0 ${d?"h-4 w-4":""} mt-0.5 md:mt-0`}),e.jsxs("div",{className:"text-sm",children:[e.jsx("p",{className:`font-semibold text-primary-text ${d?"text-xs":""}`,children:"Full Admin Access Enabled"}),!d&&e.jsxs("p",{className:"text-muted leading-relaxed",children:["Users with the ",e.jsx("strong",{children:"Admin"})," or ",e.jsx("strong",{children:"Super Admin"})," role automatically have access to all features and pages in the system. These permissions are locked for security and cannot be disabled."]})]})]})}),e.jsx("div",{className:`overflow-x-auto ${d?"hide-scrollbar":""}`,children:e.jsxs("table",{className:"min-w-full text-sm responsive-table border-separate border-spacing-0",children:[e.jsx("thead",{className:"bg-page",children:e.jsxs("tr",{children:[e.jsx("th",{scope:"col",className:`px-4 py-3 text-left font-bold text-primary-text ${j?"":`sticky left-0 bg-page z-30 border-r border-border shadow-[2px_0_5px_rgba(0,0,0,0.05)] ${d?"min-w-[160px]":""}`}`,children:"Permission"}),o.map(s=>e.jsx("th",{scope:"col",className:`py-3 text-center font-bold text-primary-text ${d?"px-2 w-24 min-w-[96px] text-[10px]":"px-4 w-40 text-sm"}`,children:e.jsxs("div",{className:"flex flex-col items-center justify-center gap-1",children:[e.jsx("span",{className:"leading-tight break-words whitespace-normal max-w-full",children:s.displayName}),!R(s.id)&&e.jsxs("div",{className:"relative",children:[e.jsx("button",{onClick:()=>M(s.id===V?null:s.id),children:e.jsx(re,{className:"h-4 w-4 text-muted"})}),V===s.id&&e.jsxs("div",{ref:D,className:"absolute right-0 mt-2 w-32 bg-card border rounded-md shadow-lg z-30",children:[e.jsxs("button",{onClick:()=>{u(`/admin/roles/edit/${s.id}`),M(null)},className:"w-full text-left px-3 py-2 text-sm hover:bg-page flex items-center",children:[e.jsx(le,{className:"mr-2 h-4 w-4"}),"Edit"]}),e.jsxs("button",{onClick:()=>{B(s),A(!0),M(null)},className:"w-full text-left px-3 py-2 text-sm hover:bg-page flex items-center text-red-600",children:[e.jsx(de,{className:"mr-2 h-4 w-4"}),"Delete"]})]})]})]})},s.id))]})}),O?e.jsx("tbody",{children:j?e.jsx("tr",{children:e.jsx("td",{colSpan:o.length+1||2,children:e.jsx(z,{rows:3,cols:2,isMobile:!0})})}):e.jsx(z,{rows:10,cols:o.length+1||5})}):e.jsxs(e.Fragment,{children:[_.map(s=>e.jsxs("tbody",{className:"divide-y divide-border",children:[e.jsx("tr",{className:"bg-page/50",children:e.jsx("td",{colSpan:o.length+1,className:`p-2 font-bold text-primary-text border-b border-border ${j?"":"sticky left-0 bg-page/80 backdrop-blur-sm z-10"}`,children:s.name})}),s.permissions.map(a=>{const i=X.get(a);return i?T(i):null})]},s.id)),$.length>0&&e.jsxs("tbody",{className:"divide-y divide-border",children:[e.jsx("tr",{className:"bg-page/50",children:e.jsx("td",{colSpan:o.length+1,className:`p-2 font-bold text-primary-text border-b border-border ${j?"":"sticky left-0 bg-page/80 backdrop-blur-sm z-10"}`,children:"Uncategorized"})}),$.map(T)]})]})]})})]})};export{F as allPermissions,Ne as default};
