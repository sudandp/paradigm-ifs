import{j as e,T as R,B as n,m as D}from"./index-D5q3SS3D.js";import{u as I,b as d}from"./react-vendor-BUaIliXj.js";import{E,F as A}from"./FileSaver.min-C7cHFFkD.js";import{A as z}from"./AdminPageHeader-wINx_pXe.js";import{R as O,m as W,$ as U,a2 as C,au as S,av as Y,ap as H,aw as $}from"./ui-vendor-B8EvWqdc.js";import{f as x}from"./utils-vendor-DmorxLnX.js";import"./pdf-vendor-CB_F1AVu.js";import"./capacitor-vendor-CqiIOUn1.js";import"./supabase-7WG3J4rU.js";const ae=()=>{const y=I(),[v,j]=d.useState(!1),[p,i]=d.useState(!1),[o,h]=d.useState([]),[N,r]=d.useState(null),[u,c]=d.useState(null),B=async()=>{j(!0),r(null);try{const a=await D.getUsers(),s=new E.Workbook,t=s.addWorksheet("Earned Leaves");t.columns=[{header:"User ID",key:"id",width:40},{header:"Employee Name",key:"name",width:30},{header:"Earned Leave Balance",key:"balance",width:20},{header:"Opening Date (YYYY-MM-DD)",key:"openingDate",width:25}],t.getRow(1).font={bold:!0},t.getRow(1).fill={type:"pattern",pattern:"solid",fgColor:{argb:"FFE0E0E0"}},a.forEach(l=>{t.addRow({id:l.id,name:l.name,balance:l.earnedLeaveOpeningBalance||0,openingDate:l.earnedLeaveOpeningDate||x(new Date,"yyyy-MM-dd")})});const f=await s.xlsx.writeBuffer(),g=new Blob([f],{type:"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"});A.saveAs(g,`Earned_Leaves_Update_Template_${x(new Date,"yyyyMMdd")}.xlsx`),c({message:"Template downloaded successfully!",type:"success"})}catch(a){console.error("Download error:",a),r("Failed to generate template.")}finally{j(!1)}},F=async a=>{const s=a.target.files?.[0];if(s){i(!0),r(null),h([]);try{const t=new E.Workbook,f=await s.arrayBuffer();await t.xlsx.load(f);const g=t.getWorksheet(1),l=[];g?.eachRow((m,L)=>{if(L===1)return;const k=m.getCell(1).value?.toString(),T=m.getCell(2).value?.toString(),P=m.getCell(3).value?.toString()||"0",_=parseFloat(P),b=m.getCell(4).value;let w="";b instanceof Date?w=x(b,"yyyy-MM-dd"):w=b?.toString()||"",k&&!isNaN(_)&&l.push({id:k,name:T,earned_leave_opening_balance:_,earned_leave_opening_date:w||x(new Date,"yyyy-MM-dd")})}),l.length===0?r("No valid rows found in the Excel file."):(h(l),c({message:"Excel file parsed successfully!",type:"success"}))}catch(t){console.error("Upload error:",t),r("Failed to parse Excel file. Please ensure it is a valid .xlsx file.")}finally{i(!1),a.target&&(a.target.value="")}}},M=async()=>{i(!0);try{const a=o.map(s=>({id:s.id,earned_leave_opening_balance:s.earned_leave_opening_balance,earned_leave_opening_date:s.earned_leave_opening_date}));await D.bulkUpdateUserLeaves(a),c({message:"Bulk leave update successful!",type:"success"}),setTimeout(()=>y("/admin/users"),2e3)}catch(a){console.error("Import error:",a),r("Failed to update leave balances.")}finally{i(!1)}};return e.jsxs("div",{className:"p-4 md:p-6 lg:p-8 max-w-7xl mx-auto",children:[u&&e.jsx(R,{message:u.message,type:u.type,onDismiss:()=>c(null)}),e.jsx("div",{className:"mb-6 flex items-center gap-4",children:e.jsxs(n,{variant:"outline",size:"sm",onClick:()=>y("/admin/users"),children:[e.jsx(O,{className:"h-4 w-4 mr-2"}),"Back to Users"]})}),e.jsx(z,{title:"Bulk Update Earned Leaves"}),e.jsxs("div",{className:"mt-8 space-y-8",children:[e.jsxs("div",{className:"bg-blue-50 border border-blue-200 p-4 rounded-xl flex items-start gap-4",children:[e.jsx(W,{className:"h-6 w-6 text-blue-600 flex-shrink-0 mt-0.5"}),e.jsxs("div",{children:[e.jsx("h4",{className:"font-semibold text-blue-900",children:"How to update leave balances in bulk"}),e.jsx("p",{className:"text-sm text-blue-800 mt-1",children:"1. Download the current employee template. 2. Update the balance and opening dates in Excel. 3. Upload the modified file to preview and confirm changes."})]})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:[e.jsxs("div",{className:"bg-white border border-border rounded-2xl p-8 shadow-sm hover:shadow-md transition-shadow",children:[e.jsx("div",{className:"bg-emerald-50 w-14 h-14 rounded-2xl flex items-center justify-center mb-6",children:e.jsx(U,{className:"h-8 w-8 text-emerald-600"})}),e.jsx("h3",{className:"text-xl font-bold text-primary-text mb-2",children:"1. Download Template"}),e.jsx("p",{className:"text-muted mb-6",children:"Generate a customized Excel spreadsheet containing all active employees and their current leave settings."}),e.jsxs(n,{variant:"primary",className:"w-full h-12 text-lg",onClick:B,disabled:v,children:[v?e.jsx(C,{className:"h-5 w-5 animate-spin mr-2"}):e.jsx(U,{className:"h-5 w-5 mr-2"}),"Download Current Data"]})]}),e.jsxs("div",{className:"bg-white border border-border rounded-2xl p-8 shadow-sm hover:shadow-md transition-shadow",children:[e.jsx("div",{className:"bg-blue-50 w-14 h-14 rounded-2xl flex items-center justify-center mb-6",children:e.jsx(S,{className:"h-8 w-8 text-blue-600"})}),e.jsx("h3",{className:"text-xl font-bold text-primary-text mb-2",children:"2. Upload Modified File"}),e.jsx("p",{className:"text-muted mb-6",children:"Upload your updated Excel file. The system will automatically detect changes and prepare a preview."}),e.jsxs("div",{className:"relative",children:[e.jsx("input",{type:"file",accept:".xlsx",onChange:F,className:"absolute inset-0 opacity-0 cursor-pointer",disabled:p}),e.jsxs(n,{variant:"outline",className:"w-full h-12 text-lg pointer-events-none",children:[e.jsx(S,{className:"h-5 w-5 mr-2"}),"Select Excel File"]})]})]})]}),N&&e.jsxs("div",{className:"bg-red-50 border border-red-200 text-red-700 p-6 rounded-2xl flex items-start gap-4 animate-in fade-in zoom-in",children:[e.jsx(Y,{className:"h-6 w-6 flex-shrink-0"}),e.jsxs("div",{children:[e.jsx("h4",{className:"font-bold",children:"Error Processing File"}),e.jsx("p",{className:"text-sm mt-1",children:N})]})]}),o.length>0&&e.jsxs("div",{className:"bg-white border border-border rounded-2xl shadow-sm overflow-hidden animate-in fade-in slide-in-from-bottom-4",children:[e.jsxs("div",{className:"p-6 border-b border-border bg-gray-50/50 flex flex-wrap items-center justify-between gap-4",children:[e.jsxs("div",{children:[e.jsxs("h3",{className:"text-lg font-bold text-primary-text flex items-center gap-2",children:[e.jsx(H,{className:"h-5 w-5 text-emerald-600"}),"Preview Updates (",o.length," Records)"]}),e.jsx("p",{className:"text-sm text-muted mt-1",children:"Please review the detected changes before confirming the update."})]}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(n,{variant:"secondary",onClick:()=>h([]),children:"Discard"}),e.jsxs(n,{onClick:M,disabled:p,className:"bg-emerald-600 hover:bg-emerald-700 text-white px-8",children:[p?e.jsx(C,{className:"h-4 w-4 animate-spin mr-2"}):e.jsx($,{className:"h-4 w-4 mr-2"}),"Confirm & Update"]})]})]}),e.jsx("div",{className:"overflow-x-auto max-h-[600px]",children:e.jsxs("table",{className:"w-full text-left",children:[e.jsx("thead",{className:"bg-gray-50 sticky top-0 border-b border-border z-10",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-6 py-4 font-semibold text-sm text-muted uppercase tracking-wider",children:"Employee Name"}),e.jsx("th",{className:"px-6 py-4 font-semibold text-sm text-muted uppercase tracking-wider text-center",children:"New Balance (Days)"}),e.jsx("th",{className:"px-6 py-4 font-semibold text-sm text-muted uppercase tracking-wider text-right",children:"Opening Date"})]})}),e.jsx("tbody",{className:"divide-y divide-border",children:o.map((a,s)=>e.jsxs("tr",{className:"hover:bg-blue-50/30 transition-colors",children:[e.jsx("td",{className:"px-6 py-4 font-medium text-primary-text",children:a.name}),e.jsx("td",{className:"px-6 py-4 text-center",children:e.jsx("span",{className:"inline-flex items-center px-3 py-1 rounded-full bg-emerald-100 text-emerald-700 font-bold",children:a.earned_leave_opening_balance})}),e.jsx("td",{className:"px-6 py-4 text-right text-muted font-mono",children:a.earned_leave_opening_date})]},s))})]})})]})]})]})};export{ae as default};
