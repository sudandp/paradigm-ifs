import{h as J,l as Q,k as K,d as R,S as W,e as n,R as X,q as Y,c as Z,o as ee,O as ae,_ as d,j as e,C as t,B as A,I as j,p as re}from"./index-D5q3SS3D.js";import{m as oe,b as c}from"./react-vendor-BUaIliXj.js";import{S as D}from"./Select-Dz12MdxG.js";import{M as se}from"./Modal-CR2aBU6L.js";import{F as le}from"./FormHeader-CSy2Sh-o.js";import{U as te}from"./UploadDocument-BAL6UInC.js";import{D as ne}from"./DatePicker-D2ulOwJx.js";import{at as k,ao as P}from"./ui-vendor-B8EvWqdc.js";import{L as ie,f as me}from"./utils-vendor-DmorxLnX.js";import"./pdf-vendor-CB_F1AVu.js";import"./capacitor-vendor-CqiIOUn1.js";import"./supabase-7WG3J4rU.js";import"./CameraCaptureModal-DQDGRnEP.js";const Ne=()=>{const{onValidated:I,setToast:x}=oe(),{data:g,updateFamily:u}=J(),{rulesByDesignation:v}=Q(),V=K("(max-width: 767px)"),p=g.organization.designation,C=c.useMemo(()=>{const o=p&&v[p];return o?o.documents.familyAadhaar:!1},[p,v]),B=R({id:n().required(),relation:n().oneOf(["Spouse","Child","Father","Mother",""]).required("Relation is required"),name:n().required("Name is required"),dob:n().required("Date of birth is required"),gender:n().oneOf(["Male","Female","Other",""]).required("Gender is required"),occupation:n().optional(),dependent:X().required(),phone:n().when("relation",{is:"Child",then:o=>o.optional().nullable().matches(/^[6-9][0-9]{9}$/,{message:"Must be a valid 10-digit number",excludeEmptyString:!0}),otherwise:o=>o.required("Phone number is required").matches(/^[6-9][0-9]{9}$/,"Must be a valid 10-digit Indian number")}),idProof:W().nullable().when([],{is:()=>C,then:o=>o.test("is-required","Aadhaar proof is required for this designation.",r=>r!=null).nullable(),otherwise:o=>o.optional().nullable()})}),E=R({family:Y().of(B).required()}),{control:s,handleSubmit:N,formState:{errors:i},watch:M,setValue:m}=Z({resolver:ee(E),defaultValues:{family:g.family}}),{fields:S,append:L,remove:G}=ae({control:s,name:"family"}),[U,f]=c.useState(!1),[$,w]=c.useState(null);c.useEffect(()=>{let o;const r=M(a=>{clearTimeout(o),o=window.setTimeout(()=>{u(a.family)},500)});return()=>{r.unsubscribe(),clearTimeout(o)}},[M,u]);const z=o=>r=>{let a=!1;if(r.name){const l=r.name.toLowerCase().replace(/\b(\w)/g,h=>h.toUpperCase());m(`family.${o}.name`,l,{shouldValidate:!0}),a=!0}if(r.dob)try{const l=r.dob.replace(/[/.]/g,"-"),h=["dd-MM-yyyy","yyyy-MM-dd","MM-dd-yyyy","d-M-yyyy"];let y=null;for(const b of h){const O=ie(l,b,new Date);if(!isNaN(O.getTime())){y=O;break}}if(y){const b=me(y,"yyyy-MM-dd");m(`family.${o}.dob`,b,{shouldValidate:!0}),a=!0}}catch{console.error("Could not parse date from OCR:",r.dob)}if(r.gender){const l=r.gender.toLowerCase().trim();l.includes("male")||l.includes("purush")||l==="m"?(m(`family.${o}.gender`,"Male",{shouldValidate:!0}),a=!0):(l.includes("female")||l.includes("mahila")||l==="f")&&(m(`family.${o}.gender`,"Female",{shouldValidate:!0}),a=!0)}a&&x({message:"Family member details auto-filled.",type:"success"})},_={type:d.OBJECT,properties:{name:{type:d.STRING},dob:{type:d.STRING},gender:{type:d.STRING}}},F=()=>{L({id:`fam_${Date.now()}`,relation:"",name:"",dob:"",gender:"",occupation:"",dependent:!1,idProof:null,phone:""})},T=o=>{w(o),f(!0)},H=()=>{$!==null&&(G($),f(!1),w(null))},q=async o=>{u(o.family),await I()};return V?e.jsxs("form",{onSubmit:N(q),id:"family-form",children:[e.jsx("p",{className:"text-sm text-gray-400 mb-6",children:"List your immediate family members."}),e.jsx("div",{className:"space-y-4",children:S.map((o,r)=>e.jsxs("div",{className:"p-4 border border-border rounded-xl relative space-y-4",children:[e.jsx("button",{type:"button",onClick:()=>T(r),className:"absolute top-2 right-2 p-1 text-red-500 rounded-full z-10","aria-label":"Remove family member",children:e.jsx(k,{className:"h-5 w-5"})}),e.jsx(t,{name:`family.${r}.relation`,control:s,render:({field:a})=>e.jsxs("select",{...a,className:"pro-select pro-select-arrow",children:[e.jsx("option",{value:"",children:"Select Relation"}),e.jsx("option",{children:"Spouse"}),e.jsx("option",{children:"Child"}),e.jsx("option",{children:"Father"}),e.jsx("option",{children:"Mother"})]})}),e.jsx(t,{name:`family.${r}.name`,control:s,render:({field:a})=>e.jsx("input",{placeholder:"Full Name",...a,className:"form-input"})}),e.jsx(t,{name:`family.${r}.dob`,control:s,render:({field:a})=>e.jsx("input",{type:"date",placeholder:"Date of Birth",...a,className:"form-input"})}),e.jsx(t,{name:`family.${r}.phone`,control:s,render:({field:a})=>e.jsx("input",{placeholder:"Phone Number",type:"tel",...a,className:"form-input"})})]},o.id))}),e.jsxs(A,{type:"button",onClick:F,variant:"secondary",className:"mt-6 w-full flex items-center justify-center",children:[e.jsx(P,{className:"mr-2 h-4 w-4"})," Add Family Member"]})]}):e.jsxs("form",{onSubmit:N(q),id:"family-form",children:[e.jsx(se,{isOpen:U,onClose:()=>f(!1),onConfirm:H,title:"Confirm Deletion",children:"Are you sure you want to remove this family member? This action cannot be undone."}),e.jsx(le,{title:"Family Details",subtitle:"List your immediate family members."}),e.jsx("div",{className:"space-y-6",children:S.map((o,r)=>e.jsxs("div",{className:"p-4 border border-border rounded-xl relative",children:[e.jsx("button",{type:"button",onClick:()=>T(r),className:"absolute top-2 right-2 p-1 text-red-500 hover:bg-red-100 rounded-full","aria-label":`Remove ${o.name}`,children:e.jsx(k,{className:"h-4 w-4"})}),e.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4",children:[e.jsx(t,{name:`family.${r}.relation`,control:s,render:({field:a})=>e.jsxs(D,{label:"Relation",id:a.name,error:i.family?.[r]?.relation?.message,...a,children:[e.jsx("option",{value:"",children:"Select"}),e.jsx("option",{children:"Spouse"}),e.jsx("option",{children:"Child"}),e.jsx("option",{children:"Father"}),e.jsx("option",{children:"Mother"})]})}),e.jsx(t,{name:`family.${r}.name`,control:s,render:({field:a})=>e.jsx(j,{label:"Full Name",id:a.name,error:i.family?.[r]?.name?.message,...a})}),e.jsx(t,{name:`family.${r}.dob`,control:s,render:({field:a})=>e.jsx(ne,{label:"Date of Birth",id:a.name,value:a.value,onChange:a.onChange,error:i.family?.[r]?.dob?.message,maxDate:new Date})}),e.jsx(t,{name:`family.${r}.gender`,control:s,render:({field:a})=>e.jsxs(D,{label:"Gender",id:a.name,error:i.family?.[r]?.gender?.message,...a,children:[e.jsx("option",{value:"",children:"Select"}),e.jsx("option",{children:"Male"}),e.jsx("option",{children:"Female"}),e.jsx("option",{children:"Other"})]})}),e.jsx(t,{name:`family.${r}.phone`,control:s,render:({field:a})=>e.jsx(j,{label:"Phone Number",id:a.name,type:"tel",error:i.family?.[r]?.phone?.message,...a,value:a.value??""})}),e.jsx(t,{name:`family.${r}.occupation`,control:s,render:({field:a})=>e.jsx(j,{label:"Occupation (Optional)",id:a.name,...a,value:a.value??""})}),e.jsx("div",{className:"col-span-full md:col-span-1 flex items-center pt-5",children:e.jsx(t,{name:`family.${r}.dependent`,control:s,render:({field:a})=>e.jsx(re,{id:a.name,label:"Is a dependent?",checked:a.value,onChange:a.onChange})})}),e.jsx("div",{className:"col-span-full",children:e.jsx(t,{name:`family.${r}.idProof`,control:s,render:({field:a,fieldState:l})=>e.jsx(te,{label:`Aadhaar Proof ${C?"(Mandatory)":"(Optional)"}`,file:a.value,onFileChange:a.onChange,onOcrComplete:z(r),ocrSchema:_,setToast:x,error:l.error?.message,docType:"Aadhaar"})})})]})]},o.id))}),e.jsxs(A,{type:"button",onClick:F,variant:"outline",className:"mt-6",children:[e.jsx(P,{className:"mr-2 h-4 w-4"})," Add Family Member"]})]})};export{Ne as default};
