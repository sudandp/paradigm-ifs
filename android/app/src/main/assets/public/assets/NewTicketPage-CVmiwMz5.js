import{u as q,k as U,c as M,o as H,Z as R,m as N,i as w,j as e,I as S,C as n,T,B as k,d as _,S as Q,e as d}from"./index-D5q3SS3D.js";import{u as $,b as m}from"./react-vendor-BUaIliXj.js";import{S as l}from"./Select-Dz12MdxG.js";import{U as C}from"./UploadDocument-BAL6UInC.js";import{bO as I}from"./ui-vendor-B8EvWqdc.js";import"./pdf-vendor-CB_F1AVu.js";import"./capacitor-vendor-CqiIOUn1.js";import"./utils-vendor-DmorxLnX.js";import"./supabase-7WG3J4rU.js";import"./CameraCaptureModal-DQDGRnEP.js";const B=_({title:d().required("Title is required"),description:d().required("Description is required"),category:d().oneOf(["Software Developer","Admin","Operational","HR Query","Other"]).required("Category is required"),priority:d().oneOf(["Low","Medium","High","Urgent"]).required("Priority is required"),assignedToId:d().optional().nullable(),attachment:Q().optional().nullable()}).defined(),K=()=>{const x=$(),{user:h}=q(),[c,j]=m.useState(!1),[i,D]=m.useState([]),[o,p]=m.useState(null),A=U("(max-width: 767px)"),{register:u,handleSubmit:f,control:a,formState:{errors:t}}=M({resolver:H(B),defaultValues:{category:"Software Developer",priority:"Medium",assignedToId:null,attachment:null}}),y=R({control:a,name:"category"});m.useEffect(()=>{N.getUsers().then(D)},[]);const b=m.useMemo(()=>{if(!i)return[];switch(y){case"Software Developer":return i.filter(s=>s.role==="developer");case"Admin":return i.filter(s=>w(s.role));case"HR Query":return i.filter(s=>s.role==="hr");case"Operational":return i.filter(s=>["operation_manager","site_manager"].includes(s.role));default:const r=["hr","developer","operation_manager","site_manager"];return i.filter(s=>w(s.role)||r.includes(s.role))}},[i,y]),v=async r=>{if(h){j(!0);try{const s=i.find(O=>O.id===r.assignedToId);await N.createSupportTicket({...r,attachment:r.attachment,status:"Open",raisedById:h.id,raisedByName:h.name,assignedToId:r.assignedToId||null,assignedToName:s?.name||null,resolvedAt:null,closedAt:null,rating:null,feedback:null}),p({message:"Ticket created successfully!",type:"success"}),setTimeout(()=>x("/support"),1500)}catch{p({message:"Failed to create ticket.",type:"error"})}finally{j(!1)}}},g="new-ticket-form";return A?e.jsxs("div",{className:"h-full flex flex-col",children:[e.jsx("header",{className:"p-4 flex-shrink-0 fo-mobile-header",children:e.jsx("h1",{children:"New Support Ticket"})}),e.jsx("main",{className:"flex-1 overflow-y-auto p-4",children:e.jsxs("div",{className:"bg-card rounded-2xl p-6 space-y-6",children:[e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"inline-block bg-accent-light p-3 rounded-full mb-2",children:e.jsx(I,{className:"h-8 w-8 text-accent-dark"})}),e.jsx("h2",{className:"text-xl font-bold text-primary-text",children:"Create New Ticket"}),e.jsx("p",{className:"text-sm text-gray-400",children:"Submit a support request or report an issue."})]}),e.jsxs("form",{id:g,onSubmit:f(v),className:"space-y-4",children:[e.jsx(S,{placeholder:"Title / Subject",...u("title"),error:t.title?.message}),e.jsxs("div",{children:[e.jsx("textarea",{placeholder:"Description",...u("description"),rows:5,className:`form-input ${t.description?"form-input--error":""}`}),t.description&&e.jsx("p",{className:"mt-1 text-xs text-red-600",children:t.description.message})]}),e.jsx(n,{name:"category",control:a,render:({field:r})=>e.jsxs(l,{...r,error:t.category?.message,children:[e.jsx("option",{children:"Software Developer"}),e.jsx("option",{children:"Admin"}),e.jsx("option",{children:"Operational"}),e.jsx("option",{children:"HR Query"}),e.jsx("option",{children:"Other"})]})}),e.jsx(n,{name:"priority",control:a,render:({field:r})=>e.jsxs(l,{...r,error:t.priority?.message,children:[e.jsx("option",{children:"Low"}),e.jsx("option",{children:"Medium"}),e.jsx("option",{children:"High"}),e.jsx("option",{children:"Urgent"})]})}),e.jsx(n,{name:"assignedToId",control:a,render:({field:r})=>e.jsxs(l,{...r,value:r.value??"",error:t.assignedToId?.message,children:[e.jsx("option",{value:"",children:"Unassigned"}),b.map(s=>e.jsxs("option",{value:s.id,children:[s.name," (",s.role.replace(/_/g," "),")"]},s.id))]})}),e.jsx(n,{name:"attachment",control:a,render:({field:r,fieldState:s})=>e.jsx(C,{label:"Attach Screenshot or Document (Image only)",file:r.value,onFileChange:r.onChange,allowedTypes:["image/jpeg","image/png","image/webp"],error:s.error?.message})})]})]})}),e.jsxs("footer",{className:"p-4 flex-shrink-0 flex items-center gap-4",children:[e.jsx("button",{type:"button",onClick:()=>x("/support"),disabled:c,className:"fo-btn-secondary px-6",children:"Cancel"}),e.jsx("button",{type:"submit",form:g,disabled:c,className:"fo-btn-primary flex-1",children:c?"Creating...":"Create Ticket"})]}),o&&e.jsx(T,{message:o.message,type:o.type,onDismiss:()=>p(null)})]}):e.jsxs("div",{className:"p-4 md:p-6",children:[e.jsxs("div",{className:"bg-card p-8 rounded-xl shadow-card w-full max-w-2xl mx-auto",children:[e.jsxs("div",{className:"flex items-center mb-6",children:[e.jsx("div",{className:"bg-accent-light p-3 rounded-full mr-4",children:e.jsx(I,{className:"h-8 w-8 text-accent-dark"})}),e.jsxs("div",{children:[e.jsx("h2",{className:"text-2xl font-bold text-primary-text",children:"Create New Ticket"}),e.jsx("p",{className:"text-muted",children:"Submit a support request or report an issue."})]})]}),e.jsxs("form",{id:g,onSubmit:f(v),className:"space-y-6",children:[e.jsx(S,{label:"Title / Subject",...u("title"),error:t.title?.message}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-muted mb-1",children:"Description"}),e.jsx("textarea",{...u("description"),rows:5,className:`form-input ${t.description?"form-input--error":""}`}),t.description&&e.jsx("p",{className:"mt-1 text-xs text-red-600",children:t.description.message})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsx(n,{name:"category",control:a,render:({field:r})=>e.jsxs(l,{label:"Category",...r,error:t.category?.message,children:[e.jsx("option",{children:"Software Developer"}),e.jsx("option",{children:"Admin"}),e.jsx("option",{children:"Operational"}),e.jsx("option",{children:"HR Query"}),e.jsx("option",{children:"Other"})]})}),e.jsx(n,{name:"priority",control:a,render:({field:r})=>e.jsxs(l,{label:"Priority",...r,error:t.priority?.message,children:[e.jsx("option",{children:"Low"}),e.jsx("option",{children:"Medium"}),e.jsx("option",{children:"High"}),e.jsx("option",{children:"Urgent"})]})})]}),e.jsx(n,{name:"assignedToId",control:a,render:({field:r})=>e.jsxs(l,{label:"Assigned To (Optional)",...r,value:r.value??"",error:t.assignedToId?.message,children:[e.jsx("option",{value:"",children:"Unassigned"}),b.map(s=>e.jsxs("option",{value:s.id,children:[s.name," (",s.role.replace(/_/g," "),")"]},s.id))]})}),e.jsx(n,{name:"attachment",control:a,render:({field:r,fieldState:s})=>e.jsx(C,{label:"Attach Screenshot or Document (Image only)",file:r.value,onFileChange:r.onChange,allowedTypes:["image/jpeg","image/png","image/webp"],error:s.error?.message})}),e.jsxs("div",{className:"mt-8 pt-6 border-t flex justify-end gap-3",children:[e.jsx(k,{type:"button",onClick:()=>x("/support"),variant:"secondary",disabled:c,children:"Cancel"}),e.jsx(k,{type:"submit",isLoading:c,children:"Create Ticket"})]})]})]}),o&&e.jsx(T,{message:o.message,type:o.type,onDismiss:()=>p(null)})]})};export{K as default};
