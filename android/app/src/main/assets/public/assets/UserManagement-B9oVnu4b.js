import{m as p,j as e,T as V,I as ie,B as h,k as de}from"./index-D5q3SS3D.js";import{b as a,u as ce,R as Y}from"./react-vendor-BUaIliXj.js";import{M as $}from"./Modal-CR2aBU6L.js";import{A as me}from"./AdminPageHeader-wINx_pXe.js";import{T as xe}from"./TableSkeleton-Bf5l1KHK.js";import{S as ue}from"./Select-Dz12MdxG.js";import{X as pe,ao as J,ap as he,m as ge,aq as fe,ar as K,as as W,M as Z,at as ee}from"./ui-vendor-B8EvWqdc.js";import{P as be}from"./Pagination-DXf7cs0z.js";import"./pdf-vendor-CB_F1AVu.js";import"./capacitor-vendor-CqiIOUn1.js";import"./utils-vendor-DmorxLnX.js";import"./supabase-7WG3J4rU.js";import"./Skeleton-D0WWmlnq.js";const je=({isOpen:s,onClose:o,onApprove:n,user:m,isConfirming:u})=>{const[g,y]=a.useState([]),[f,C]=a.useState(""),[N,L]=a.useState(!0);a.useEffect(()=>{s&&(L(!0),p.getRoles().then(d=>{const x=d.filter(b=>b.id!=="unverified"&&b.id!=="admin");y(x),x.length>0&&C(x[0].id),L(!1)}))},[s]);const v=()=>{m&&f&&n(m.id,f)};return!s||!m?null:e.jsx($,{isOpen:s,onClose:o,onConfirm:v,title:"Approve User Account",confirmButtonText:"Confirm Approval",confirmButtonVariant:"primary",isConfirming:u,children:e.jsxs("div",{className:"space-y-4",children:[e.jsxs("p",{children:["You are approving the account for ",e.jsx("strong",{className:"text-primary-text",children:m.name})," (",m.email,")."]}),e.jsx("p",{children:"Please assign a role to activate their account."}),N?e.jsx("p",{children:"Loading roles..."}):e.jsx(ue,{label:"Assign Role",id:"approval-role",value:f,onChange:d=>C(d.target.value),children:g.map(d=>e.jsx("option",{value:d.id,children:d.displayName},d.id))})]})})},ye=({isOpen:s,onClose:o,userId:n,userName:m,onSuccess:u})=>{const[g,y]=a.useState([]),[f,C]=a.useState([]),[N,L]=a.useState(!0),[v,d]=a.useState(!1),[x,b]=a.useState(""),[S,j]=a.useState(null);a.useEffect(()=>{s&&n&&l()},[s,n]);const l=async()=>{L(!0);try{const[r,c]=await Promise.all([p.getUserLocations(n),p.getLocations()]);y(r),C(c)}catch(r){console.error("Failed to load locations:",r),j({message:"Failed to load locations.",type:"error"})}finally{L(!1)}},T=async r=>{d(!0);try{await p.assignLocationToUser(n,r);const c=await p.getUserLocations(n);y(c),j({message:"Location assigned successfully!",type:"success"}),u?.()}catch(c){console.error("Failed to assign location:",c),j({message:c.message||"Failed to assign location.",type:"error"})}finally{d(!1)}},E=async r=>{d(!0);try{await p.unassignLocationFromUser(n,r);const c=await p.getUserLocations(n);y(c),j({message:"Location unassigned successfully!",type:"success"}),u?.()}catch(c){console.error("Failed to unassign location:",c),j({message:c.message||"Failed to unassign location.",type:"error"})}finally{d(!1)}},F=r=>g.some(c=>c.id===r),M=f.filter(r=>!F(r.id)).filter(r=>x===""||r.name?.toLowerCase().includes(x.toLowerCase())||r.address?.toLowerCase().includes(x.toLowerCase()));return e.jsxs(e.Fragment,{children:[S&&e.jsx(V,{message:S.message,type:S.type,onDismiss:()=>j(null)}),e.jsx($,{isOpen:s,onClose:o,title:`Manage Locations for ${m}`,hideFooter:!0,children:e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{children:[e.jsxs("h3",{className:"text-sm font-semibold text-primary-text mb-3",children:["Assigned Locations (",g.length,")"]}),N?e.jsx("p",{className:"text-sm text-muted",children:"Loading..."}):g.length===0?e.jsx("p",{className:"text-sm text-muted bg-gray-50 p-3 rounded-lg",children:"No locations assigned yet."}):e.jsx("div",{className:"space-y-2 max-h-60 overflow-y-auto",children:g.map(r=>e.jsxs("div",{className:"flex items-start justify-between bg-accent/10 border border-accent/30 rounded-lg p-3",children:[e.jsxs("div",{className:"flex-1",children:[e.jsx("h4",{className:"font-semibold text-sm text-primary-text",children:r.name||"Unnamed"}),e.jsx("p",{className:"text-xs text-muted mt-1",children:r.address||"No address"})]}),e.jsx("button",{type:"button",onClick:()=>E(r.id),disabled:v,className:"text-red-500 hover:text-red-700 disabled:opacity-50 p-1",title:"Remove",children:e.jsx(pe,{className:"h-5 w-5"})})]},r.id))})]}),e.jsxs("div",{children:[e.jsxs("h3",{className:"text-sm font-semibold text-primary-text mb-3",children:["Available Locations (",M.length,")"]}),e.jsx(ie,{type:"text",placeholder:"Search locations...",value:x,onChange:r=>b(r.target.value),className:"mb-3"}),N?e.jsx("p",{className:"text-sm text-muted",children:"Loading..."}):M.length===0?e.jsx("p",{className:"text-sm text-muted bg-gray-50 p-3 rounded-lg",children:x?"No locations found.":"All assigned."}):e.jsx("div",{className:"space-y-2 max-h-60 overflow-y-auto",children:M.map(r=>e.jsxs("div",{className:"flex items-start justify-between border border-border rounded-lg p-3 hover:bg-gray-50",children:[e.jsxs("div",{className:"flex-1",children:[e.jsx("h4",{className:"font-semibold text-sm text-primary-text",children:r.name||"Unnamed"}),e.jsx("p",{className:"text-xs text-muted mt-1",children:r.address||"No address"}),e.jsxs("p",{className:"text-xs text-muted mt-1",children:[r.latitude.toFixed(4),", ",r.longitude.toFixed(4)," â€¢ Radius: ",r.radius,"m"]})]}),e.jsx("button",{type:"button",onClick:()=>T(r.id),disabled:v,className:"text-accent hover:text-accent-dark disabled:opacity-50 p-1",title:"Assign",children:e.jsx(J,{className:"h-5 w-5"})})]},r.id))})]}),e.jsx("div",{className:"flex justify-end pt-4 border-t border-border",children:e.jsx(h,{onClick:o,variant:"secondary",children:"Done"})})]})})]})},B=s=>s?s.replace(/_/g," ").replace(/\b\w/g,o=>o.toUpperCase()):"N/A",se=s=>{switch(s){case"admin":return"bg-purple-100 text-purple-700";case"hr":return"bg-blue-100 text-blue-700";case"management":return"bg-emerald-100 text-emerald-700";case"site_manager":return"bg-orange-100 text-orange-800";case"field_staff":return"bg-sky-100 text-sky-800";case"finance":return"bg-teal-100 text-teal-700";case"developer":return"bg-indigo-100 text-indigo-700";case"operation_manager":return"bg-rose-100 text-rose-700";case"unverified":return"bg-yellow-100 text-yellow-800";default:return"bg-slate-100 text-slate-700"}},Ne=Y.memo(({user:s,handleApprove:o,handleEdit:n,handleManageLocations:m,handleDelete:u})=>e.jsxs("tr",{children:[e.jsx("td",{"data-label":"Name",className:"px-6 py-4 font-medium",children:s.name}),e.jsx("td",{"data-label":"Email",className:"px-6 py-4 text-sm text-muted",children:s.email}),e.jsxs("td",{"data-label":"Role",className:"px-6 py-4 text-sm text-muted",children:[e.jsx("span",{className:`text-xs px-2 py-1 rounded-full font-medium ${se(s.role)}`,children:B(s.role)}),s.role==="unverified"&&e.jsx("span",{className:"text-xs font-semibold px-2 py-0.5 rounded-full bg-yellow-100 text-yellow-800 ml-2",children:"Pending Approval"})]}),e.jsx("td",{"data-label":"Site",className:"px-6 py-4 text-sm text-muted",children:s.organizationName||"-"}),e.jsx("td",{"data-label":"Biometric ID",className:"px-6 py-4 text-sm font-mono text-muted",children:s.biometricId||"-"}),e.jsx("td",{"data-label":"Actions",className:"px-6 py-4",children:e.jsxs("div",{className:"flex items-center gap-2 md:justify-start justify-end",children:[s.role==="unverified"&&e.jsxs(h,{variant:"outline",size:"sm",onClick:()=>o(s),"aria-label":`Approve user ${s.name}`,title:`Approve user ${s.name}`,children:[e.jsx(K,{className:"h-4 w-4 mr-2"}),"Approve"]}),e.jsx(h,{variant:"icon",size:"sm",onClick:()=>n(s),"aria-label":`Edit user ${s.name}`,title:`Edit user ${s.name}`,children:e.jsx(W,{className:"h-4 w-4"})}),e.jsx(h,{variant:"icon",size:"sm",onClick:()=>m(s),"aria-label":`Manage Geofencing for ${s.name}`,title:`Manage Geofencing for ${s.name}`,children:e.jsx(Z,{className:"h-4 w-4 text-emerald-500"})}),e.jsx(h,{variant:"icon",onClick:()=>u(s),"aria-label":`Delete user ${s.name}`,title:`Delete user ${s.name}`,className:"p-2 hover:bg-red-500/10 rounded-full transition-colors",children:e.jsx(ee,{className:"h-5 w-5 text-red-500"})})]})})]})),ve=Y.memo(({user:s,handleApprove:o,handleEdit:n,handleManageLocations:m,handleDelete:u})=>e.jsxs("div",{className:"bg-card p-4 rounded-xl border border-border shadow-sm flex flex-col gap-3 h-full",children:[e.jsxs("div",{className:"flex justify-between items-start",children:[e.jsxs("div",{children:[e.jsx("h3",{className:"font-semibold text-primary-text",children:s.name}),e.jsx("p",{className:"text-sm text-muted",children:s.email})]}),e.jsx("span",{className:`text-xs px-2 py-1 rounded-full font-medium ${se(s.role)}`,children:B(s.role)})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-2 text-sm mt-1 flex-grow",children:[e.jsxs("div",{children:[e.jsx("span",{className:"text-xs text-muted block",children:"Site"}),e.jsx("span",{className:"font-medium text-primary-text",children:s.organizationName||"-"})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-xs text-muted block",children:"Biometric ID"}),e.jsx("span",{className:"font-mono text-primary-text",children:s.biometricId||"-"})]})]}),e.jsxs("div",{className:"pt-3 border-t border-border flex justify-end gap-2 mt-auto",children:[s.role==="unverified"&&e.jsxs(h,{variant:"outline",size:"sm",onClick:()=>o(s),className:"flex-1",children:[e.jsx(K,{className:"h-4 w-4 mr-2"}),"Approve"]}),e.jsx(h,{variant:"icon",size:"sm",onClick:()=>n(s),className:"h-9 w-9 border border-border rounded-lg",children:e.jsx(W,{className:"h-4 w-4"})}),e.jsx(h,{variant:"icon",size:"sm",onClick:()=>m(s),className:"h-9 w-9 border border-border rounded-lg",children:e.jsx(Z,{className:"h-4 w-4 text-emerald-500"})}),e.jsx(h,{variant:"icon",size:"sm",onClick:()=>u(s),className:"h-9 w-9 border border-border rounded-lg hover:bg-red-50 text-red-500",children:e.jsx(ee,{className:"h-4 w-4"})})]})]})),De=()=>{const s=ce(),[o,n]=a.useState([]),[m,u]=a.useState(0),[g,y]=a.useState(1),[f,C]=a.useState(10),[N,L]=a.useState(""),[v,d]=a.useState(!0),[x,b]=a.useState(!1),[S,j]=a.useState(!1),[l,T]=a.useState({name:"",email:"",role:"",site:"",biometricId:""}),[E,F]=a.useState(!1),[M,r]=a.useState(!1),[c,O]=a.useState(!1),[P,_]=a.useState(null),[q,te]=a.useState(null),[z,A]=a.useState(null);de("(max-width: 767px)");const U=a.useMemo(()=>Object.values(l).some(t=>t!==""),[l]),D=a.useCallback(async()=>{o.length===0&&d(!0);try{if(U){if(S)return;const i=await p.getUsers();n(i),u(i.length),j(!0)}else{const i=await p.getUsers({page:g,pageSize:f,search:N,sortBy:"name",sortAscending:!0});n(i.data),u(i.total),j(!1)}}catch{A({message:"Failed to fetch users.",type:"error"})}finally{d(!1)}},[g,f,U,S,o.length,N]);a.useEffect(()=>{y(1)},[f,N]),a.useEffect(()=>{D()},[D]);const ae=()=>{s("/admin/users/add")},G=a.useCallback(t=>{s(`/admin/users/edit/${t.id}`)},[s]),H=a.useCallback(t=>{_(t),r(!0)},[]),X=a.useCallback(t=>{_(t),F(!0)},[]),Q=a.useCallback(t=>{te(t),O(!0)},[]),re=async(t,i)=>{b(!0);try{await p.approveUser(t,i),A({message:"User approved and email confirmed successfully!",type:"success"}),r(!1),n(k=>k.map(I=>I.id===t?{...I,role:i}:I)),D()}catch{A({message:"Failed to approve user.",type:"error"})}finally{b(!1)}},le=async()=>{if(P){const t=P.id;b(!0);try{await p.deleteUser(t),A({message:"User deleted. Remember to also remove them from Supabase Auth.",type:"success"}),F(!1),n(i=>i.filter(k=>k.id!==t)),D()}catch{A({message:"Failed to delete user.",type:"error"})}finally{b(!1)}}},oe=()=>{T({name:"",email:"",role:"",site:"",biometricId:""})},w=t=>{const{name:i,value:k}=t.target;T(I=>({...I,[i]:k}))},ne=a.useMemo(()=>Array.from(new Set(o.map(t=>t.role).filter(Boolean))).sort(),[o]),R=a.useMemo(()=>o.filter(t=>!(l.name&&!t.name?.toLowerCase().includes(l.name.toLowerCase())||l.email&&!t.email?.toLowerCase().includes(l.email.toLowerCase())||l.role&&t.role!==l.role||l.site&&!(t.organizationName||"").toLowerCase().includes(l.site.toLowerCase())||l.biometricId&&!(t.biometricId||"").toLowerCase().includes(l.biometricId.toLowerCase()))).sort((t,i)=>(t.name||"").localeCompare(i.name||"")),[o,l]);return e.jsxs("div",{className:"p-4 border-0 shadow-none lg:bg-card lg:p-6 lg:rounded-xl lg:shadow-card",children:[z&&e.jsx(V,{message:z.message,type:z.type,onDismiss:()=>A(null)}),e.jsx(je,{isOpen:M,onClose:()=>r(!1),onApprove:re,user:P,isConfirming:x}),e.jsxs($,{isOpen:E,onClose:()=>F(!1),onConfirm:le,title:"Confirm Deletion",isConfirming:x,children:['Are you sure you want to delete the user "',P?.name,'"? This action cannot be undone.']}),e.jsx(ye,{isOpen:c,onClose:()=>O(!1),userId:q?.id||"",userName:q?.name||""}),e.jsx(me,{title:"User Management",children:e.jsxs("div",{className:"flex gap-2",children:[e.jsxs(h,{variant:"outline",onClick:()=>s("/admin/users/bulk-update-leaves"),children:[e.jsx(he,{className:"h-4 w-4 mr-2"}),"Bulk Update Leaves"]}),e.jsxs(h,{onClick:ae,children:[e.jsx(J,{className:"mr-2 h-4 w-4"})," Add User"]})]})}),e.jsx("div",{className:"mb-6 bg-blue-50 border border-blue-200 text-blue-800 p-4 rounded-lg text-sm",children:e.jsxs("div",{className:"flex items-start",children:[e.jsx(ge,{className:"h-5 w-5 mr-3 flex-shrink-0 mt-0.5"}),e.jsxs("div",{children:[e.jsx("h4",{className:"font-semibold",children:"Adding New Users"}),e.jsxs("p",{className:"mt-1",children:["Use the ",e.jsx("strong",{children:"Add User"})," button below to create a new user. Provide their name, email, role and a temporary password. The system will automatically provision their login, send them a verification email and create their profile."]})]})]})}),v&&o.length===0?e.jsxs("div",{className:"w-full",children:[e.jsx("div",{className:"hidden lg:block",children:e.jsx(xe,{rows:5,cols:6})}),e.jsx("div",{className:"lg:hidden grid grid-cols-1 md:grid-cols-2 gap-4",children:[1,2,3,4].map(t=>e.jsx("div",{className:"bg-card p-4 rounded-xl border border-border h-40 animate-pulse"},t))})]}):e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"lg:hidden",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-2 mb-4 bg-gray-50 p-3 rounded-lg border border-border",children:[e.jsx("input",{name:"name",type:"text",placeholder:"Filter Name...",value:l.name,onChange:w,className:"w-full text-sm px-3 py-2 border border-border rounded-md focus:outline-none focus:ring-1 focus:ring-primary"}),e.jsx("input",{name:"email",type:"text",placeholder:"Filter Email...",value:l.email,onChange:w,className:"w-full text-sm px-3 py-2 border border-border rounded-md focus:outline-none focus:ring-1 focus:ring-primary"})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[R.map(t=>e.jsx(ve,{user:t,handleApprove:H,handleEdit:G,handleManageLocations:Q,handleDelete:X},t.id)),R.length===0&&e.jsxs("div",{className:"col-span-full text-center py-8 text-muted",children:["No users found",U?" matching the current filters":"","."]})]})]}),e.jsxs("div",{className:"hidden lg:block overflow-x-auto max-w-full relative",children:[v&&e.jsx("div",{className:"absolute top-0 right-0 p-1",children:e.jsx("span",{className:"animate-pulse text-[10px] font-bold text-primary bg-primary/10 px-2 py-0.5 rounded",children:"AUTO-REFRESHING..."})}),e.jsxs("table",{className:"w-full table-auto responsive-table",children:[e.jsxs("thead",{children:[e.jsxs("tr",{children:[e.jsx("th",{scope:"col",className:"px-6 py-3 text-left text-xs font-medium text-muted uppercase",children:"Name"}),e.jsx("th",{scope:"col",className:"px-6 py-3 text-left text-xs font-medium text-muted uppercase",children:"Email"}),e.jsx("th",{scope:"col",className:"px-6 py-3 text-left text-xs font-medium text-muted uppercase",children:"Role"}),e.jsx("th",{scope:"col",className:"px-6 py-3 text-left text-xs font-medium text-muted uppercase",children:"Site"}),e.jsx("th",{scope:"col",className:"px-6 py-3 text-left text-xs font-medium text-muted uppercase",children:"Biometric ID"}),e.jsx("th",{scope:"col",className:"px-6 py-3 text-left text-xs font-medium text-muted uppercase",children:e.jsxs("div",{className:"flex items-center gap-2",children:["Actions",U&&e.jsx("button",{onClick:oe,className:"text-red-500 hover:text-red-700 transition-colors",title:"Clear all filters",children:e.jsx(fe,{className:"h-4 w-4"})})]})})]}),e.jsxs("tr",{className:"bg-gray-50/50",children:[e.jsx("th",{className:"px-6 py-2",children:e.jsx("input",{id:"filter-name",name:"name",type:"text",placeholder:"Filter...",value:l.name,onChange:w,className:"w-full text-sm font-normal px-2 py-1.5 border border-border rounded-md bg-white focus:outline-none focus:ring-1 focus:ring-primary focus:border-primary"})}),e.jsx("th",{className:"px-6 py-2",children:e.jsx("input",{id:"filter-email",name:"email",type:"text",placeholder:"Filter...",value:l.email,onChange:w,className:"w-full text-sm font-normal px-2 py-1.5 border border-border rounded-md bg-white focus:outline-none focus:ring-1 focus:ring-primary focus:border-primary"})}),e.jsx("th",{className:"px-6 py-2",children:e.jsxs("select",{id:"filter-role",name:"role",value:l.role,onChange:w,className:"w-full text-sm font-normal px-2 py-1.5 border border-border rounded-md bg-white focus:outline-none focus:ring-1 focus:ring-primary focus:border-primary",children:[e.jsx("option",{value:"",children:"All Roles"}),ne.map(t=>e.jsx("option",{value:t,children:B(t)},t))]})}),e.jsx("th",{className:"px-6 py-2",children:e.jsx("input",{id:"filter-site",name:"site",type:"text",placeholder:"Filter...",value:l.site,onChange:w,className:"w-full text-sm font-normal px-2 py-1.5 border border-border rounded-md bg-white focus:outline-none focus:ring-1 focus:ring-primary focus:border-primary"})}),e.jsx("th",{className:"px-6 py-2",children:e.jsx("input",{id:"filter-biometric-id",name:"biometricId",type:"text",placeholder:"Filter...",value:l.biometricId,onChange:w,className:"w-full text-sm font-normal px-2 py-1.5 border border-border rounded-md bg-white focus:outline-none focus:ring-1 focus:ring-primary focus:border-primary"})}),e.jsx("th",{className:"px-6 py-2"})]})]}),e.jsx("tbody",{className:"divide-y divide-border md:bg-card md:divide-y-0",children:R.map(t=>e.jsx(Ne,{user:t,handleApprove:H,handleEdit:G,handleManageLocations:Q,handleDelete:X},t.id))})]})]})]}),!U&&e.jsx(be,{currentPage:g,totalItems:m,pageSize:f,onPageChange:y,onPageSizeChange:C,className:"mt-6"}),U&&R.length>0&&e.jsxs("div",{className:"mt-4 text-sm text-muted text-center",children:["Showing ",R.length," of ",o.length," total users"]})]})};export{De as default};
