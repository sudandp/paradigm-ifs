import{k as q,m as y,s as C,j as e,T as $,B as u}from"./index-D5q3SS3D.js";import{b as n,u as z}from"./react-vendor-BUaIliXj.js";import{S as A}from"./StatusChip-B0urzFi1.js";import{T as k}from"./TableSkeleton-Bf5l1KHK.js";import{aj as I,T as M,ak as D,F as E,al as V,am as F,a4 as B,a2 as R,an as _}from"./ui-vendor-B8EvWqdc.js";import"./pdf-vendor-CB_F1AVu.js";import"./capacitor-vendor-CqiIOUn1.js";import"./utils-vendor-DmorxLnX.js";import"./supabase-7WG3J4rU.js";import"./Skeleton-D0WWmlnq.js";const O=({submission:s,isSyncing:m})=>{if(s.status!=="verified"||!s.portalSyncStatus)return e.jsx("span",{className:"text-sm font-medium text-muted",children:"-"});if(m)return e.jsxs("div",{className:"flex items-center gap-2 text-sm text-muted",children:[e.jsx(R,{className:"h-4 w-4 animate-spin"})," Syncing..."]});const g=s.uan?.hasPreviousPf,h=[{label:"Aadhaar",verified:s.personal?.verifiedStatus?.idProofNumber},{label:"Bank",verified:s.bank?.verifiedStatus?.accountNumber},...g?[{label:"UAN",verified:s.uan?.verifiedStatus?.uanNumber}]:[]],r=s.portalSyncStatus==="synced"||s.portalSyncStatus==="failed",j=({label:t,status:f})=>{const l=r&&f===!0,o=r&&f===!1,p=l?V:o?F:_,c=l?"text-green-600":o?"text-red-600":"text-muted",b=l?"Verified":o?"Failed":"Pending Verification";return e.jsxs("div",{className:`flex items-center gap-1.5 text-xs font-medium ${c}`,title:b,children:[e.jsx(p,{className:"h-4 w-4"}),e.jsx("span",{children:t})]})};return e.jsx("div",{className:"flex flex-row gap-3 items-center",children:h.map(t=>e.jsx(j,{label:t.label,status:t.verified},t.label))})},ee=()=>{const[s,m]=n.useState([]),[g,h]=n.useState(!0),[r,j]=n.useState("all"),[t,f]=n.useState(""),[l,o]=n.useState(null),[p,c]=n.useState(null),b=z(),L=q("(max-width: 767px)"),v=n.useCallback(async()=>{h(!0);try{const a=await y.getVerificationSubmissions(r==="all"?void 0:r);m(a)}catch(a){console.error("Failed to fetch submissions",a)}finally{h(!1)}},[r]);n.useEffect(()=>{v();const a=C.channel("submissions-feed").on("postgres_changes",{event:"*",schema:"public",table:"onboarding_submissions"},i=>{console.log("Real-time change received!",i),v()}).subscribe();return()=>{C.removeChannel(a)}},[v]);const N=n.useMemo(()=>s?s.filter(a=>a.personal.firstName?.toLowerCase().includes(t.toLowerCase())||a.personal.lastName?.toLowerCase().includes(t.toLowerCase())||a.personal.employeeId?.toLowerCase().includes(t.toLowerCase())||a.organizationName?.toLowerCase().includes(t.toLowerCase())):[],[s,t]),S=async(a,i)=>{m(x=>x.map(d=>d.id===i?{...d,status:a==="approve"?"verified":"rejected",portalSyncStatus:a==="approve"?"pending_sync":void 0}:d));try{a==="approve"?await y.verifySubmission(i):await y.requestChanges(i,"Changes requested by admin.")}catch(x){console.error(`Failed to ${a} submission`,x)}},T=async a=>{o(a);try{const i=await y.syncPortals(a);m(x=>x.map(d=>d.id===a?i:d)),i.portalSyncStatus==="synced"?c({message:"Portals synced successfully!",type:"success"}):c({message:"Portal sync failed. Check details.",type:"error"})}catch{c({message:"An error occurred during sync.",type:"error"})}finally{o(null)}},P=["all","pending","verified","rejected"],w=r==="verified"?4:5;return e.jsxs("div",{className:"p-4 border-0 shadow-none md:bg-card md:p-6 md:rounded-xl md:shadow-card",children:[p&&e.jsx($,{message:p.message,type:p.type,onDismiss:()=>c(null)}),e.jsx("h2",{className:"text-2xl font-semibold text-primary-text mb-6",children:"Onboarding Forms"}),e.jsxs("div",{className:"flex flex-col sm:flex-row justify-between items-center mb-6 gap-4",children:[e.jsx("div",{className:"w-full sm:w-auto border-b border-border",children:e.jsx("nav",{className:"-mb-px flex space-x-6","aria-label":"Tabs",children:P.map(a=>e.jsx("button",{onClick:()=>j(a),className:`${r===a?"border-accent text-accent-dark":"border-transparent text-muted hover:text-accent-dark hover:border-accent"} whitespace-nowrap py-3 px-1 border-b-2 font-medium text-sm capitalize`,children:a},a))})}),e.jsxs("div",{className:"relative w-full sm:w-auto sm:max-w-xs",children:[e.jsx("div",{className:"absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none",children:e.jsx(I,{className:"h-5 w-5 text-gray-400"})}),e.jsx("input",{id:"onboarding-search",name:"onboardingSearch",type:"text",placeholder:"Search by name, ID, site...","aria-label":"Search onboarding forms",value:t,onChange:a=>f(a.target.value),className:"form-input block w-full !pl-10 pr-3 py-2 border-border rounded-lg leading-5 placeholder-gray-500 focus:outline-none focus:placeholder-gray-400 focus:ring-1 focus:ring-accent focus:border-accent sm:text-sm"})]})]}),e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"min-w-full divide-y divide-border responsive-table",children:[e.jsx("thead",{className:"bg-page",children:e.jsxs("tr",{children:[e.jsx("th",{scope:"col",className:"px-6 py-3 text-left text-xs font-medium text-muted uppercase tracking-wider",children:"Employee"}),e.jsx("th",{scope:"col",className:"px-6 py-3 text-left text-xs font-medium text-muted uppercase tracking-wider",children:"Site"}),r!=="verified"&&e.jsx("th",{scope:"col",className:"px-6 py-3 text-left text-xs font-medium text-muted uppercase tracking-wider",children:"Status"}),e.jsx("th",{scope:"col",className:"px-6 py-3 text-left text-xs font-medium text-muted uppercase tracking-wider",children:"Portal Verification"}),e.jsx("th",{scope:"col",className:"px-6 py-3 text-left text-xs font-medium text-muted uppercase tracking-wider",children:"Actions"})]})}),e.jsx("tbody",{className:"bg-card md:divide-y-0",children:g?L?e.jsx("tr",{children:e.jsx("td",{colSpan:w,children:e.jsx(k,{rows:3,cols:4,isMobile:!0})})}):e.jsx(k,{rows:5,cols:w}):N.length===0?e.jsx("tr",{children:e.jsx("td",{colSpan:w,className:"text-center py-10 text-muted",children:"No submissions found."})}):N.map(a=>e.jsxs("tr",{className:a.requiresManualVerification?"bg-orange-50":"",children:[e.jsx("td",{"data-label":"Employee",className:"px-6 py-4 whitespace-nowrap",children:e.jsxs("div",{className:"flex items-center",children:[a.requiresManualVerification&&e.jsx("span",{title:"Manual verification required due to data mismatch.",children:e.jsx(M,{className:"h-4 w-4 text-orange-500 mr-2 flex-shrink-0"})}),e.jsxs("div",{children:[e.jsxs("div",{className:"text-sm font-medium text-primary-text",children:[a.personal.firstName," ",a.personal.lastName]}),e.jsx("div",{className:"text-sm text-muted",children:a.personal.employeeId})]})]})}),e.jsx("td",{"data-label":"Site",className:"px-6 py-4 whitespace-nowrap text-sm font-medium text-primary-text",children:a.organizationName}),r!=="verified"&&e.jsx("td",{"data-label":"Status",className:"px-6 py-4 whitespace-nowrap",children:e.jsx(A,{status:a.status})}),e.jsx("td",{"data-label":"Portal Verification",className:"px-6 py-4 whitespace-nowrap",children:e.jsx(O,{submission:a,isSyncing:l===a.id})}),e.jsx("td",{"data-label":"Actions",className:"px-6 py-4 whitespace-nowrap text-sm font-medium",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(u,{variant:"icon",size:"sm",onClick:()=>b(`/onboarding/add/personal?id=${a.id}`),title:"View Details","aria-label":`View details for ${a.personal.firstName}`,children:e.jsx(D,{className:"h-4 w-4"})}),e.jsx(u,{variant:"icon",size:"sm",onClick:()=>b(`/onboarding/pdf/${a.id}`),title:"Download Forms","aria-label":`Download forms for ${a.personal.firstName}`,children:e.jsx(E,{className:"h-4 w-4"})}),a.status==="pending"&&e.jsxs(e.Fragment,{children:[e.jsx(u,{variant:"icon",size:"sm",onClick:()=>S("approve",a.id),title:"Verify","aria-label":`Verify submission for ${a.personal.firstName}`,children:e.jsx(V,{className:"h-4 w-4 text-green-600"})}),e.jsx(u,{variant:"icon",size:"sm",onClick:()=>S("reject",a.id),title:"Request Changes","aria-label":`Request changes for ${a.personal.firstName}`,children:e.jsx(F,{className:"h-4 w-4 text-red-600"})})]}),a.status==="verified"&&(a.portalSyncStatus==="pending_sync"||a.portalSyncStatus==="failed")&&e.jsxs(u,{variant:"outline",size:"sm",onClick:()=>T(a.id),isLoading:l===a.id,title:"Push data to government portals",children:[l!==a.id&&e.jsx(B,{className:"h-4 w-4 mr-1"}),"Sync Portals"]})]})})]},a.id))})]})})]})};export{ee as default};
