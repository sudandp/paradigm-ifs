import{k as W,u as X,a as Z,Y as ee,U as se,c as ae,o as ie,j as e,I as p,C as $,T as F,B as C,d as te,m as f,Q as T,e as u}from"./index-D5q3SS3D.js";import{u as re,l as le,b as y}from"./react-vendor-BUaIliXj.js";import{u as ne}from"./taskStore-CL2IH4rv.js";import{S as g}from"./Select-Dz12MdxG.js";import{D as q}from"./DatePicker-D2ulOwJx.js";import{al as M}from"./ui-vendor-B8EvWqdc.js";import"./pdf-vendor-CB_F1AVu.js";import"./capacitor-vendor-CqiIOUn1.js";import"./utils-vendor-DmorxLnX.js";import"./supabase-7WG3J4rU.js";const oe=te({name:u().required("Task name is required"),description:u().required("Description is required"),dueDate:u().required("A due date is required").nullable(),priority:u().oneOf(["Low","Medium","High"]).required("Priority is required"),assignedToId:u().required("An assignee is required"),escalationLevel1UserId:u().optional(),escalationLevel1DurationDays:T().when("escalationLevel1UserId",{is:i=>!!i,then:i=>i.required("Duration is required").min(0).typeError("Must be a number"),otherwise:i=>i.optional().nullable()}),escalationLevel2UserId:u().optional(),escalationLevel2DurationDays:T().when("escalationLevel2UserId",{is:i=>!!i,then:i=>i.required("Duration is required").min(0).typeError("Must be a number"),otherwise:i=>i.optional().nullable()}),escalationEmail:u().email("Must be a valid email address").optional(),escalationEmailDurationDays:T().when("escalationEmail",{is:i=>!!i,then:i=>i.required("Duration is required").min(0).typeError("Must be a number"),otherwise:i=>i.optional().nullable()})}).defined(),Ne=()=>{const i=re(),{id:m}=le(),d=!!m,P=W("(max-width: 767px)"),{createTask:A,updateTask:H,tasks:E}=ne(),{user:b}=X(),[j,L]=y.useState(!1),[v,S]=y.useState([]),[x,h]=y.useState(null),{permissions:_}=Z(),{fetchNotifications:B}=ee(),{theme:O}=se(),s=O==="dark",{register:n,handleSubmit:D,formState:{errors:t},reset:I,control:U,watch:k}=ae({resolver:ie(oe),defaultValues:{priority:"Medium",assignedToId:"",dueDate:null}}),Q=k("escalationLevel1UserId"),Y=k("escalationLevel2UserId"),R=k("escalationEmail");y.useEffect(()=>{(async()=>{try{if(b)if(["admin","hr","developer"].includes(b.role)){const c=await f.getUsers();S(c)}else{const c=await f.getTeamMembers(b.id);S([b,...c])}if(d&&m){let o=E.find(c=>c.id===m);o||(o=(await f.getTasks()).find(N=>N.id===m)),o?I(o):(h({message:"Task not found.",type:"error"}),setTimeout(()=>i("/tasks"),2e3))}}catch{h({message:"Failed to load data.",type:"error"})}})()},[m,d,E,I,i,b]);const w=async a=>{L(!0);try{const o=v.find(N=>N.id===a.assignedToId),c={...a,assignedToName:o?.name};if(d&&m?(await H(m,c),h({message:"Task updated successfully!",type:"success"})):(await A(c),h({message:"Task created successfully.",type:"success"})),o){const K=(_[o.role]||[]).includes("manage_tasks")?"/tasks":"/onboarding/tasks";(!d||d&&m)&&(await f.createNotification({userId:o.id,type:"task_assigned",message:`You have been assigned a new task: "${a.name}"`,linkTo:K}),B())}setTimeout(()=>i("/tasks"),1500)}catch{h({message:"Failed to save task.",type:"error"})}finally{L(!1)}},V="!bg-[#041b0f] !border-white/10 !text-white !placeholder-gray-500 !rounded-xl focus:!ring-emerald-500 focus:!border-emerald-500",z="text-gray-300 font-medium mb-1.5 block",G="",J="block text-sm font-medium text-muted mb-1",r=s?V:G,l=s?z:J;return P?e.jsxs("div",{className:`h-full flex flex-col ${s?"bg-[#041b0f] text-white":""}`,children:[e.jsx("header",{className:"p-4 flex-shrink-0 fo-mobile-header",children:e.jsx("h1",{children:d?"Edit Task":"Add Task"})}),e.jsx("main",{className:"flex-1 overflow-y-auto p-4",children:e.jsxs("div",{className:`${s?"bg-[#152b1b] border border-white/10":"bg-card"} rounded-2xl p-6 space-y-6`,children:[e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:`inline-block p-3 rounded-full mb-2 ${s?"bg-emerald-500/20":"bg-accent-light"}`,children:e.jsx(M,{className:`h-8 w-8 ${s?"text-emerald-400":"text-accent-dark"}`})}),e.jsx("h2",{className:`text-xl font-bold ${s?"text-white":"text-primary-text"}`,children:d?"Edit Task":"Create New Task"}),e.jsx("p",{className:"text-sm text-gray-400",children:"Assign tasks and set deadlines."})]}),e.jsxs("form",{onSubmit:D(w),className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{htmlFor:"name",className:l,children:"Task Name"}),e.jsx(p,{id:"name",registration:n("name"),error:t.name?.message,className:r,placeholder:s?"Enter task name":""})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"description",className:l,children:"Description"}),e.jsx("textarea",{id:"description",rows:4,...n("description"),className:s?`w-full ${r} px-3 py-3 outline-none`:`mt-1 bg-card border ${t.description?"border-red-500":"border-border"} rounded-lg px-3 py-2.5 w-full sm:text-sm focus:ring-1 focus:ring-accent`,placeholder:s?"Enter task description":""}),t.description&&e.jsx("p",{className:"mt-1 text-xs text-red-600",children:t.description.message})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:l,children:"Due Date"}),e.jsx($,{name:"dueDate",control:U,render:({field:a})=>e.jsx(q,{label:"",id:"dueDate",value:a.value,onChange:a.onChange,error:t.dueDate?.message,minDate:new Date,className:r})})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"priority",className:l,children:"Priority"}),e.jsxs(g,{id:"priority",registration:n("priority"),error:t.priority?.message,className:r,children:[e.jsx("option",{value:"Low",className:s?"bg-[#041b0f]":"",children:"Low"}),e.jsx("option",{value:"Medium",className:s?"bg-[#041b0f]":"",children:"Medium"}),e.jsx("option",{value:"High",className:s?"bg-[#041b0f]":"",children:"High"})]})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"assignedToId",className:l,children:"Assign To"}),e.jsxs(g,{id:"assignedToId",registration:n("assignedToId"),error:t.assignedToId?.message,className:r,children:[e.jsx("option",{value:"",className:s?"bg-[#041b0f]":"",children:"Select User"}),v.map(a=>e.jsxs("option",{value:a.id,className:s?"bg-[#041b0f]":"",children:[a.name," (",a.role.replace(/_/g," "),")"]},a.id))]})]})]})]})]})}),e.jsxs("footer",{className:"p-4 flex-shrink-0 flex items-center gap-4",children:[e.jsx("button",{type:"button",onClick:()=>i("/tasks"),disabled:j,className:"fo-btn-secondary px-6",children:"Cancel"}),e.jsx("button",{type:"submit",onClick:D(w),disabled:j,className:"fo-btn-primary flex-1",children:j?"Saving...":d?"Save Changes":"Create Task"})]}),x&&e.jsx(F,{message:x.message,type:x.type,onDismiss:()=>h(null)})]}):e.jsxs("div",{className:`p-4 md:p-6 ${s?"text-white":""}`,children:[e.jsxs("div",{className:`${s?"bg-[#152b1b] border border-white/10":"bg-card"} p-8 rounded-xl shadow-card w-full`,children:[e.jsxs("div",{className:"flex items-center mb-6",children:[e.jsx("div",{className:`p-3 rounded-full mr-4 ${s?"bg-emerald-500/20":"bg-accent-light"}`,children:e.jsx(M,{className:`h-8 w-8 ${s?"text-emerald-400":"text-accent-dark"}`})}),e.jsxs("div",{children:[e.jsx("h2",{className:`text-2xl font-bold ${s?"text-white":"text-primary-text"}`,children:d?"Edit Task":"Create New Task"}),e.jsx("p",{className:s?"text-gray-400":"text-muted",children:"Assign tasks and set deadlines."})]})]}),e.jsxs("form",{onSubmit:D(w),className:"space-y-6",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:[e.jsxs("div",{className:"md:col-span-2",children:[e.jsx("label",{htmlFor:"name",className:l,children:"Task Name"}),e.jsx(p,{id:"name",registration:n("name"),error:t.name?.message,className:r,placeholder:s?"Enter task name":""})]}),e.jsxs("div",{className:"md:col-span-2",children:[e.jsx("label",{htmlFor:"description",className:l,children:"Description"}),e.jsx("textarea",{id:"description",rows:4,...n("description"),className:s?`w-full ${r} px-3 py-3 outline-none`:`mt-1 bg-card border ${t.description?"border-red-500":"border-border"} rounded-lg px-3 py-2.5 w-full sm:text-sm focus:ring-1 focus:ring-accent`,placeholder:s?"Enter task description":""}),t.description&&e.jsx("p",{className:"mt-1 text-xs text-red-600",children:t.description.message})]}),e.jsxs("div",{children:[e.jsx("label",{className:l,children:"Due Date"}),e.jsx($,{name:"dueDate",control:U,render:({field:a})=>e.jsx(q,{label:"",id:"dueDate",value:a.value,onChange:a.onChange,error:t.dueDate?.message,minDate:new Date,className:r})})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"priority",className:l,children:"Priority"}),e.jsxs(g,{id:"priority",registration:n("priority"),error:t.priority?.message,className:r,children:[e.jsx("option",{value:"Low",className:s?"bg-[#041b0f]":"",children:"Low"}),e.jsx("option",{value:"Medium",className:s?"bg-[#041b0f]":"",children:"Medium"}),e.jsx("option",{value:"High",className:s?"bg-[#041b0f]":"",children:"High"})]})]}),e.jsxs("div",{className:"md:col-span-2",children:[e.jsx("label",{htmlFor:"assignedToId",className:l,children:"Assign To"}),e.jsxs(g,{id:"assignedToId",registration:n("assignedToId"),error:t.assignedToId?.message,className:r,children:[e.jsx("option",{value:"",className:s?"bg-[#041b0f]":"",children:"Select User"}),v.map(a=>e.jsxs("option",{value:a.id,className:s?"bg-[#041b0f]":"",children:[a.name," (",a.role.replace(/_/g," "),")"]},a.id))]})]})]}),e.jsxs("div",{className:`pt-6 border-t ${s?"border-white/10":"border-border"}`,children:[e.jsx("h4",{className:`text-lg font-semibold ${s?"text-white":"text-primary-text"} mb-1`,children:"Escalation Matrix (Optional)"}),e.jsx("p",{className:`text-sm ${s?"text-gray-400":"text-muted"} mb-6`,children:"Define who gets notified if this task becomes overdue."}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:[e.jsxs("div",{children:[e.jsx("label",{htmlFor:"escalationLevel1UserId",className:l,children:"Escalation Level 1"}),e.jsxs(g,{id:"escalationLevel1UserId",registration:n("escalationLevel1UserId"),error:t.escalationLevel1UserId?.message,className:r,children:[e.jsx("option",{value:"",className:s?"bg-[#041b0f]":"",children:"Select User"}),v.map(a=>e.jsx("option",{value:a.id,className:s?"bg-[#041b0f]":"",children:a.name},a.id))]})]}),Q&&e.jsxs("div",{children:[e.jsx("label",{htmlFor:"escalationLevel1DurationDays",className:l,children:"Days until L1 Escalation"}),e.jsx(p,{id:"escalationLevel1DurationDays",type:"number",registration:n("escalationLevel1DurationDays"),error:t.escalationLevel1DurationDays?.message,className:r})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"escalationLevel2UserId",className:l,children:"Escalation Level 2"}),e.jsxs(g,{id:"escalationLevel2UserId",registration:n("escalationLevel2UserId"),error:t.escalationLevel2UserId?.message,className:r,children:[e.jsx("option",{value:"",className:s?"bg-[#041b0f]":"",children:"Select User"}),v.map(a=>e.jsx("option",{value:a.id,className:s?"bg-[#041b0f]":"",children:a.name},a.id))]})]}),Y&&e.jsxs("div",{children:[e.jsx("label",{htmlFor:"escalationLevel2DurationDays",className:l,children:"Days until L2 Escalation"}),e.jsx(p,{id:"escalationLevel2DurationDays",type:"number",registration:n("escalationLevel2DurationDays"),error:t.escalationLevel2DurationDays?.message,className:r})]}),e.jsxs("div",{className:"md:col-span-2",children:[e.jsx("label",{htmlFor:"escalationEmail",className:l,children:"Final Escalation Email"}),e.jsx(p,{id:"escalationEmail",type:"email",registration:n("escalationEmail"),error:t.escalationEmail?.message,className:r,placeholder:s?"Enter email address":""})]}),R&&e.jsxs("div",{className:"md:col-span-2",children:[e.jsx("label",{htmlFor:"escalationEmailDurationDays",className:l,children:"Days until Final Escalation"}),e.jsx(p,{id:"escalationEmailDurationDays",type:"number",registration:n("escalationEmailDurationDays"),error:t.escalationEmailDurationDays?.message,className:r})]})]})]}),e.jsxs("div",{className:"mt-8 pt-6 border-t flex justify-end gap-3",children:[e.jsx(C,{type:"button",onClick:()=>i("/tasks"),variant:"secondary",disabled:j,children:"Cancel"}),e.jsx(C,{type:"submit",isLoading:j,children:d?"Save Changes":"Create Task"})]})]})]}),x&&e.jsx(F,{message:x.message,type:x.type,onDismiss:()=>h(null)})]})};export{Ne as default};
