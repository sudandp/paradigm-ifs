import{n as Y,k as Z,m as A,j as e,T as ee,B as p,I as B}from"./index-D5q3SS3D.js";import{b as n}from"./react-vendor-BUaIliXj.js";import{A as se}from"./AdminPageHeader-wINx_pXe.js";import{d as te}from"./index-BKlf32TQ.js";import{S as D}from"./StatCard-Dc05kpHM.js";import{a2 as C,$ as ae,f as ne,p as re,C as V,at as oe,ao as le,aJ as ie,I as O,z as ce}from"./ui-vendor-B8EvWqdc.js";import{v as k,f as u,u as de}from"./utils-vendor-DmorxLnX.js";import"./pdf-vendor-CB_F1AVu.js";import"./capacitor-vendor-CqiIOUn1.js";import"./supabase-7WG3J4rU.js";const me=({item:o})=>{const[c,m]=n.useState(!1);return e.jsxs("div",{className:"bg-card rounded-xl border border-border p-4",children:[e.jsxs("div",{className:"flex justify-between items-start",children:[e.jsxs("div",{children:[e.jsx("p",{className:"font-semibold text-primary-text",children:o.employeeName}),e.jsx("p",{className:"text-sm text-muted",children:o.employeeId}),e.jsx("p",{className:"text-xs text-muted mt-1",children:u(new Date(o.enrollmentDate.replace(/-/g,"/")),"dd MMM, yyyy")})]}),e.jsx("div",{className:"text-right",children:e.jsxs("p",{className:"text-lg font-bold text-accent",children:["₹",o.totalCost.toLocaleString("en-IN",{minimumFractionDigits:2,maximumFractionDigits:2})]})})]}),o.breakdown.length>0&&e.jsxs("div",{className:"mt-3 pt-3 border-t border-border",children:[e.jsxs("button",{onClick:()=>m(!c),className:"flex justify-between items-center w-full text-sm text-muted",children:[e.jsx("span",{children:"Details"}),e.jsx(V,{className:`h-4 w-4 transition-transform ${c?"rotate-180":""}`})]}),c&&e.jsx("ul",{className:"list-disc list-inside space-y-1 mt-2 text-sm text-muted animate-fade-in-down",children:o.breakdown.map((h,i)=>e.jsxs("li",{children:[h.name,": ₹",(h.cost||0).toFixed(2)]},i))})]})]})},xe=()=>e.jsx("div",{className:"space-y-4",children:[...Array(3)].map((o,c)=>e.jsxs("div",{className:"bg-card rounded-xl border border-border p-4 space-y-3 skeleton-pulse",children:[e.jsxs("div",{className:"flex justify-between items-start",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx("div",{className:"h-5 w-32 bg-gray-300 rounded"}),e.jsx("div",{className:"h-4 w-24 bg-gray-300 rounded"})]}),e.jsx("div",{className:"h-6 w-20 bg-gray-300 rounded"})]}),e.jsx("div",{className:"h-4 w-1/4 bg-gray-300 rounded mt-2"})]},c))}),we=()=>{const[o,c]=n.useState([]),[m,h]=n.useState(!0),{verificationCosts:i,updateVerificationCosts:$}=Y(),[g,f]=n.useState(i),[z,_]=n.useState(!1),[x,S]=n.useState([{startDate:k(new Date,29),endDate:new Date,key:"selection"}]),[F,E]=n.useState("Last 30 Days"),[G,j]=n.useState(!1),N=n.useRef(null),[v,y]=n.useState(null),M=n.useRef(null),J=Z("(max-width: 767px)"),I=n.useCallback(async()=>{const s=x[0]?.startDate,t=x[0]?.endDate;if(!(!s||!t)){h(!0);try{const a=await A.getVerificationCostBreakdown(u(s,"yyyy-MM-dd"),u(t,"yyyy-MM-dd"));c(a)}catch(a){console.error("Failed to fetch cost breakdown",a),y({message:"Failed to load verification data.",type:"error"})}finally{h(!1)}}},[x]);n.useEffect(()=>{I()},[I]),n.useEffect(()=>{const s=t=>{N.current&&!N.current.contains(t.target)&&j(!1)};return document.addEventListener("mousedown",s),()=>document.removeEventListener("mousedown",s)},[]),n.useEffect(()=>{f(i)},[i]),n.useEffect(()=>{_(JSON.stringify(g)!==JSON.stringify(i))},[g,i]);const L=(s,t,a)=>{f(d=>d.map(r=>r.id===s?t==="cost"?{...r,cost:parseFloat(a)||0}:{...r,name:a}:r))},U=()=>{f(s=>[...s,{id:`new_${Date.now()}`,name:"New Verification Type",cost:0}])},H=s=>{f(t=>t.filter(a=>a.id!==s))},q=()=>{$(g),y({message:"Costs updated successfully!",type:"success"})},l=n.useMemo(()=>{const s=new Map(i.map(t=>[t.name,t.cost]));return o.map(t=>{const a=t.breakdown.map(r=>({...r,cost:Number(s.get(r.name))||0})),d=a.reduce((r,P)=>r+(P.cost||0)*P.count,0);return{...t,breakdown:a,totalCost:d}})},[o,i]),b=n.useMemo(()=>{const s=l.length,t=l.reduce((d,r)=>d+r.totalCost,0),a=s>0?t/s:0;return{totalEmployees:s,totalCost:t,averageCost:a}},[l]),R=n.useMemo(()=>{const s={};return l.forEach(t=>{t.breakdown.forEach(a=>{s[a.name]||(s[a.name]={count:0,total:0}),s[a.name].count+=a.count,s[a.name].total+=(a.cost||0)*a.count})}),Object.entries(s).map(([t,a])=>({name:t,...a}))},[l]),[w,T]=n.useState(!1),Q=async s=>{{const t=M.current;if(!t){y({message:"Could not find report to export.",type:"error"});return}T(!0);try{const a=t.outerHTML,d={margin:.5,filename:`Cost_Analysis_Report_${u(x[0].startDate,"yyyy-MM-dd")}_to_${u(x[0].endDate,"yyyy-MM-dd")}.pdf`,image:{type:"jpeg",quality:.98},html2canvas:{scale:2,useCORS:!0},jsPDF:{unit:"in",format:"a4",orientation:"portrait"}};await A.generatePdf(a,d)}catch(a){console.error("PDF generation failed:",a),y({message:"Failed to generate PDF.",type:"error"})}finally{T(!1)}}},K=[{label:"Today",value:"Today"},{label:"Last 7 Days",value:"Last 7 Days"},{label:"Last 30 Days",value:"Last 30 Days"}],W=s=>{const t=new Date;let a=new Date;s==="Today"?a=de():s==="Last 7 Days"?a=k(t,6):s==="Last 30 Days"&&(a=k(t,29)),E(s),S([{startDate:a,endDate:t,key:"selection"}]),j(!1)},X=s=>{S([s.selection])};return e.jsxs("div",{className:"p-4 space-y-6",children:[v&&e.jsx(ee,{message:v.message,type:v.type,onDismiss:()=>y(null)}),e.jsx(se,{title:"Verification Costing",children:e.jsx("div",{className:"w-full sm:w-auto",children:e.jsxs("div",{className:"grid grid-cols-2 gap-2 sm:flex sm:items-center sm:flex-wrap",children:[e.jsxs(p,{onClick:()=>Q(),variant:"outline",size:"sm",disabled:w||m||l.length===0,children:[w?e.jsx(C,{className:"mr-2 h-4 w-4 animate-spin"}):e.jsx(ae,{className:"mr-2 h-4 w-4"}),w?"Generating PDF...":"Download PDF"]}),K.map(s=>e.jsx(p,{variant:F===s.value?"outline":"secondary",size:"sm",onClick:()=>W(s.value),className:"justify-center",children:s.label},s.value)),e.jsxs("div",{className:"relative",ref:N,children:[e.jsxs(p,{variant:F==="Custom"?"outline":"secondary",size:"sm",onClick:()=>{j(s=>!s),E("Custom")},className:"w-full justify-center",children:[e.jsx(ne,{className:"mr-2 h-4 w-4"}),e.jsx("span",{children:"Custom Range"})]}),G&&e.jsx("div",{className:"absolute top-full right-0 mt-2 z-10 bg-card border rounded-lg shadow-lg",children:e.jsx(te.DateRangePicker,{onChange:X,ranges:x,maxDate:new Date,direction:"horizontal"})})]})]})})}),e.jsx("div",{className:"bg-card p-4 md:p-6 rounded-xl shadow-card",children:e.jsxs("details",{className:"group",children:[e.jsxs("summary",{className:"cursor-pointer flex justify-between items-center list-none",children:[e.jsxs("h3",{className:"text-lg font-semibold flex items-center gap-2 text-primary-text",children:[e.jsx(re,{className:"h-5 w-5 text-muted"})," Cost Configuration"]}),e.jsx(V,{className:"transition-transform group-open:rotate-180"})]}),e.jsxs("div",{className:"mt-4 pt-4 border-t",children:[e.jsx("div",{className:"space-y-2",children:g.map(s=>e.jsxs("div",{className:"grid grid-cols-12 gap-2 items-center",children:[e.jsx("div",{className:"col-span-12 sm:col-span-6",children:e.jsx(B,{"aria-label":"Cost Item Name",value:s.name,onChange:t=>L(s.id,"name",t.target.value),className:"!py-2"})}),e.jsx("div",{className:"col-span-8 sm:col-span-4",children:e.jsx(B,{"aria-label":"Cost Value",type:"number",step:"0.01",value:s.cost||0,onChange:t=>L(s.id,"cost",t.target.value),className:"!py-2"})}),e.jsx("div",{className:"col-span-4 sm:col-span-2 text-right",children:e.jsx(p,{variant:"icon",onClick:()=>H(s.id),"aria-label":`Remove ${s.name}`,children:e.jsx(oe,{className:"h-4 w-4 text-red-500"})})})]},s.id))}),e.jsxs("div",{className:"mt-6 flex justify-between items-center",children:[e.jsxs(p,{type:"button",variant:"outline",size:"sm",onClick:U,children:[e.jsx(le,{className:"mr-2 h-4"})," Add Cost Item"]}),e.jsxs(p,{onClick:q,disabled:!z,children:[e.jsx(ie,{className:"mr-2 h-4"})," Save Costs"]})]})]})]})}),e.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6",children:[e.jsx(D,{title:"Total Verification Cost",value:`₹${b.totalCost.toLocaleString("en-IN",{minimumFractionDigits:2,maximumFractionDigits:2})}`,icon:O}),e.jsx(D,{title:"Total Verified Employees",value:b.totalEmployees,icon:ce}),e.jsx(D,{title:"Avg. Cost Per Employee",value:`₹${b.averageCost.toLocaleString("en-IN",{minimumFractionDigits:2,maximumFractionDigits:2})}`,icon:O})]}),e.jsxs("div",{className:"border-0 shadow-none md:bg-card md:p-6 md:rounded-xl md:shadow-card",children:[e.jsx("h3",{className:"text-lg font-semibold mb-4 text-primary-text",children:"Verification Usage Breakdown"}),m?e.jsx("div",{className:"flex justify-center items-center h-24",children:e.jsx(C,{className:"h-6 w-6 animate-spin text-muted"})}):R.length>0?e.jsx("div",{className:"grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4",children:R.map(s=>e.jsxs("div",{className:"bg-page p-4 rounded-lg border",children:[e.jsx("p",{className:"text-sm font-medium text-muted",children:s.name}),e.jsx("p",{className:"text-2xl font-bold text-primary-text",children:s.count}),e.jsxs("p",{className:"text-sm font-semibold text-accent-dark",children:["Total: ₹",s.total.toLocaleString("en-IN",{minimumFractionDigits:2,maximumFractionDigits:2})]})]},s.name))}):e.jsx("p",{className:"text-center text-muted py-8",children:"No verification data for this period."})]}),e.jsxs("div",{className:"border-0 shadow-none md:bg-card md:p-6 md:rounded-xl md:shadow-card",children:[e.jsx("div",{className:"flex justify-between items-center",children:e.jsx("h3",{className:"text-lg font-semibold text-primary-text",children:"Detailed Report"})}),e.jsx("div",{ref:M,className:"mt-4 pt-4 border-t border-border",children:J?m?e.jsx(xe,{}):l.length===0?e.jsx("p",{className:"text-center text-muted py-8",children:"No report data for this period."}):e.jsx("div",{className:"space-y-4",children:l.map(s=>e.jsx(me,{item:s},s.id))}):e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"min-w-full divide-y divide-border responsive-table",children:[e.jsx("thead",{className:"bg-page",children:e.jsxs("tr",{children:[e.jsx("th",{scope:"col",className:"px-6 py-3 text-left text-xs font-medium text-muted uppercase",children:"Employee"}),e.jsx("th",{scope:"col",className:"px-6 py-3 text-left text-xs font-medium text-muted uppercase",children:"Enrollment Date"}),e.jsx("th",{scope:"col",className:"px-6 py-3 text-left text-xs font-medium text-muted uppercase",children:"Cost Breakdown"}),e.jsx("th",{scope:"col",className:"px-6 py-3 text-right text-xs font-medium text-muted uppercase",children:"Total Cost"})]})}),e.jsx("tbody",{children:m?e.jsx("tr",{children:e.jsx("td",{colSpan:4,className:"text-center py-10",children:e.jsx(C,{className:"h-6 w-6 animate-spin text-muted mx-auto"})})}):l.length===0?e.jsx("tr",{children:e.jsx("td",{colSpan:4,className:"text-center py-10 text-muted",children:"No report data for this period."})}):l.map(s=>e.jsxs("tr",{children:[e.jsxs("td",{"data-label":"Employee",className:"px-6 py-4",children:[e.jsx("div",{className:"font-medium text-primary-text",children:s.employeeName}),e.jsx("div",{className:"text-sm text-muted",children:s.employeeId})]}),e.jsx("td",{"data-label":"Enrollment Date",className:"px-6 py-4 whitespace-nowrap text-sm text-muted",children:u(new Date(s.enrollmentDate.replace(/-/g,"/")),"dd MMM, yyyy")}),e.jsx("td",{"data-label":"Cost Breakdown",className:"px-6 py-4 text-sm text-muted",children:e.jsxs("ul",{className:"list-disc list-inside space-y-1",children:[s.breakdown.map((t,a)=>e.jsxs("li",{children:[t.name,": ₹",(t.cost||0).toFixed(2)]},a)),s.breakdown.length===0&&e.jsx("li",{children:"No verifications performed"})]})}),e.jsxs("td",{"data-label":"Total Cost",className:"px-6 py-4 whitespace-nowrap text-right font-semibold text-primary-text",children:["₹",s.totalCost.toLocaleString("en-IN",{minimumFractionDigits:2,maximumFractionDigits:2})]})]},s.id))})]})})})]})]})};export{we as default};
