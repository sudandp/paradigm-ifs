import{j as e,I as xe,B as p,k as pe,n as fe,m as M,T as he}from"./index-D5q3SS3D.js";import{b as n,R as ge,k as Ne,u as we}from"./react-vendor-BUaIliXj.js";import{M as je}from"./Modal-CR2aBU6L.js";import{S as ve}from"./SiteConfigurationForm-2Dtz1cgY.js";import{S as ye}from"./Select-Dz12MdxG.js";import{a2 as Se,at as te,ao as T,au as Z,$ as ee,D as be,av as Ce,z as ke,p as De}from"./ui-vendor-B8EvWqdc.js";import{T as Me}from"./TableSkeleton-Bf5l1KHK.js";import{P as Ae}from"./Pagination-DXf7cs0z.js";import{n as Ie}from"./utils-vendor-DmorxLnX.js";import"./pdf-vendor-CB_F1AVu.js";import"./capacitor-vendor-CqiIOUn1.js";import"./supabase-7WG3J4rU.js";import"./UploadDocument-BAL6UInC.js";import"./CameraCaptureModal-DQDGRnEP.js";import"./DatePicker-D2ulOwJx.js";import"./Skeleton-D0WWmlnq.js";const Fe=({isOpen:h,onClose:d,siteName:y,details:v,isLoading:m,onSave:b,designations:o})=>{const[g,C]=n.useState([]),[w,F]=n.useState(!1),A=n.useRef(null),[O,D]=n.useState(!1),H=n.useMemo(()=>{const s=new Set;return o.filter(a=>s.has(a.designation)?!1:(s.add(a.designation),!0)).sort((a,i)=>a.designation.localeCompare(i.designation))},[o]),z=()=>{const s=A.current;if(s){const a=s.scrollHeight>s.clientHeight,i=s.scrollHeight-s.scrollTop<=s.clientHeight+1;D(a&&!i)}else D(!1)};n.useEffect(()=>{if(h){C(JSON.parse(JSON.stringify(v)));const s=setTimeout(z,150);return()=>clearTimeout(s)}},[v,h,m]);const L=(s,a,i)=>{const j=[...g],I=j[s];if(a==="count"){const u=Number(i);I.count=isNaN(u)?0:u}else I.designation=String(i);C(j)},k=()=>{C([...g,{designation:"",count:0,tempId:`new_${Date.now()}`}]),setTimeout(z,50)},_=s=>{const a=g.filter((i,j)=>j!==s);C(a),setTimeout(z,50)},$=async()=>{F(!0);const s=g.filter(a=>a.designation.trim()!=="").map(({tempId:a,...i})=>i);await b(s),F(!1)},R=ge.useMemo(()=>g.reduce((s,a)=>s+(Number(a.count)||0),0),[g]),V=s=>{if(s.key!=="ArrowUp"&&s.key!=="ArrowDown")return;const a=s.target;if(a.tagName!=="INPUT"&&a.tagName!=="SELECT")return;const i=a.getAttribute("data-row-index"),j=a.getAttribute("data-col-index");if(!i||!j||a.type==="number")return;s.preventDefault();const I=s.currentTarget,u=parseInt(i,10),P=parseInt(j,10),E=s.key==="ArrowUp"?u-1:u+1,f=I.querySelector(`[data-row-index="${E}"][data-col-index="${P}"]`);f&&f.focus()};return h?Ne.createPortal(e.jsx("div",{className:"fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-60 p-4",onClick:d,children:e.jsxs("div",{className:"bg-card rounded-xl shadow-card p-6 w-full max-w-sm sm:max-w-lg md:max-w-2xl m-4 animate-fade-in-scale flex flex-col",onClick:s=>s.stopPropagation(),children:[e.jsx("h3",{className:"text-lg font-bold text-primary-text",children:"Allocate Manpower"}),e.jsxs("p",{className:"text-sm text-muted mb-4",children:["For site: ",y]}),e.jsxs("div",{className:"flex-grow relative overflow-hidden",children:[e.jsx("div",{ref:A,onScroll:z,onKeyDown:V,className:"overflow-y-auto pr-2 min-h-[300px] max-h-[60vh] h-full",children:m?e.jsx("div",{className:"flex justify-center items-center h-full",children:e.jsx(Se,{className:"h-8 w-8 animate-spin text-accent"})}):e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"grid grid-cols-12 gap-4 sticky top-0 bg-page p-2 rounded-t-lg z-10",children:[e.jsx("div",{className:"col-span-6 font-medium text-sm text-muted",children:"Designation"}),e.jsx("div",{className:"col-span-4 font-medium text-sm text-muted",children:"Count"}),e.jsx("div",{className:"col-span-2"})]}),g.length>0?g.map((s,a)=>e.jsxs("div",{className:"grid grid-cols-12 gap-4 items-center",children:[e.jsx("div",{className:"col-span-6",children:e.jsxs(ye,{id:`designation-${a}`,value:s.designation,onChange:i=>L(a,"designation",i.target.value),className:"py-1.5","data-row-index":a,"data-col-index":0,"aria-label":`Designation for row ${a+1}`,children:[e.jsx("option",{value:"",children:"Select Designation"}),H.map(i=>e.jsx("option",{value:i.designation,children:i.designation},i.id))]})}),e.jsx("div",{className:"col-span-4",children:e.jsx(xe,{id:`count-${a}`,type:"number",value:s.count,onChange:i=>L(a,"count",i.target.value),min:"0",step:"0.01",className:"py-1.5","data-row-index":a,"data-col-index":1,"aria-label":`Count for row ${a+1}`})}),e.jsx("div",{className:"col-span-2 text-right",children:e.jsx(p,{variant:"icon",size:"sm",onClick:()=>_(a),title:"Remove row","aria-label":`Remove row ${a+1}`,children:e.jsx(te,{className:"h-4 w-4 text-red-500"})})})]},s.tempId||a)):e.jsx("p",{className:"text-center text-muted py-10",children:"No designations added yet. Click below to start."}),e.jsxs(p,{variant:"outline",size:"sm",onClick:k,className:"mt-4",children:[e.jsx(T,{className:"h-4 w-4 mr-2"})," Add Designation"]})]})}),O&&e.jsx("div",{className:"absolute bottom-0 left-0 right-2 h-16 bg-gradient-to-t from-card to-transparent pointer-events-none"})]}),e.jsxs("div",{className:"mt-6 pt-4 border-t flex justify-between items-center",children:[e.jsxs("div",{className:"font-semibold",children:["Total Manpower: ",e.jsx("span",{className:"text-accent",children:R.toFixed(2)})]}),e.jsxs("div",{className:"flex gap-3",children:[e.jsx(p,{onClick:d,variant:"secondary",disabled:w,children:"Cancel"}),e.jsx(p,{onClick:$,isLoading:w,disabled:m,children:"Save Changes"})]})]})]})}),document.getElementById("modal-root")):null},Q=["id","shortName","fullName","address","manpowerApprovedCount","reportingManagerName","managerName","fieldStaffNames","backendFieldStaffName"],ze=(h,d)=>{const y=d.join(","),v=h.map(m=>d.map(b=>{let o=m[b];return Array.isArray(o)&&(o=o.join(";")),o=o==null?"":String(o),o.includes(",")||o.includes('"')||o.includes(`
`)?`"${o.replace(/"/g,'""')}"`:o}).join(","));return[y,...v].join(`
`)},Re=h=>{const d=h.trim().replace(/\r/g,"").split(`
`);if(d.length<2)return[];const y=d[0].split(",").map(m=>m.trim().replace(/"/g,"")),v=[];for(let m=1;m<d.length;m++){const b={},o=d[m].match(new RegExp('(?<=,|^)(?:"(?:[^"]|"")*"|[^,]*)',"g"))||[];y.forEach((g,C)=>{let w=(o[C]||"").trim();w.startsWith('"')&&w.endsWith('"')&&(w=w.substring(1,w.length-1).replace(/""/g,'"')),b[g]=w}),v.push(b)}return v},Xe=()=>{const h=we(),[d,y]=n.useState([]),[v,m]=n.useState([]),[b,o]=n.useState([]),[g,C]=n.useState([]),[w,F]=n.useState(!0),[A,O]=n.useState(1),[D,H]=n.useState(20),[z,L]=n.useState(0),[k,_]=n.useState(""),[$,R]=n.useState(!1),[V,s]=n.useState(!1),[a,i]=n.useState(!1),[j,I]=n.useState(null),[u,P]=n.useState(null),[E,f]=n.useState(null),[se,ae]=n.useState([]),[ne,J]=n.useState(!1),U=n.useRef(null),W=pe("(max-width: 767px)"),{siteManagement:Ee}=fe(),q=n.useCallback(async()=>{F(!0);try{const[t,r,l,c]=await Promise.all([M.getOrganizations().catch(x=>(console.error("Failed to fetch organizations:",x),[])),M.getOrganizationStructure().catch(x=>(console.error("Failed to fetch organization structure:",x),[])),M.getSiteConfigurations().catch(x=>(console.error("Failed to fetch site configurations:",x),[])),M.getSiteStaffDesignations().catch(x=>(console.error("Failed to fetch site staff designations:",x),f({message:"Could not load designation list. Manpower editing may be affected.",type:"error"}),[]))]);y(t),L(t.length),m(l),C(c);const S=r.flatMap(x=>x.companies.flatMap(B=>B.entities.map(Y=>({...Y,companyName:B.name}))));o(S)}catch{f({message:"An unexpected error occurred while fetching data.",type:"error"})}finally{F(!1)}},[]);n.useEffect(()=>{O(1)},[D]),n.useEffect(()=>{q()},[q]);const ie=t=>{I(t),R(!0)},re=t=>{P(t),s(!0)},le=(t,r)=>{m(l=>{const c=[...l],S=c.findIndex(x=>x.organizationId===t);return S>-1?c[S]=r:c.push(r),c}),f({message:"Site configuration saved.",type:"success"}),R(!1)},oe=async()=>{u&&(y(t=>t.filter(r=>r.id!==u.id)),m(t=>t.filter(r=>r.organizationId!==u.id)),f({message:"Site deleted.",type:"success"}),s(!1))},ce=async t=>{P(t),J(!0),i(!0);try{const r=await M.getManpowerDetails(t.id);ae(r)}catch{f({message:"Could not load manpower details.",type:"error"})}finally{J(!1)}},de=async t=>{if(u)try{await M.updateManpowerDetails(u.id,t);const r=t.reduce((l,c)=>l+(Number(c.count)||0),0);y(l=>l.map(c=>c.id===u.id?{...c,manpowerApprovedCount:r}:c)),i(!1),f({message:"Manpower details updated successfully.",type:"success"})}catch{f({message:"Failed to save manpower details.",type:"error"})}},G=()=>{const t=ze(d,Q),r=new Blob([t],{type:"text/csv;charset=utf-8;"}),l=document.createElement("a");l.href=URL.createObjectURL(r),l.setAttribute("download","sites_export.csv"),document.body.appendChild(l),l.click(),document.body.removeChild(l),f({message:"Sites exported successfully.",type:"success"})},X=t=>{const r=t.target.files?.[0];if(!r)return;const l=new FileReader;l.onload=async c=>{try{const S=c.target?.result;if(!S)throw new Error("File is empty or could not be read.");const x=Re(S);if(x.length===0)throw new Error("No data rows found in the CSV file.");const B=Object.keys(x[0]);if(!Q.every(N=>B.includes(N)))throw new Error(`CSV is missing headers. Required: ${Q.join(", ")}`);const me=x.map(N=>({id:N.id,shortName:N.shortName,fullName:N.fullName,address:N.address,manpowerApprovedCount:parseFloat(N.manpowerApprovedCount)||0,reportingManagerName:N.reportingManagerName||void 0,managerName:N.managerName||void 0,fieldStaffNames:N.fieldStaffNames?N.fieldStaffNames.split(";").map(K=>K.trim()).filter(K=>K):void 0,backendFieldStaffName:N.backendFieldStaffName||void 0})),{count:ue}=await M.bulkUploadOrganizations(me);f({message:`${ue} sites imported/updated successfully.`,type:"success"}),q()}catch(S){f({message:S.message||"Failed to import CSV.",type:"error"})}finally{t.target&&(t.target.value="")}},l.readAsText(r)};return e.jsxs("div",{className:"p-4 md:p-6",children:[E&&e.jsx(he,{message:E.message,type:E.type,onDismiss:()=>f(null)}),e.jsx("input",{type:"file",ref:U,className:"hidden",accept:".csv",onChange:X}),e.jsx("input",{type:"file",ref:U,className:"hidden",accept:".csv",onChange:X}),$&&j&&e.jsx(ve,{isOpen:$,onClose:()=>R(!1),onSave:le,organization:j,allClients:b,initialData:v.find(t=>t.organizationId===j.id)}),u&&e.jsx(Fe,{isOpen:a,onClose:()=>i(!1),siteName:u.shortName,details:se,isLoading:ne,onSave:de,designations:g}),e.jsxs(je,{isOpen:V,onClose:()=>s(!1),onConfirm:oe,title:"Confirm Deletion",children:['Are you sure you want to delete the site "',u?.shortName,'"? This action cannot be undone.']}),e.jsxs("div",{className:"bg-card p-4 rounded-2xl mb-4",children:[e.jsxs("div",{className:"flex flex-col md:flex-row justify-between md:items-center gap-4 mb-6",children:[e.jsx("h2",{className:"text-2xl font-semibold text-primary-text",children:"Site Management"}),!W&&e.jsxs("div",{className:"flex-shrink-0 flex items-center flex-wrap gap-2",children:[e.jsxs(p,{variant:"outline",onClick:()=>h("/admin/sites/quick-add"),className:"mr-2 hover:bg-gray-100",children:[e.jsx(T,{className:"w-5 h-5 mr-2"}),"Quick Add Site"]}),e.jsxs(p,{onClick:()=>h("/admin/sites/add"),className:"mr-2 bg-gradient-to-r from-emerald-600 to-teal-600 hover:from-emerald-700 hover:to-teal-700 text-white shadow-lg hover:shadow-xl transition-all duration-300 transform hover:-translate-y-0.5",children:[e.jsx(T,{className:"w-5 h-5 mr-2"}),"Add Site"]}),e.jsxs(p,{variant:"outline",onClick:()=>U.current?.click(),className:"mr-2 hover:bg-gray-100",children:[e.jsx(Z,{className:"w-5 h-5 mr-2"}),"Import"]}),e.jsxs(p,{variant:"outline",onClick:G,className:"hover:bg-gray-100",children:[e.jsx(ee,{className:"w-5 h-5 mr-2"}),"Export"]})]})]}),W&&e.jsxs("div",{className:"flex flex-col gap-3 mb-4",children:[e.jsxs(p,{onClick:()=>h("/admin/sites/add"),className:"w-full justify-center bg-gradient-to-r from-emerald-600 to-teal-600 hover:from-emerald-700 hover:to-teal-700 text-white shadow-lg hover:shadow-xl transition-all duration-300 transform hover:-translate-y-0.5",children:[e.jsx(T,{className:"w-5 h-5 mr-2"}),"Add Site"]}),e.jsxs(p,{variant:"outline",onClick:()=>h("/admin/sites/quick-add"),className:"w-full justify-center hover:bg-gray-100",children:[e.jsx(T,{className:"w-5 h-5 mr-2"}),"Quick Add Site"]}),e.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[e.jsxs(p,{variant:"outline",onClick:()=>U.current?.click(),className:"w-full justify-center hover:bg-gray-100",children:[e.jsx(Z,{className:"w-5 h-5 mr-2"}),"Import"]}),e.jsxs(p,{variant:"outline",onClick:G,className:"w-full justify-center hover:bg-gray-100",children:[e.jsx(ee,{className:"w-5 h-5 mr-2"}),"Export"]})]})]})]}),e.jsx("div",{className:"bg-card rounded-2xl shadow-sm border border-border overflow-hidden",children:w?e.jsx("div",{className:"overflow-x-auto",children:e.jsx("table",{className:"w-full",children:e.jsx("tbody",{className:"divide-y divide-border",children:e.jsx(Me,{cols:5,rows:5})})})}):d.length===0?e.jsxs("div",{className:"p-8 text-center text-muted",children:[e.jsx(be,{className:"w-12 h-12 mx-auto mb-3 opacity-20"}),e.jsx("p",{children:"No sites found. Add a new site to get started."})]}):e.jsxs("div",{className:"overflow-x-auto",children:[e.jsxs("table",{className:"w-full",children:[e.jsx("thead",{className:"bg-muted/50",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-muted uppercase tracking-wider",children:"Site Name"}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-muted uppercase tracking-wider",children:"Location"}),e.jsx("th",{className:"px-6 py-3 text-center text-xs font-medium text-muted uppercase tracking-wider",children:"Manpower"}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-muted uppercase tracking-wider",children:"Key Staff"}),e.jsx("th",{className:"px-6 py-3 text-right text-xs font-medium text-muted uppercase tracking-wider",children:"Actions"})]})}),e.jsx("tbody",{className:"divide-y divide-border",children:d.filter(t=>k===""||t.shortName.toLowerCase().includes(k.toLowerCase())||t.fullName.toLowerCase().includes(k.toLowerCase())).slice((A-1)*D,A*D).map(t=>{v.find(c=>c.organizationId===t.id);const r=!!t.provisionalCreationDate,l=r&&t.provisionalCreationDate?90-Ie(new Date,new Date(t.provisionalCreationDate)):0;return e.jsxs("tr",{className:"hover:bg-muted/5 transition-colors",children:[e.jsx("td",{className:"px-6 py-4",children:e.jsx("div",{className:"flex items-center",children:e.jsxs("div",{children:[e.jsx("div",{className:"font-medium text-primary-text",children:t.shortName}),e.jsx("div",{className:"text-xs text-muted",children:t.fullName}),r&&e.jsxs("div",{className:`mt-1 text-xs px-2 py-0.5 rounded-full inline-flex items-center gap-1 ${l>30?"bg-yellow-100 text-yellow-800":"bg-red-100 text-red-800"}`,children:[e.jsx(Ce,{className:"w-3 h-3"}),l>0?`${l} days left`:"Expired"]})]})})}),e.jsx("td",{className:"px-6 py-4",children:e.jsx("div",{className:"text-sm text-primary-text max-w-xs truncate",title:t.address,children:t.address})}),e.jsx("td",{className:"px-6 py-4 text-center",children:e.jsx("span",{className:"inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800",children:t.manpowerApprovedCount||0})}),e.jsx("td",{className:"px-6 py-4",children:e.jsxs("div",{className:"text-xs space-y-1",children:[t.reportingManagerName&&e.jsxs("div",{className:"flex items-center gap-1",title:"Reporting Manager",children:[e.jsx("span",{className:"font-semibold text-primary-text",children:"RM:"})," ",t.reportingManagerName]}),t.managerName&&e.jsxs("div",{className:"flex items-center gap-1",title:"Site Manager",children:[e.jsx("span",{className:"font-semibold text-primary-text",children:"SM:"})," ",t.managerName]}),t.fieldStaffNames&&t.fieldStaffNames.length>0&&e.jsxs("div",{className:"flex items-start gap-1",title:"Field Staff",children:[e.jsx("span",{className:"font-semibold text-primary-text whitespace-nowrap",children:"FS:"}),e.jsx("span",{className:"truncate max-w-[150px]",children:t.fieldStaffNames.join(", ")})]}),t.backendFieldStaffName&&e.jsxs("div",{className:"flex items-start gap-1",title:"Backend Field Staff",children:[e.jsx("span",{className:"font-semibold text-primary-text whitespace-nowrap",children:"bfs:"}),e.jsx("span",{className:"truncate max-w-[150px]",children:t.backendFieldStaffName})]})]})}),e.jsx("td",{className:"px-6 py-4 text-right whitespace-nowrap",children:e.jsxs("div",{className:"flex items-center justify-end gap-2",children:[e.jsx(p,{variant:"icon",size:"sm",onClick:()=>ce(t),title:"Manpower Details",children:e.jsx(ke,{className:"w-4 h-4 text-blue-600"})}),e.jsx(p,{variant:"icon",size:"sm",onClick:()=>ie(t),title:"Configure Site",children:e.jsx(De,{className:"w-4 h-4 text-gray-600"})}),e.jsx(p,{variant:"icon",size:"sm",onClick:()=>re(t),title:"Delete Site",children:e.jsx(te,{className:"w-4 h-4 text-red-600"})})]})})]},t.id)})})]}),e.jsx(Ae,{currentPage:A,totalItems:d.filter(t=>k===""||t.shortName.toLowerCase().includes(k.toLowerCase())||t.fullName.toLowerCase().includes(k.toLowerCase())).length,pageSize:D,onPageChange:O,onPageSizeChange:H,className:"mt-4"})]})})]})};export{Xe as SiteManagement};
