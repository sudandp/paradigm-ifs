import{u as A,j as e,P as k,B as x,m as N,c as $,o as W,d as z,C as F,e as O,Q as _,k as q,T as B}from"./index-D5q3SS3D.js";import{b as m,l as E,u as V}from"./react-vendor-BUaIliXj.js";import{bL as H,aI as I,bM as M,a2 as Q,R as K,bN as Y,a4 as G,z as J,aD as X,bK as Z}from"./ui-vendor-B8EvWqdc.js";import{m as T,f as P}from"./utils-vendor-DmorxLnX.js";import"./pdf-vendor-CB_F1AVu.js";import"./capacitor-vendor-CqiIOUn1.js";import"./supabase-7WG3J4rU.js";const ee=({post:t,ticket:o,setTicket:l})=>{const{user:s}=A(),[i,b]=m.useState(!1),[g,j]=m.useState(""),[u,p]=m.useState(!1),n=s?t.likes.includes(s.id):!1,y=async()=>{if(!s)return;const c=[...t.likes],f=n?t.likes.filter(d=>d!==s.id):[...t.likes,s.id];l(d=>d?{...d,posts:d.posts.map(h=>h.id===t.id?{...h,likes:f}:h)}:null);try{await N.togglePostLike(t.id,s.id)}catch{l(h=>h?{...h,posts:h.posts.map(w=>w.id===t.id?{...w,likes:c}:w)}:null)}},v=async()=>{if(!(!g.trim()||!s)){p(!0);try{const c=await N.addPostComment(t.id,{postId:t.id,authorId:s.id,authorName:s.name,content:g});l(f=>f?{...f,posts:f.posts.map(d=>d.id===t.id?{...d,comments:[...d.comments,c]}:d)}:null),j("")}catch{}finally{p(!1)}}};return e.jsx("div",{className:"bg-card p-4 rounded-xl shadow-card",children:e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx(k,{seed:t.authorId,className:"w-10 h-10 rounded-full flex-shrink-0"}),e.jsxs("div",{className:"w-full",children:[e.jsxs("div",{className:"flex items-baseline gap-2",children:[e.jsx("span",{className:"font-semibold text-primary-text",children:t.authorName}),e.jsx("span",{className:"text-xs text-muted",children:t.authorRole.replace(/_/g," ")}),e.jsxs("span",{className:"text-xs text-muted",children:["Â· ",T(new Date(t.createdAt),{addSuffix:!0})]})]}),e.jsx("p",{className:"text-sm text-muted mt-1 whitespace-pre-wrap",children:t.content}),e.jsxs("div",{className:"flex items-center gap-4 mt-3 text-sm text-muted",children:[e.jsxs("button",{onClick:y,className:`flex items-center gap-1.5 hover:text-accent transition-colors ${n?"text-accent font-semibold":""}`,children:[e.jsx(H,{className:`h-4 w-4 ${n?"fill-current":""}`}),e.jsxs("span",{children:[t.likes.length," Like",t.likes.length!==1&&"s"]})]}),e.jsxs("button",{onClick:()=>b(!i),className:"flex items-center gap-1.5 hover:text-accent transition-colors",children:[e.jsx(I,{className:"h-4 w-4"}),e.jsxs("span",{children:[t.comments.length," Comment",t.comments.length!==1&&"s"]})]})]}),i&&e.jsxs("div",{className:"mt-4 space-y-3 pt-3 border-t border-border animate-fade-in-down",children:[t.comments.map(c=>e.jsxs("div",{className:"flex items-start gap-2",children:[e.jsx(k,{seed:c.authorId,className:"w-8 h-8 rounded-full flex-shrink-0"}),e.jsxs("div",{className:"bg-page p-2 rounded-lg flex-grow",children:[e.jsxs("div",{className:"flex items-baseline gap-2",children:[e.jsx("span",{className:"font-semibold text-sm text-primary-text",children:c.authorName}),e.jsx("span",{className:"text-xs text-muted",children:T(new Date(c.createdAt),{addSuffix:!0})})]}),e.jsx("p",{className:"text-sm text-muted",children:c.content})]})]},c.id)),e.jsxs("div",{className:"flex items-start gap-2",children:[e.jsx(k,{className:"w-8 h-8 rounded-full flex-shrink-0"}),e.jsxs("div",{className:"flex-grow",children:[e.jsx("textarea",{value:g,onChange:c=>j(c.target.value),placeholder:"Write a comment...",rows:2,className:"form-input text-sm"}),e.jsx("div",{className:"text-right mt-1",children:e.jsx(x,{size:"sm",onClick:v,isLoading:u,children:"Post"})})]})]})]})]})]})})},se=z({rating:_().min(1,"Please select a rating.").required(),feedback:O().required("Feedback is required to close the ticket.").min(10,"Please provide more detailed feedback.")}).defined(),te=({value:t,onChange:o})=>{const[l,s]=m.useState(0);return e.jsx("div",{className:"flex items-center justify-center gap-1",onMouseLeave:()=>s(0),children:[1,2,3,4,5].map(i=>e.jsx("button",{type:"button",onMouseEnter:()=>s(i),onClick:()=>o(i),className:"focus:outline-none",children:e.jsx(M,{className:`h-8 w-8 cursor-pointer transition-colors ${(l||t)>=i?"text-yellow-400 fill-current":"text-gray-400"}`})},i))})},ae=({isOpen:t,onClose:o,onSubmit:l})=>{const[s,i]=m.useState(!1),{register:b,handleSubmit:g,control:j,formState:{errors:u}}=$({resolver:W(se),defaultValues:{rating:0,feedback:""}}),p=n=>{i(!0),l(n.rating,n.feedback),i(!1)};return t?e.jsx("div",{className:"fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-60 p-4",onClick:o,children:e.jsx("div",{className:"bg-card rounded-xl shadow-card p-6 w-full max-w-lg m-4 animate-fade-in-scale",onClick:n=>n.stopPropagation(),children:e.jsxs("form",{onSubmit:g(p),children:[e.jsx("h3",{className:"text-lg font-bold text-primary-text mb-2 text-center",children:"Ticket Resolved"}),e.jsx("p",{className:"text-sm text-muted text-center mb-4",children:"Please rate the support you received before closing this ticket."}),e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{children:[e.jsx(F,{name:"rating",control:j,render:({field:n})=>e.jsx(te,{value:n.value,onChange:n.onChange})}),u.rating&&e.jsx("p",{className:"mt-2 text-xs text-red-500 text-center",children:u.rating.message})]}),e.jsxs("div",{children:[e.jsx("span",{className:"block text-sm font-medium text-muted text-center",children:"Your Feedback"}),e.jsx("textarea",{...b("feedback"),rows:4,className:`mt-1 form-input ${u.feedback?"form-input--error":""}`}),u.feedback&&e.jsx("p",{className:"mt-1 text-xs text-red-600",children:u.feedback.message})]})]}),e.jsxs("div",{className:"mt-6 flex justify-end space-x-3",children:[e.jsx(x,{type:"button",onClick:o,variant:"secondary",children:"Not Now"}),e.jsx(x,{type:"submit",isLoading:s,children:"Confirm & Close"})]})]})})}):null},ne=({priority:t})=>{const o={Low:"bg-blue-100 text-blue-800 dark:bg-blue-900/50 dark:text-blue-300",Medium:"bg-yellow-100 text-yellow-800 dark:bg-yellow-900/50 dark:text-yellow-300",High:"bg-orange-100 text-orange-800 dark:bg-orange-900/50 dark:text-orange-300",Urgent:"bg-red-100 text-red-800 dark:bg-red-900/50 dark:text-red-300"};return e.jsx("span",{className:`px-2 py-1 text-xs font-semibold rounded-full ${o[t]}`,children:t})},re=({status:t})=>{const o={Open:"status-chip--pending","In Progress":"sync-chip--pending_sync","Pending Requester":"leave-status-chip--pending_hr_confirmation",Resolved:"leave-status-chip--approved",Closed:"status-chip--draft"};return e.jsx("span",{className:`status-chip ${o[t]}`,children:t})},he=()=>{const{id:t}=E(),o=V(),{user:l}=A(),[s,i]=m.useState(null),[b,g]=m.useState([]),[j,u]=m.useState(!0),[p,n]=m.useState(null),[y,v]=m.useState(""),[c,f]=m.useState(!1),[d,h]=m.useState(!1);q("(max-width: 1023px)"),m.useEffect(()=>{if(!t)return;(async()=>{u(!0);try{const[r,R]=await Promise.all([N.getSupportTicketById(t),N.getNearbyUsers()]);r?i(r):(n({message:"Ticket not found.",type:"error"}),o("/support")),g(R)}catch{n({message:"Failed to load ticket data.",type:"error"})}finally{u(!1)}})()},[t,o]);const w=async()=>{if(!(!y.trim()||!s||!l)){f(!0);try{const a=await N.addTicketPost(s.id,{ticketId:s.id,authorId:l.id,authorName:l.name,authorRole:l.role,content:y});i(r=>r?{...r,posts:[...r.posts,a]}:null),v("")}catch{n({message:"Failed to add post.",type:"error"})}finally{f(!1)}}},C=async a=>{if(s)try{const r=await N.updateSupportTicket(s.id,a);i(r),a.status&&n({message:`Ticket status updated to ${a.status}`,type:"success"})}catch{n({message:"Failed to update ticket.",type:"error"})}},U=async(a,r)=>{await C({status:"Closed",rating:a,feedback:r,closedAt:new Date().toISOString()}),h(!1)},S=a=>{if(!a){n({message:"User does not have a phone number.",type:"error"});return}let r=a.replace(/\D/g,"");if(r.length>10&&(r=r.slice(-10)),r.length!==10){n({message:"Invalid phone number format.",type:"error"});return}window.open(`https://wa.me/91${r}`,"_blank")};if(j)return e.jsx("div",{className:"flex justify-center items-center h-screen",children:e.jsx(Q,{className:"h-12 w-12 animate-spin text-accent"})});if(!s)return null;const D=l?.id===s.raisedById,L=()=>s.status==="Closed"?null:e.jsxs("div",{className:"flex flex-wrap gap-2",children:[s.status==="Open"&&e.jsx(x,{onClick:()=>C({status:"In Progress",assignedToId:l?.id,assignedToName:l?.name}),children:"Assign to Me"}),s.status==="In Progress"&&l?.id===s.assignedToId&&e.jsx(x,{onClick:()=>C({status:"Resolved",resolvedAt:new Date().toISOString()}),children:"Mark as Resolved"}),s.status==="Resolved"&&D&&e.jsx(x,{onClick:()=>h(!0),children:"Close Ticket"})]});return e.jsxs("div",{className:"p-4",children:[p&&e.jsx(B,{message:p.message,type:p.type,onDismiss:()=>n(null)}),d&&e.jsx(ae,{isOpen:d,onClose:()=>h(!1),onSubmit:U}),e.jsxs("div",{className:"flex items-center gap-4 mb-4",children:[e.jsx(x,{variant:"icon",onClick:()=>o("/support"),children:e.jsx(K,{})}),e.jsxs("div",{children:[e.jsx("h2",{className:"text-xl md:text-2xl font-bold text-primary-text",children:s.title}),e.jsxs("p",{className:"text-xs text-muted",children:["#",s.ticketNumber]})]})]}),e.jsxs("div",{className:"lg:grid lg:grid-cols-3 lg:gap-6",children:[e.jsxs("main",{className:"lg:col-span-2 space-y-6",children:[e.jsxs("div",{className:"bg-card p-4 rounded-xl shadow-card space-y-4",children:[e.jsxs("div",{className:"flex flex-wrap gap-4 justify-between items-start",children:[e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx(re,{status:s.status}),e.jsx(ne,{priority:s.priority})]}),e.jsxs("div",{className:"text-sm text-muted text-right",children:[e.jsxs("p",{children:["Raised by: ",e.jsx("span",{className:"font-semibold text-primary-text",children:s.raisedByName})]}),e.jsx("p",{children:P(new Date(s.raisedAt),"dd MMM, yyyy - hh:mm a")})]})]}),e.jsx("p",{className:"text-sm text-muted whitespace-pre-wrap",children:s.description}),s.attachmentUrl&&(s.attachmentUrl.startsWith("http")||s.attachmentUrl.startsWith("https")||s.attachmentUrl.startsWith("data:"))&&e.jsxs("div",{className:"mt-4",children:[e.jsx("h5",{className:"text-sm font-semibold text-primary-text mb-2",children:"Attachment"}),e.jsx("a",{href:s.attachmentUrl,target:"_blank",rel:"noopener noreferrer",className:"block border rounded-lg overflow-hidden max-w-xs hover:border-accent",children:e.jsx("img",{src:s.attachmentUrl,alt:"Attachment",className:"max-h-64 w-auto",onError:a=>a.currentTarget.parentElement.style.display="none"})})]})]}),e.jsx("div",{className:"space-y-4",children:s.posts.map(a=>e.jsx(ee,{post:a,ticket:s,setTicket:i},a.id))}),s.status!=="Closed"&&e.jsxs("div",{className:"bg-card p-4 rounded-xl shadow-card flex items-start gap-3",children:[e.jsx(k,{className:"w-10 h-10 rounded-full flex-shrink-0"}),e.jsxs("div",{className:"w-full",children:[e.jsx("textarea",{value:y,onChange:a=>v(a.target.value),placeholder:"Add a public reply...",className:"form-input w-full",rows:3}),e.jsxs("div",{className:"mt-2 flex justify-between items-center",children:[e.jsx(x,{variant:"icon",size:"sm",title:"Attach file",children:e.jsx(Y,{className:"h-5 w-5"})}),e.jsxs(x,{onClick:w,isLoading:c,children:[e.jsx(G,{className:"mr-2 h-4"})," Post"]})]})]})]})]}),e.jsxs("aside",{className:"space-y-6 mt-6 lg:mt-0",children:[e.jsxs("div",{className:"bg-card p-4 rounded-xl shadow-card",children:[e.jsx("h3",{className:"font-semibold text-primary-text mb-3",children:"Ticket Details"}),e.jsxs("div",{className:"space-y-2 text-sm",children:[e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-muted",children:"Assigned To:"})," ",e.jsx("span",{className:"font-semibold",children:s.assignedToName||"Unassigned"})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-muted",children:"Category:"})," ",e.jsx("span",{children:s.category})]}),s.resolvedAt&&e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-muted",children:"Resolved:"})," ",e.jsx("span",{children:P(new Date(s.resolvedAt),"dd MMM, yy")})]}),s.closedAt&&e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-muted",children:"Closed:"})," ",e.jsx("span",{children:P(new Date(s.closedAt),"dd MMM, yy")})]}),s.rating&&e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-muted",children:"Rating:"})," ",e.jsxs("span",{className:"flex items-center gap-1",children:[s.rating," ",e.jsx(M,{className:"h-4 w-4 text-yellow-400 fill-current"})]})]})]}),e.jsx("div",{className:"mt-4 pt-4 border-t border-border",children:L()})]}),e.jsxs("div",{className:"bg-card p-4 rounded-xl shadow-card",children:[e.jsxs("h3",{className:"font-semibold text-primary-text mb-3 flex items-center gap-2",children:[e.jsx(J,{className:"h-5 w-5 text-muted"})," Nearby Users"]}),e.jsx("div",{className:"space-y-3",children:b.map(a=>e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsxs("div",{className:"relative",children:[e.jsx(k,{photoUrl:a.photoUrl,seed:a.id,className:"w-10 h-10 rounded-full"}),e.jsx("span",{className:"absolute bottom-0 right-0 block h-2.5 w-2.5 rounded-full bg-green-400 ring-2 ring-card"})]}),e.jsxs("div",{className:"flex-grow",children:[e.jsx("p",{className:"text-sm font-semibold",children:a.name}),e.jsx("p",{className:"text-xs text-muted",children:a.role.replace(/_/g," ").replace(/\b\w/g,r=>r.toUpperCase())})]}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(x,{variant:"icon",size:"sm",title:"WhatsApp Chat",onClick:()=>S(a.phone),children:e.jsx(X,{className:"h-4 w-4"})}),e.jsx(x,{variant:"icon",size:"sm",title:"WhatsApp Chat",onClick:()=>S(a.phone),children:e.jsx(I,{className:"h-4 w-4"})}),e.jsx(x,{variant:"icon",size:"sm",title:"WhatsApp Chat",onClick:()=>S(a.phone),children:e.jsx(Z,{className:"h-4 w-4"})})]})]},a.id))})]})]})]})]})};export{he as default};
