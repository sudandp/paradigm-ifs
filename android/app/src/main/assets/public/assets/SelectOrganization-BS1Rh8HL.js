import{h as K,l as Q,u as U,j as t,B as X,m as b}from"./index-D5q3SS3D.js";import{u as Y,b as s}from"./react-vendor-BUaIliXj.js";import{S}from"./Select-Dz12MdxG.js";import{a2 as Z,R as ee,D as R,ab as te}from"./ui-vendor-B8EvWqdc.js";import{f as se}from"./utils-vendor-DmorxLnX.js";import"./pdf-vendor-CB_F1AVu.js";import"./capacitor-vendor-CqiIOUn1.js";import"./supabase-7WG3J4rU.js";const me=()=>{const w=Y(),{updateOrganization:$,updatePersonal:A}=K(),{enforceManpowerLimit:L,manpowerLimitRule:B}=Q(),{user:P}=U(),[V,E]=s.useState(!0),[f,W]=s.useState([]),[y,T]=s.useState([]),[N,_]=s.useState([]),[d,M]=s.useState(""),[c,v]=s.useState(""),[n,m]=s.useState(""),[u,C]=s.useState(""),[k,D]=s.useState([]),[q,H]=s.useState(window.innerWidth<768);s.useEffect(()=>{const e=()=>H(window.innerWidth<768);return window.addEventListener("resize",e),()=>window.removeEventListener("resize",e)},[]);const[o,p]=s.useState({isOverLimit:!1,message:""}),J=P?.role==="field_staff"&&q;s.useEffect(()=>{(async()=>{E(!0);try{const[i,a,h]=await Promise.all([b.getOrganizationStructure(),b.getOrganizations(),b.getSiteStaffDesignations()]);W(i),T(a),_(h)}catch(i){console.error("Failed to fetch organization structure",i)}finally{E(!1)}})()},[]);const I=s.useMemo(()=>f.find(e=>e.id===d),[f,d]),j=s.useMemo(()=>I?.companies||[],[I]),O=s.useMemo(()=>j.find(e=>e.id===c),[j,c]),l=s.useMemo(()=>O?.entities||[],[O]);s.useEffect(()=>{C("");const e=l.find(i=>i.id===n);D(e?N:[])},[n,l,N]),s.useEffect(()=>{(async()=>{if(p({isOverLimit:!1,message:""}),!n||!L)return;const a=l.find(x=>x.id===n)?.organizationId;if(!a)return;const g=y.find(x=>x.id===a)?.manpowerApprovedCount;if(g==null){p({isOverLimit:!1,message:"Manpower limit not set for this site."});return}try{const z=(await b.getVerificationSubmissions()).filter(r=>r.organizationId===a&&(r.status==="verified"||r.status==="pending")).length;if(z>=g){const r=`Manpower limit of ${g} reached (${z} deployed).`;p({isOverLimit:!0,message:r})}else{const r=`Manpower: ${z} / ${g} deployed.`;p({isOverLimit:!1,message:r})}}catch{p({isOverLimit:!1,message:"Could not verify manpower count."})}})()},[n,y,l,L]);const G=()=>{const e=l.find(i=>i.id===n);if(e){let i=y.find(h=>h.id===(e.organizationId||e.id));const a=N.find(h=>h.designation===u);!i&&(e.organizationId||e.id)&&(i={id:e.organizationId||e.id,shortName:e.name,fullName:e.name,address:e.registeredAddress||""}),i&&a?($({organizationId:i.id,organizationName:i.shortName,joiningDate:se(new Date,"yyyy-MM-dd"),workType:"Full-time",designation:u,department:a.department,defaultSalary:a.monthlySalary||null}),A({salary:a.monthlySalary||null}),w("/onboarding/pre-upload")):console.error("Critical onboarding data missing:",{siteFound:!!e,orgFound:!!i,designationFound:!!a,selectedSite:e?.name,selectedDesignation:u})}};if(V)return t.jsx("div",{className:"flex justify-center items-center h-96",children:t.jsx(Z,{className:"h-8 w-8 animate-spin text-accent"})});const F=!n||!u||o.isOverLimit&&B==="block";return J?t.jsxs("div",{className:"h-full flex flex-col",children:[t.jsxs("header",{className:"p-4 flex-shrink-0 flex items-center gap-4 fo-mobile-header text-white",children:[t.jsx("button",{onClick:()=>w("/onboarding"),"aria-label":"Go back",className:"text-white",children:t.jsx(ee,{className:"h-6 w-6"})}),t.jsx("h1",{className:"text-xl font-bold",children:"New Enrollment"})]}),t.jsx("main",{className:"flex-1 overflow-y-auto p-4",children:t.jsxs("div",{className:"bg-card rounded-2xl p-6 space-y-6",children:[t.jsxs("div",{className:"text-center",children:[t.jsx("div",{className:"inline-block bg-accent-light p-3 rounded-full mb-2",children:t.jsx(R,{className:"h-8 w-8 text-accent-dark"})}),t.jsx("h2",{className:"text-xl font-bold text-primary-text",children:"Select Site"}),t.jsx("p",{className:"text-sm text-gray-400",children:"Choose the client and site for the new employee."})]}),t.jsxs("div",{className:"space-y-4",children:[t.jsxs("select",{value:d,onChange:e=>{M(e.target.value),v(""),m("")},className:"form-input",children:[t.jsx("option",{value:"",children:"-- Select a Group --"}),f.map(e=>t.jsx("option",{value:e.id,children:e.name},e.id))]}),t.jsxs("select",{value:c,onChange:e=>{v(e.target.value),m("")},disabled:!d,className:"form-input",children:[t.jsx("option",{value:"",children:"-- Select a Company --"}),j.map(e=>t.jsx("option",{value:e.id,children:e.name},e.id))]}),t.jsxs("select",{value:n,onChange:e=>m(e.target.value),disabled:!c,className:"form-input",children:[t.jsx("option",{value:"",children:"-- Select a Client/Site --"}),l.map(e=>t.jsx("option",{value:e.id,children:e.name},e.id))]}),t.jsxs("select",{value:u,onChange:e=>C(e.target.value),disabled:!n,className:"form-input",children:[t.jsx("option",{value:"",children:"-- Select a Designation --"}),k.map(e=>t.jsx("option",{value:e.designation,children:e.designation},e.id))]}),o.message&&t.jsx("div",{className:`mt-4 text-sm p-3 rounded-lg ${o.isOverLimit?"bg-red-900/50 text-red-300 border border-red-500/50":"bg-green-900/50 text-green-300 border border-green-500/50"}`,children:o.message})]})]})}),t.jsxs("footer",{className:"p-4 flex-shrink-0 flex items-center justify-between gap-4",children:[t.jsx("button",{onClick:()=>w("/onboarding"),className:"fo-btn-secondary px-6",children:"Back"}),t.jsx("button",{onClick:G,disabled:F,className:"fo-btn-primary flex-1",children:"Continue"})]})]}):t.jsx("div",{className:"p-4 md:p-0",children:t.jsxs("div",{className:"bg-card p-8 rounded-xl shadow-card w-full",children:[t.jsxs("div",{className:"flex items-center mb-6",children:[t.jsx("div",{className:"bg-accent-light p-3 rounded-full mr-4",children:t.jsx(R,{className:"h-8 w-8 text-accent-dark"})}),t.jsxs("div",{children:[t.jsx("h2",{className:"text-2xl font-bold text-primary-text",children:"Select Site"}),t.jsx("p",{className:"text-muted",children:"Choose the client and site for the new employee."})]})]}),t.jsxs("div",{className:"space-y-6",children:[t.jsxs(S,{label:"Company Group",id:"group",value:d,onChange:e=>{M(e.target.value),v(""),m("")},children:[t.jsx("option",{value:"",children:"-- Select a Group --"}),f.map(e=>t.jsx("option",{value:e.id,children:e.name},e.id))]}),t.jsxs(S,{label:"Company",id:"company",value:c,onChange:e=>{v(e.target.value),m("")},disabled:!d,children:[t.jsx("option",{value:"",children:"-- Select a Company --"}),j.map(e=>t.jsx("option",{value:e.id,children:e.name},e.id))]}),t.jsxs(S,{label:"Client / Site",id:"entity",value:n,onChange:e=>m(e.target.value),disabled:!c,children:[t.jsx("option",{value:"",children:"-- Select a Client/Site --"}),l.map(e=>t.jsx("option",{value:e.id,children:e.name},e.id))]}),t.jsxs(S,{label:"Designation",id:"designation",value:u,onChange:e=>C(e.target.value),disabled:!n,children:[t.jsx("option",{value:"",children:"-- Select a Designation --"}),k.map(e=>t.jsx("option",{value:e.designation,children:e.designation},e.id))]})]}),o.message&&t.jsx("div",{className:`mt-4 text-sm p-3 rounded-lg ${o.isOverLimit?"bg-red-50 text-red-700":"bg-green-50 text-green-700"}`,children:o.message}),t.jsx("div",{className:"mt-8 pt-6 border-t flex justify-end",children:t.jsxs(X,{onClick:G,disabled:F,children:["Continue ",t.jsx(te,{className:"ml-2 h-4 w-4"})]})})]})})};export{me as default};
