import{u as se,j as e,T as te,I as N,B as S,m as c,H as ae,J as oe}from"./index-D5q3SS3D.js";import{b as i}from"./react-vendor-BUaIliXj.js";import{P as re}from"./Pagination-DXf7cs0z.js";import{M as ne,a_ as ie,as as I,aj as de,at as _}from"./ui-vendor-B8EvWqdc.js";import"./pdf-vendor-CB_F1AVu.js";import"./capacitor-vendor-CqiIOUn1.js";import"./utils-vendor-DmorxLnX.js";import"./supabase-7WG3J4rU.js";const le=r=>r.toLowerCase().split(" ").map(h=>h.charAt(0).toUpperCase()+h.slice(1)).join(" "),ce=(r,h,x,f)=>{const P=r*Math.PI/180,A=x*Math.PI/180,g=(x-r)*Math.PI/180,p=(f-h)*Math.PI/180,j=Math.sin(g/2)*Math.sin(g/2)+Math.cos(P)*Math.cos(A)*Math.sin(p/2)*Math.sin(p/2);return 6371e3*(2*Math.atan2(Math.sqrt(j),Math.sqrt(1-j)))},je=()=>{const{user:r}=se(),[h,x]=i.useState([]),[f,L]=i.useState([]),[P,A]=i.useState(!0),[g,p]=i.useState(!1),[j,o]=i.useState(null),[b,M]=i.useState(""),[T,v]=i.useState(""),[R,w]=i.useState(""),[k,C]=i.useState(""),[l,q]=i.useState(null),[m,Y]=i.useState([]),[D,$]=i.useState(!1),[u,z]=i.useState(""),[U,J]=i.useState(1),[F,O]=i.useState(20),d=r&&["admin","hr","operation_manager"].includes(r.role);i.useEffect(()=>{(async()=>{if(r)try{const[a,t]=await Promise.all([c.getUserLocations(r.id),c.getLocations()]);x(a),L(t)}catch(a){console.error(a),o({message:"Failed to load locations.",type:"error"})}finally{A(!1)}})()},[r]);const Q=s=>{const a=s.target.value,t=le(a);M(t)},K=async()=>{p(!0),o({message:"Acquiring your location, please wait...",type:"success"});try{const s=await ae(),{latitude:a,longitude:t}=s.coords;v(a.toString()),w(t.toString());try{const n=await oe(a,t);C(n)}catch(n){console.warn("Reverse geocode failed:",n)}o({message:"Location acquired successfully! Please enter a location name.",type:"success"})}catch(s){console.error(s);const a=s.message?.toLowerCase().includes("permission")?"Location permission denied. Please enable it in settings.":"Unable to acquire location fix. Please ensure GPS is on and you are in an open area.";o({message:a,type:"error"})}finally{p(!1)}},V=async()=>{if(!r||m.length===0){o({message:"Please select at least one location.",type:"error"});return}$(!0);try{await Promise.all(m.map(a=>c.assignLocationToUser(r.id,a))),o({message:"Locations assigned successfully!",type:"success"}),Y([]);const s=await c.getUserLocations(r.id);x(s)}catch(s){console.error(s),o({message:s.message||"Failed to assign locations.",type:"error"})}finally{$(!1)}},W=s=>{Y(a=>a.includes(s)?a.filter(t=>t!==s):[...a,s])},X=async()=>{if(!r)return;if(!l&&!d){o({message:"You do not have permission to add locations.",type:"error"});return}if(!b.trim()){o({message:"Please enter a location name.",type:"error"});return}const s=parseFloat(T),a=parseFloat(R);if(isNaN(s)||isNaN(a)){o({message:"Please provide valid coordinates.",type:"error"});return}if(f.find(n=>n.id!==l&&n.name?.toLowerCase()===b.toLowerCase())){o({message:`Location "${b}" already exists. Please use a different name.`,type:"error"});return}if(!l){const n=f.find(y=>ce(s,a,y.latitude,y.longitude)<10);if(n){const y=n.name||n.address||"Unnamed Location";o({message:`A location already exists at these coordinates: "${y}".`,type:"error"});return}}p(!0);try{if(l)await c.updateLocation(l,{name:b,latitude:s,longitude:a,radius:100,address:k||null}),o({message:"Location updated successfully.",type:"success"});else{const ee=await c.createLocation({name:b,latitude:s,longitude:a,radius:100,address:k||null,createdBy:r.id});await c.assignLocationToUser(r.id,ee.id),o({message:"Location added successfully.",type:"success"})}const[y,H]=await Promise.all([c.getUserLocations(r.id),c.getLocations()]);x(y),L(H),G()}catch(n){console.error(n),o({message:n.message||"Failed to save location.",type:"error"})}finally{p(!1)}},E=s=>{q(s.id),M(s.name||""),v(s.latitude.toString()),w(s.longitude.toString()),C(s.address||""),window.scrollTo({top:0,behavior:"smooth"})},B=async s=>{if(!r||!d){o({message:"You do not have permission to delete locations.",type:"error"});return}if(window.confirm("Are you sure you want to delete this location? It will be removed from all users."))try{await c.deleteLocation(s),o({message:"Location deleted successfully.",type:"success"});const[a,t]=await Promise.all([c.getUserLocations(r.id),c.getLocations()]);x(a),L(t)}catch(a){console.error(a),o({message:a.message||"Failed to delete location.",type:"error"})}},G=()=>{M(""),v(""),w(""),C(""),q(null)},Z=h.filter((s,a,t)=>s.address?a===t.findIndex(n=>n.address===s.address):!0);return e.jsxs("div",{className:"p-4 md:p-6 w-full",children:[j&&e.jsx(te,{message:j.message,type:j.type,onDismiss:()=>o(null)}),e.jsxs("div",{className:"border-0 shadow-none md:bg-card md:p-6 md:rounded-xl md:shadow-card",children:[e.jsxs("h2",{className:"text-2xl font-bold mb-4 flex items-center",children:[e.jsx(ne,{className:"h-6 w-6 mr-2"})," My Locations"]}),e.jsxs("p",{className:"text-muted mb-6",children:["These are the geofenced locations assigned to you. You may punch in/out only when within one of these locations. ",d?"Use the form below to add a new location.":"You can edit location names by clicking the edit button."]}),(d||l)&&e.jsxs("div",{className:"bg-gray-50 border border-border rounded-lg p-4 mb-6",children:[e.jsx("h3",{className:"text-lg font-semibold mb-4",children:l?"Edit Location":"Add New Location"}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4 mb-4",children:[e.jsx(N,{label:"Location Name (required) *",id:"locationName",value:b,onChange:Q,placeholder:"e.g. Office HQ",autoComplete:"off",required:!0}),e.jsx(N,{label:"Latitude",id:"latitude",type:"number",value:T,onChange:s=>v(s.target.value),placeholder:"12.9716",step:"any",autoComplete:"off",disabled:l&&!d}),e.jsx(N,{label:"Longitude",id:"longitude",type:"number",value:R,onChange:s=>w(s.target.value),placeholder:"77.5946",step:"any",autoComplete:"off",disabled:l&&!d}),e.jsx(N,{id:"address",value:k,onChange:s=>C(s.target.value),placeholder:"Street, City, State",autoComplete:"street-address",disabled:l&&!d})]}),e.jsxs("div",{className:"flex gap-4 flex-wrap",children:[d&&e.jsxs(S,{onClick:K,variant:"secondary",isLoading:g,disabled:g,children:[e.jsx(ie,{className:"h-4 w-4 mr-2"})," Use Current Location"]}),e.jsx(S,{onClick:X,isLoading:g,disabled:g||!b.trim(),children:l?"Save Changes":"Add Location"}),l&&e.jsx(S,{onClick:G,variant:"secondary",children:"Cancel"})]})]})]}),e.jsx("div",{className:"mt-6",children:P?e.jsx("p",{children:"Loading locations..."}):h.length===0?e.jsx("div",{children:d?e.jsx("p",{className:"text-muted text-center md:text-left",children:"No locations assigned. Use the form above to add one."}):e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"bg-blue-50 border border-blue-200 rounded-lg p-4",children:[e.jsx("h3",{className:"text-lg font-semibold text-blue-900 mb-2",children:"Select Your Locations"}),e.jsx("p",{className:"text-sm text-blue-800 mb-4",children:"You don't have any locations assigned yet. Please select the locations where you'll be working from the list below."})]}),f.length===0?e.jsx("p",{className:"text-muted text-center",children:"No locations available. Contact your administrator."}):e.jsxs("div",{children:[e.jsx("div",{className:"mb-4",children:e.jsx(N,{type:"text",placeholder:"Search by name or address...",value:u,onChange:s=>z(s.target.value),autoComplete:"off"})}),e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-3 mb-4",children:f.filter(s=>u===""||s.name?.toLowerCase().includes(u.toLowerCase())||s.address?.toLowerCase().includes(u.toLowerCase())).map(s=>e.jsx("div",{onClick:()=>W(s.id),className:`border rounded-lg p-4 cursor-pointer transition-all ${m.includes(s.id)?"border-accent bg-accent/10 shadow-md":"border-border hover:border-accent/50 hover:bg-gray-50"}`,children:e.jsxs("div",{className:"flex items-start",children:[e.jsx("input",{type:"checkbox",checked:m.includes(s.id),onChange:()=>{},className:"mt-1 mr-3 h-5 w-5 text-accent rounded focus:ring-accent"}),e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"flex justify-between items-start",children:[e.jsx("h4",{className:"font-semibold text-primary-text",children:s.name||"Unnamed Location"}),e.jsx("button",{type:"button",onClick:a=>{a.stopPropagation(),E(s)},className:"text-blue-600 hover:text-blue-800 p-1",title:"Edit Name",children:e.jsx(I,{className:"h-4 w-4"})})]}),e.jsx("p",{className:"text-sm text-muted mt-1",children:s.address||"No address"}),e.jsxs("p",{className:"text-xs text-muted mt-2",children:["Coordinates: ",s.latitude.toFixed(4),", ",s.longitude.toFixed(4)," â€¢ Radius: ",s.radius,"m"]})]})]})},s.id))}),e.jsx("div",{className:"flex justify-center",children:e.jsx(S,{onClick:V,isLoading:D,disabled:D||m.length===0,children:m.length===0?"Select Locations Above":`Assign ${m.length} Location${m.length>1?"s":""}`})})]})]})}):e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"mb-4",children:e.jsx(N,{placeholder:"Search locations by name or address...",value:u,onChange:s=>z(s.target.value),icon:e.jsx(de,{className:"h-4 w-4"}),autoComplete:"off"})}),(()=>{const s=Z.filter(t=>u===""||t.name&&t.name.toLowerCase().includes(u.toLowerCase())||t.address&&t.address.toLowerCase().includes(u.toLowerCase())),a=s.slice((U-1)*F,U*F);return e.jsxs("div",{className:"space-y-4 md:space-y-0 md:grid md:grid-cols-1 md:gap-4",children:[e.jsx("div",{className:"md:hidden space-y-4",children:a.map(t=>e.jsxs("div",{className:"bg-card rounded-lg shadow-card p-4 border border-border",children:[e.jsxs("div",{className:"flex justify-between items-start",children:[e.jsxs("div",{children:[e.jsx("h3",{className:"font-bold text-primary-text",children:t.name||t.address||"Unnamed Location"}),e.jsx("p",{className:"text-sm text-muted",children:t.address})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx("button",{type:"button",className:"text-blue-500 hover:text-blue-700 p-1",title:d?"Edit Location":"Edit Name",onClick:()=>E(t),children:e.jsx(I,{className:"h-5 w-5"})}),d&&e.jsx("button",{type:"button",className:"text-red-500 hover:text-red-700 p-1",title:"Delete Location",onClick:()=>B(t.id),children:e.jsx(_,{className:"h-5 w-5"})})]})]}),e.jsxs("div",{className:"mt-4 pt-4 border-t border-border grid grid-cols-2 gap-4 text-sm",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-muted",children:"Radius"}),e.jsxs("p",{children:[t.radius,"m"]})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-muted",children:"Coordinates"}),e.jsxs("p",{children:[t.latitude?.toFixed(4),", ",t.longitude?.toFixed(4)]})]})]})]},t.id))}),e.jsx("div",{className:"hidden md:block overflow-x-auto border border-border rounded-lg",children:e.jsxs("table",{className:"min-w-full border-collapse text-sm",children:[e.jsx("thead",{className:"bg-page text-primary-text",children:e.jsxs("tr",{children:[e.jsx("th",{className:"p-3 border-b border-border text-left",children:"Name"}),e.jsx("th",{className:"p-3 border-b border-border text-left",children:"Radius (m)"}),e.jsx("th",{className:"p-3 border-b border-border text-left",children:"Coordinates"}),e.jsx("th",{className:"p-3 border-b border-border text-left",children:"Address"}),e.jsx("th",{className:"p-3 border-b border-border text-left",children:"Actions"})]})}),e.jsx("tbody",{children:a.map(t=>e.jsxs("tr",{className:"border-b border-border",children:[e.jsx("td",{className:"p-3",children:t.name||"-"}),e.jsx("td",{className:"p-3",children:t.radius}),e.jsxs("td",{className:"p-3",children:[t.latitude?.toFixed(4),", ",t.longitude?.toFixed(4)]}),e.jsx("td",{className:"p-3",children:t.address||"-"}),e.jsxs("td",{className:"p-3 flex gap-2",children:[e.jsx("button",{type:"button",className:"text-blue-600 hover:text-blue-800",title:d?"Edit Location":"Edit Name",onClick:()=>E(t),children:e.jsx(I,{className:"h-4 w-4"})}),d&&e.jsx("button",{type:"button",className:"text-red-600 hover:text-red-800",title:"Delete Location",onClick:()=>B(t.id),children:e.jsx(_,{className:"h-4 w-4"})})]})]},t.id))})]})}),e.jsx(re,{currentPage:U,totalItems:s.length,pageSize:F,onPageChange:J,onPageSizeChange:O,className:"mt-4"})]})})()]})})]})};export{je as default};
