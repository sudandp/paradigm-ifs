import{u as ze,m as h,j as e,T as Le}from"./index-D5q3SS3D.js";import{u as Ve,b as r,R as _e}from"./react-vendor-BUaIliXj.js";import{E as re,F as ye}from"./FileSaver.min-C7cHFFkD.js";import{a2 as W,$ as We,au as Ue,ap as Qe,ao as le,I as Je,aK as ne,bF as Ke,bB as Oe,k as Xe,bD as qe,at as U,bm as Ge,bE as He,T as Ye}from"./ui-vendor-B8EvWqdc.js";import{f as M,c as Ze}from"./utils-vendor-DmorxLnX.js";import"./pdf-vendor-CB_F1AVu.js";import"./capacitor-vendor-CqiIOUn1.js";import"./supabase-7WG3J4rU.js";const ot=()=>{const Q=Ve(),[N,fe]=r.useState([]),[J,ie]=r.useState(!0),[K,B]=r.useState(!1),[oe,de]=r.useState(!1),[I,$]=r.useState([]),[j,be]=r.useState(M(Ze(new Date),"yyyy-MM-dd")),[O,l]=r.useState(null),[ce,Ne]=r.useState([]),xe=_e.useRef(null),{user:c}=ze(),[X,me]=r.useState([]),[x,he]=r.useState("active"),[D,q]=r.useState(null),[G,H]=r.useState(""),[pe,T]=r.useState(!1),[P,E]=r.useState(null),u=r.useCallback(async()=>{if(c){ie(!0);try{const t=(c.role||"").toLowerCase(),a=["admin","super_admin","finance_manager","management","hr","hr_ops"].includes(t)?void 0:c.id,[n,o,i]=await Promise.all([h.getSiteFinanceRecords(j,a),h.getSiteInvoiceDefaults(a),h.getDeletedSiteFinanceRecords(a)]);fe(n),me(i),Ne(o.sort((g,F)=>g.siteName.localeCompare(F.siteName)));const m=new Date;m.setDate(m.getDate()-7);const k=i.filter(g=>g.deletedAt&&new Date(g.deletedAt)<m);if(k.length>0){console.log(`Cleaning up ${k.length} expired records...`),await Promise.all(k.map(F=>h.permanentlyDeleteSiteFinanceRecord(F.id)));const g=await h.getDeletedSiteFinanceRecords();me(g)}}catch(t){console.error("Error fetching finance data:",t),l({message:"Failed to load finance data",type:"error"})}finally{ie(!1)}}},[j]);r.useEffect(()=>{u()},[u]);const p=t=>new Intl.NumberFormat("en-IN",{style:"currency",currency:"INR",maximumFractionDigits:0}).format(t),je=async()=>{B(!0);try{const t=new re.Workbook,s=t.addWorksheet("Finance Template");s.columns=[{header:"Site Name",key:"siteName",width:25},{header:"Company Name",key:"companyName",width:20},{header:"Contract Amount",key:"contractAmount",width:15},{header:"Contract Management Fee",key:"contractManagementFee",width:25},{header:"Billed Amount",key:"billedAmount",width:15},{header:"Billed Management Fee",key:"billedManagementFee",width:25}],s.getRow(1).font={bold:!0},s.getRow(1).fill={type:"pattern",pattern:"solid",fgColor:{argb:"FF006B3F"}},s.getRow(1).font={color:{argb:"FFFFFFFF"},bold:!0},ce.forEach(o=>{s.addRow({siteName:o.siteName,companyName:o.companyName||"",contractAmount:o.contractAmount||0,contractManagementFee:o.contractManagementFee||0,billedAmount:"",billedManagementFee:""})});const a=await t.xlsx.writeBuffer(),n=new Blob([a],{type:"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"});ye.saveAs(n,`Site_Finance_Template_${j.substring(0,7)}.xlsx`),l({message:"Template downloaded!",type:"success"})}catch(t){console.error("Template error:",t),l({message:"Failed to generate template",type:"error"})}finally{B(!1)}},we=async t=>{const s=t.target.files?.[0];if(s){try{const a=new re.Workbook,n=await s.arrayBuffer();await a.xlsx.load(n);const o=a.getWorksheet(1),i=[];o?.eachRow((m,k)=>{if(k===1)return;const g=m.getCell(1).value?.toString()||"";if(!g)return;const F=ce.find(ae=>ae.siteName===g),Pe=ae=>/^[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/i.test(ae),Ee=F?.siteId&&Pe(F.siteId)?F.siteId:void 0,ge=Number(m.getCell(5).value)||0,ue=Number(m.getCell(6).value)||0;i.push({siteId:Ee,siteName:g,companyName:m.getCell(2).value?.toString()||"",contractAmount:Number(m.getCell(3).value)||0,contractManagementFee:Number(m.getCell(4).value)||0,billedAmount:ge,billedManagementFee:ue,billingMonth:j,totalBilledAmount:ge+ue,status:"pending"})}),i.length===0?l({message:"No valid records found in file",type:"error"}):($(i),l({message:`${i.length} records parsed for preview`,type:"success"}))}catch(a){console.error("Import error:",a),l({message:"Failed to process Excel file",type:"error"})}t.target&&(t.target.value="")}},ve=async()=>{de(!0);try{const t=I.map(a=>({...a,createdBy:c?.id,createdByName:c?.name,createdByRole:c?.role}));await h.bulkSaveSiteFinanceRecords(t);const s=t.filter(a=>!!a.siteId).map(a=>({siteId:a.siteId,siteName:a.siteName,companyName:a.companyName,contractAmount:a.contractAmount,contractManagementFee:a.contractManagementFee}));s.length>0&&await h.bulkSaveSiteInvoiceDefaults(s),l({message:"Records imported and defaults synced successfully!",type:"success"}),$([]),u()}catch(t){console.error("Bulk save error:",t),l({message:"Failed to save imported records",type:"error"})}finally{de(!1)}},ke=async()=>{B(!0);try{const t=new re.Workbook,s=t.addWorksheet("Finance Records");s.columns=[{header:"Site Name",key:"siteName",width:25},{header:"Contract Amount",key:"contractAmount",width:15},{header:"Contract Fee",key:"contractManagementFee",width:15},{header:"Billed Amount",key:"billedAmount",width:15},{header:"Billed Fee",key:"billedManagementFee",width:15},{header:"Total Billed",key:"totalBilledAmount",width:15},{header:"Billing Variation",key:"billingVar",width:15},{header:"Fee Variation",key:"feeVar",width:15},{header:"Net Variation",key:"netVar",width:15}],N.forEach(n=>{const o=(n.billedAmount||0)-(n.contractAmount||0),i=(n.billedManagementFee||0)-(n.contractManagementFee||0);s.addRow({...n,billingVar:o,feeVar:i,netVar:o+i})});const a=await t.xlsx.writeBuffer();ye.saveAs(new Blob([a]),`Finance_Export_${j.substring(0,7)}.xlsx`)}catch(t){console.error("Export error:",t),l({message:"Failed to export data",type:"error"})}finally{B(!1)}},Fe=async t=>{if(te){await Se(t);return}if(!(!D||!c)){T(!0);try{await h.deleteSiteFinanceRecord(D.id,t,c.id,c.name||"Admin"),l({message:"Record moved to Deletion Log",type:"success"}),q(null),H(""),R(!1),u()}catch(s){console.error("Delete error:",s),l({message:"Failed to delete record",type:"error"})}finally{T(!1)}}},Se=async t=>{if(!(d.size===0||!c)){T(!0);try{const s=Array.from(d);await h.bulkSoftDeleteSiteFinanceRecords(s,t,c.id,c.name||"Admin"),l({message:`${d.size} records moved to Deletion Log`,type:"success"}),b(new Set),H(""),L(!1),R(!1),u()}catch(s){console.error("Bulk delete error:",s),l({message:"Failed to delete selected records",type:"error"})}finally{T(!1)}}},De=async t=>{E(t);try{await h.restoreSiteFinanceRecord(t),l({message:"Record restored successfully",type:"success"}),u()}catch(s){console.error("Restore error:",s),l({message:"Failed to restore record",type:"error"})}finally{E(null)}},Ce=async t=>{if(confirm("Are you sure you want to permanently delete this record? This cannot be undone."))try{await h.permanentlyDeleteSiteFinanceRecord(t),l({message:"Record permanently deleted",type:"success"}),u()}catch(s){console.error("Permanent delete error:",s),l({message:"Failed to delete record permanently",type:"error"})}},Y=["admin","super_admin","management","hr"].includes(c?.role||""),Re=async()=>{if(!(d.size===0||!Y)){E("bulk");try{const t=Array.from(d);await h.bulkRestoreSiteFinanceRecords(t),l({message:`${d.size} records restored successfully`,type:"success"}),b(new Set),u()}catch(t){console.error("Bulk restore error:",t),l({message:"Failed to restore records",type:"error"})}finally{E(null)}}},Ae=async()=>{if(!(d.size===0||!Y)&&confirm(`Are you sure you want to permanently delete these ${d.size} records? This action cannot be undone.`))try{const t=Array.from(d);await h.bulkPermanentlyDeleteSiteFinanceRecords(t),l({message:`${d.size} records permanently deleted`,type:"success"}),b(new Set),u()}catch(t){console.error("Bulk permanent delete error:",t),l({message:"Failed to delete records permanently",type:"error"})}};let y=0,f=0,Z=0;N.forEach(t=>{const s=(t.billedAmount||0)-(t.contractAmount||0),a=(t.billedManagementFee||0)-(t.contractManagementFee||0);y+=s,f+=a,s+a>=0&&Z++});const[z,Me]=r.useState(""),[w,ee]=r.useState({siteName:"",status:""}),[v,C]=r.useState(1),[S,Be]=r.useState(15),[d,b]=r.useState(new Set),[te,L]=r.useState(!1),[Ie,R]=r.useState(!1),se=x==="active"?N:X,A=se.filter(t=>{const s=t.siteName.toLowerCase().includes(z.toLowerCase())||(t.companyName||"").toLowerCase().includes(z.toLowerCase()),a=!w.siteName||t.siteName.toLowerCase().includes(w.siteName.toLowerCase()),n=!w.status||(()=>{const i=(t.billedAmount||0)+(t.billedManagementFee||0)-((t.contractAmount||0)+(t.contractManagementFee||0))>=0;return w.status==="profit"?i:!i})();return s&&a&&n}),V=Math.ceil(A.length/S),_=A.slice((v-1)*S,v*S);r.useEffect(()=>{C(1)},[z,w,x]),r.useEffect(()=>{ee({siteName:"",status:""}),b(new Set)},[x]);const $e=t=>{if(t.target.checked){const s=_.map(a=>a.id);b(new Set(s))}else b(new Set)},Te=t=>{b(s=>{const a=new Set(s);return a.has(t)?a.delete(t):a.add(t),a})};return e.jsxs("div",{className:"space-y-6 w-full px-4",children:[e.jsx("div",{className:"bg-white rounded-xl border border-gray-200/80 shadow-sm p-5",children:e.jsxs("div",{className:"flex flex-col md:flex-row md:items-center justify-between gap-4",children:[e.jsxs("div",{className:"flex items-center gap-2 flex-wrap",children:[e.jsxs("button",{onClick:je,disabled:K,className:"inline-flex items-center gap-1.5 px-4 py-2 text-xs font-semibold text-gray-600 bg-white border border-gray-200 rounded-lg hover:bg-gray-50 hover:border-gray-300 transition-all duration-150 hover:scale-[1.02] active:scale-[0.98] disabled:opacity-50",children:[K?e.jsx(W,{className:"h-3.5 w-3.5 animate-spin"}):e.jsx(We,{className:"h-3.5 w-3.5"}),"Template"]}),e.jsxs("button",{onClick:()=>xe.current?.click(),className:"inline-flex items-center gap-1.5 px-4 py-2 text-xs font-semibold text-gray-600 bg-white border border-gray-200 rounded-lg hover:bg-gray-50 hover:border-gray-300 transition-all duration-150 hover:scale-[1.02] active:scale-[0.98]",children:[e.jsx(Ue,{className:"h-3.5 w-3.5"}),"Import"]}),e.jsxs("button",{onClick:ke,disabled:K,className:"inline-flex items-center gap-1.5 px-4 py-2 text-xs font-semibold text-gray-600 bg-white border border-gray-200 rounded-lg hover:bg-gray-50 hover:border-gray-300 transition-all duration-150 hover:scale-[1.02] active:scale-[0.98] disabled:opacity-50",children:[e.jsx(Qe,{className:"h-3.5 w-3.5"}),"Export"]}),e.jsx("input",{type:"file",ref:xe,onChange:we,accept:".xlsx, .xls",className:"hidden"})]}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("input",{type:"month",value:j.substring(0,7),onChange:t=>be(t.target.value+"-01"),className:"h-9 px-3 text-sm bg-white border border-gray-200 rounded-lg focus:border-emerald-500 focus:ring-1 focus:ring-emerald-500/20 outline-none transition-all"}),e.jsxs("button",{onClick:()=>Q("/finance/site-tracker/add"),className:"inline-flex items-center gap-1.5 px-5 py-2 text-xs font-bold text-white bg-[#006B3F] rounded-lg hover:bg-[#005632] transition-all duration-150 shadow-sm shadow-emerald-900/10 hover:shadow-md hover:shadow-emerald-900/15 hover:scale-[1.02] active:scale-[0.98]",children:[e.jsx(le,{className:"h-3.5 w-3.5"}),"Add Record"]})]})]})}),!J&&e.jsxs("div",{className:"grid grid-cols-2 lg:grid-cols-4 gap-4",children:[e.jsx("div",{className:`rounded-xl border p-5 transition-all duration-150 hover:shadow-md hover:-translate-y-0.5 ${y>=0?"bg-emerald-50/40 border-emerald-100":"bg-rose-50/40 border-rose-100"}`,children:e.jsxs("div",{className:"flex items-start justify-between",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-[11px] font-semibold text-gray-500 uppercase tracking-wider",children:"Total Variation"}),e.jsx("h3",{className:`text-xl font-bold mt-1.5 ${y>=0?"text-emerald-700":"text-rose-700"}`,children:p(y)}),e.jsxs("p",{className:`text-[10px] font-medium mt-1 ${y>=0?"text-emerald-600":"text-rose-600"}`,children:[y>=0?"↑":"↓"," Billing difference"]})]}),e.jsx("div",{className:`w-10 h-10 rounded-lg flex items-center justify-center ${y>=0?"bg-emerald-100":"bg-rose-100"}`,children:e.jsx(Je,{className:`h-5 w-5 ${y>=0?"text-emerald-600":"text-rose-600"}`})})]})}),e.jsx("div",{className:`rounded-xl border p-5 transition-all duration-150 hover:shadow-md hover:-translate-y-0.5 ${f>=0?"bg-emerald-50/40 border-emerald-100":"bg-rose-50/40 border-rose-100"}`,children:e.jsxs("div",{className:"flex items-start justify-between",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-[11px] font-semibold text-gray-500 uppercase tracking-wider",children:"Fee Variation"}),e.jsx("h3",{className:`text-xl font-bold mt-1.5 ${f>=0?"text-emerald-700":"text-rose-700"}`,children:p(f)}),e.jsxs("p",{className:`text-[10px] font-medium mt-1 ${f>=0?"text-emerald-600":"text-rose-600"}`,children:[f>=0?"↑":"↓"," Fee difference"]})]}),e.jsx("div",{className:`w-10 h-10 rounded-lg flex items-center justify-center ${f>=0?"bg-emerald-100":"bg-rose-100"}`,children:f>=0?e.jsx(ne,{className:"h-5 w-5 text-emerald-600"}):e.jsx(Ke,{className:"h-5 w-5 text-rose-600"})})]})}),e.jsx("div",{className:"bg-white rounded-xl border border-gray-200/80 p-5 transition-all duration-150 hover:shadow-md hover:-translate-y-0.5",children:e.jsxs("div",{className:"flex items-start justify-between",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-[11px] font-semibold text-gray-500 uppercase tracking-wider",children:"Profit Sites"}),e.jsxs("h3",{className:"text-xl font-bold text-gray-900 mt-1.5",children:[Z," ",e.jsxs("span",{className:"text-sm font-normal text-gray-400",children:["/ ",N.length]})]}),e.jsxs("p",{className:"text-[10px] font-medium text-emerald-600 mt-1",children:[N.length>0?Math.round(Z/N.length*100):0,"% profitable"]})]}),e.jsx("div",{className:"w-10 h-10 rounded-lg bg-emerald-100 flex items-center justify-center",children:e.jsx(ne,{className:"h-5 w-5 text-emerald-600"})})]})}),e.jsx("div",{className:"bg-white rounded-xl border border-gray-200/80 p-5 transition-all duration-150 hover:shadow-md hover:-translate-y-0.5",children:e.jsxs("div",{className:"flex items-start justify-between",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-[11px] font-semibold text-gray-500 uppercase tracking-wider",children:"Total Records"}),e.jsx("h3",{className:"text-xl font-bold text-gray-900 mt-1.5",children:N.length}),e.jsxs("p",{className:"text-[10px] font-medium text-gray-400 mt-1",children:["For ",M(new Date(j),"MMM yyyy")]})]}),e.jsx("div",{className:"w-10 h-10 rounded-lg bg-gray-100 flex items-center justify-center",children:e.jsx(Oe,{className:"h-5 w-5 text-gray-500"})})]})})]}),e.jsxs("div",{className:"bg-white rounded-xl border border-gray-200/80 shadow-sm overflow-hidden",children:[e.jsxs("div",{className:"px-5 py-3 border-b border-gray-100 flex flex-col sm:flex-row items-center justify-between gap-4",children:[e.jsxs("div",{className:"flex items-center p-1 bg-gray-50 rounded-lg self-start",children:[e.jsx("button",{onClick:()=>he("active"),className:`px-4 py-1.5 text-xs font-bold rounded-md transition-all ${x==="active"?"bg-white text-emerald-700 shadow-sm border border-gray-100":"text-gray-500 hover:text-gray-700"}`,children:"Active Records"}),e.jsxs("button",{onClick:()=>he("log"),className:`px-4 py-1.5 text-xs font-bold rounded-md transition-all flex items-center gap-1.5 ${x==="log"?"bg-white text-emerald-700 shadow-sm border border-gray-100":"text-gray-500 hover:text-gray-700"}`,children:["Deletion Log",X.length>0&&e.jsx("span",{className:`flex items-center justify-center min-w-[16px] h-4 px-1 rounded-full text-[10px] ${x==="log"?"bg-emerald-100 text-emerald-700":"bg-gray-200 text-gray-600"}`,children:X.length})]})]}),!J&&se.length>0&&e.jsxs("div",{className:"flex flex-1 items-center justify-end gap-3 w-full sm:w-auto",children:[e.jsxs("div",{className:"relative flex-1 max-w-xs",children:[e.jsx("input",{type:"text",placeholder:"Search...",value:z,onChange:t=>Me(t.target.value),className:"w-full h-8 pl-8 pr-3 text-sm bg-gray-50 border border-gray-200 rounded-lg focus:bg-white focus:border-emerald-500 focus:ring-1 focus:ring-emerald-500/20 outline-none transition-all placeholder:text-gray-400"}),e.jsx("svg",{className:"absolute left-2.5 top-1/2 -translate-y-1/2 h-3.5 w-3.5 text-gray-400",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"})})]}),e.jsxs("span",{className:"text-xs text-gray-400 font-medium whitespace-nowrap",children:[A.length," found"]})]})]}),J?e.jsxs("div",{className:"flex flex-col items-center justify-center py-24 gap-3",children:[e.jsx(W,{className:"h-7 w-7 animate-spin text-emerald-500"}),e.jsx("span",{className:"text-sm text-gray-400 font-medium",children:"Loading records..."})]}):se.length===0?e.jsxs("div",{className:"flex flex-col items-center justify-center py-20 px-6 text-center",children:[e.jsx("div",{className:"w-16 h-16 bg-gray-100 rounded-2xl flex items-center justify-center mb-5",children:e.jsx(Xe,{className:"h-7 w-7 text-gray-400"})}),e.jsx("h3",{className:"text-lg font-bold text-gray-900",children:x==="active"?"No finance records found":"Deletion Log is empty"}),e.jsx("p",{className:"text-sm text-gray-500 mt-1.5 max-w-xs",children:x==="active"?"No records found for the selected month. Add your first record to get started.":"No records have been deleted in the last 7 days."}),x==="active"&&e.jsxs("button",{onClick:()=>Q("/finance/site-tracker/add"),className:"mt-5 inline-flex items-center gap-1.5 px-5 py-2.5 text-sm font-bold text-white bg-[#006B3F] rounded-lg hover:bg-[#005632] transition-all shadow-sm hover:scale-[1.02] active:scale-[0.98]",children:[e.jsx(le,{className:"h-4 w-4"}),"Add First Record"]})]}):e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"w-full text-sm",children:[e.jsxs("thead",{children:[e.jsxs("tr",{className:"bg-gray-50/80 border-b border-gray-200",children:[e.jsx("th",{className:"px-5 py-3 text-left w-10",children:e.jsx("input",{type:"checkbox",className:"w-4 h-4 rounded border-gray-300 text-emerald-600 focus:ring-emerald-500 cursor-pointer",checked:_.length>0&&_.every(t=>d.has(t.id)),onChange:$e})}),e.jsx("th",{className:"px-5 py-3 text-left text-[11px] font-semibold text-gray-500 uppercase tracking-wider",children:"Client Name"}),x==="active"?e.jsxs(e.Fragment,{children:[e.jsx("th",{className:"px-4 py-3 text-right text-[11px] font-semibold text-gray-500 uppercase tracking-wider",children:"Contract"}),e.jsx("th",{className:"px-4 py-3 text-right text-[11px] font-semibold text-gray-500 uppercase tracking-wider",children:"Billed"}),e.jsx("th",{className:"px-4 py-3 text-right text-[11px] font-semibold text-gray-500 uppercase tracking-wider hidden md:table-cell",children:"Mgmt Fee"}),e.jsx("th",{className:"px-4 py-3 text-right text-[11px] font-semibold text-gray-500 uppercase tracking-wider hidden md:table-cell",children:"Billed Fee"}),e.jsx("th",{className:"px-4 py-3 text-right text-[11px] font-semibold text-gray-500 uppercase tracking-wider",children:"Net Variation"}),e.jsx("th",{className:"px-4 py-3 text-center text-[11px] font-semibold text-gray-500 uppercase tracking-wider",children:"Status"}),e.jsx("th",{className:"px-4 py-3 text-left text-[11px] font-semibold text-gray-500 uppercase tracking-wider hidden lg:table-cell",children:"Date"})]}):e.jsxs(e.Fragment,{children:[e.jsx("th",{className:"px-4 py-3 text-left text-[11px] font-semibold text-gray-500 uppercase tracking-wider",children:"Deleted By"}),e.jsx("th",{className:"px-4 py-3 text-left text-[11px] font-semibold text-gray-500 uppercase tracking-wider",children:"Reason"}),e.jsx("th",{className:"px-4 py-3 text-left text-[11px] font-semibold text-gray-500 uppercase tracking-wider",children:"Deleted At"}),e.jsx("th",{className:"px-4 py-3 text-right text-[11px] font-semibold text-gray-500 uppercase tracking-wider",children:"Expires In"})]}),e.jsx("th",{className:"px-4 py-3 text-right text-[11px] font-semibold text-gray-500 uppercase tracking-wider w-24",children:"Actions"})]}),e.jsxs("tr",{className:"bg-white border-b border-gray-100",children:[e.jsx("td",{className:"px-5 py-2"}),e.jsx("td",{className:"px-5 py-2",children:e.jsx("input",{type:"text",placeholder:"Filter Client...",value:w.siteName,onChange:t=>ee(s=>({...s,siteName:t.target.value})),className:"w-full text-[10px] px-2 py-1 bg-gray-50 border border-gray-200 rounded focus:border-emerald-500 outline-none transition-all"})}),x==="active"?e.jsxs(e.Fragment,{children:[e.jsx("td",{className:"px-4 py-2"}),e.jsx("td",{className:"px-4 py-2"}),e.jsx("td",{className:"px-4 py-2 hidden md:table-cell"}),e.jsx("td",{className:"px-4 py-2 hidden md:table-cell"}),e.jsx("td",{className:"px-4 py-2"}),e.jsx("td",{className:"px-4 py-2",children:e.jsxs("select",{value:w.status,onChange:t=>ee(s=>({...s,status:t.target.value})),className:"w-full text-[10px] px-1 py-1 bg-gray-50 border border-gray-200 rounded focus:border-emerald-500 outline-none transition-all font-bold text-gray-600",children:[e.jsx("option",{value:"",children:"All Status"}),e.jsx("option",{value:"profit",children:"Profit"}),e.jsx("option",{value:"loss",children:"Loss"})]})}),e.jsx("td",{className:"px-4 py-2 hidden lg:table-cell"})]}):e.jsxs(e.Fragment,{children:[e.jsx("td",{className:"px-4 py-2"}),e.jsx("td",{className:"px-4 py-2"}),e.jsx("td",{className:"px-4 py-2"}),e.jsx("td",{className:"px-4 py-2"})]}),e.jsx("td",{className:"px-4 py-2"})]})]}),e.jsx("tbody",{className:"divide-y divide-gray-100",children:_.map(t=>{const s=(t.billedAmount||0)-(t.contractAmount||0),a=(t.billedManagementFee||0)-(t.contractManagementFee||0),n=s+a>=0,o=d.has(t.id);let i=0;if(t.deletedAt){const m=new Date(t.deletedAt);m.setDate(m.getDate()+7);const k=m.getTime()-new Date().getTime();i=Math.max(0,Math.ceil(k/(1e3*60*60*24)))}return e.jsxs("tr",{className:`hover:bg-gray-50/60 transition-colors duration-100 group ${o?"bg-emerald-50/30":""}`,children:[e.jsx("td",{className:"px-5 py-3.5",children:e.jsx("input",{type:"checkbox",className:"w-4 h-4 rounded border-gray-300 text-emerald-600 focus:ring-emerald-500 cursor-pointer",checked:o,onChange:()=>Te(t.id)})}),e.jsxs("td",{className:"px-5 py-3.5",children:[e.jsx("div",{className:"font-semibold text-gray-900 text-sm",children:t.siteName}),e.jsx("div",{className:"text-[11px] text-gray-400 mt-0.5",children:t.companyName||"—"}),x==="log"&&t.billingMonth&&e.jsxs("div",{className:"text-[10px] text-emerald-600 font-bold mt-1 uppercase tracking-tighter",children:["For ",M(new Date(t.billingMonth),"MMM yyyy")]})]}),x==="active"?e.jsxs(e.Fragment,{children:[e.jsx("td",{className:"px-4 py-3.5 text-right font-mono text-sm text-gray-600",children:p(t.contractAmount)}),e.jsx("td",{className:"px-4 py-3.5 text-right font-mono text-sm font-semibold text-gray-900",children:p(t.billedAmount)}),e.jsx("td",{className:"px-4 py-3.5 text-right font-mono text-sm text-gray-600 hidden md:table-cell",children:p(t.contractManagementFee)}),e.jsx("td",{className:"px-4 py-3.5 text-right font-mono text-sm font-semibold text-gray-900 hidden md:table-cell",children:p(t.billedManagementFee)}),e.jsxs("td",{className:`px-4 py-3.5 text-right font-mono text-sm font-bold ${n?"text-emerald-600":"text-rose-600"}`,children:[n?"+":"",p(s+a)]}),e.jsx("td",{className:"px-4 py-3.5 text-center",children:e.jsxs("span",{className:`inline-flex items-center gap-1 px-2 py-0.5 rounded-full text-[10px] font-bold ${n?"bg-emerald-50 text-emerald-700":"bg-rose-50 text-rose-700"}`,children:[e.jsx("span",{className:`w-1.5 h-1.5 rounded-full ${n?"bg-emerald-500":"bg-rose-500"}`}),n?"Profit":"Loss"]})}),e.jsx("td",{className:"px-4 py-3.5 hidden lg:table-cell",children:e.jsxs("div",{className:"flex flex-col gap-0.5",children:[(t.createdByName||t.createdByRole)&&e.jsxs("div",{className:"flex items-center gap-1.5",children:[t.createdByName&&e.jsx("span",{className:"text-[11px] font-bold text-gray-700",children:t.createdByName.split(" ")[0]}),t.createdByRole&&e.jsx("span",{className:"text-[9px] px-1.5 py-0.5 bg-gray-100 text-gray-500 rounded font-black uppercase tracking-tighter",children:t.createdByRole.replace("_"," ")})]}),t.createdAt&&e.jsx("div",{className:"text-[10px] text-gray-400",children:M(new Date(t.createdAt),"MMM d, h:mm a")})]})}),e.jsx("td",{className:"px-4 py-3.5 text-right",children:e.jsxs("div",{className:"flex items-center justify-end gap-0.5 opacity-60 group-hover:opacity-100 transition-opacity duration-150",children:[e.jsx("button",{onClick:()=>Q(`/finance/site-tracker/edit/${t.id}`),className:"p-1.5 text-gray-400 hover:text-emerald-600 hover:bg-emerald-50 rounded-md transition-all",title:"Edit",children:e.jsx(qe,{className:"h-3.5 w-3.5"})}),e.jsx("button",{onClick:()=>{q(t),L(!1),R(!0)},className:"p-1.5 text-gray-400 hover:text-rose-600 hover:bg-rose-50 rounded-md transition-all",title:"Delete",children:e.jsx(U,{className:"h-3.5 w-3.5"})})]})})]}):e.jsxs(e.Fragment,{children:[e.jsx("td",{className:"px-4 py-3.5 text-sm text-gray-600",children:t.deletedByName||"—"}),e.jsx("td",{className:"px-4 py-3.5 text-[11px] text-gray-500 max-w-[200px] truncate",title:t.deletedReason,children:t.deletedReason||"—"}),e.jsx("td",{className:"px-4 py-3.5 text-[11px] text-gray-400",children:t.deletedAt&&M(new Date(t.deletedAt),"MMM d, h:mm a")}),e.jsxs("td",{className:"px-4 py-3.5 text-right text-[11px] font-bold text-rose-500",children:[i," days"]}),e.jsx("td",{className:"px-4 py-3.5 text-right",children:c?.role==="admin"?e.jsxs("div",{className:"flex items-center justify-end gap-1.5",children:[e.jsxs("button",{onClick:()=>De(t.id),disabled:P===t.id,className:"px-2.5 py-1 text-[10px] font-bold text-emerald-600 bg-emerald-50 rounded-md hover:bg-emerald-100 transition-all flex items-center gap-1 disabled:opacity-50",children:[P===t.id?e.jsx(W,{className:"h-3 w-3 animate-spin"}):e.jsx(ne,{className:"h-3 w-3"}),"Restore"]}),e.jsx("button",{onClick:()=>Ce(t.id),className:"p-1.5 text-gray-300 hover:text-rose-600 hover:bg-rose-50 rounded-md transition-all",title:"Permanently Delete",children:e.jsx(U,{className:"h-3.5 w-3.5"})})]}):e.jsx("span",{className:"text-[10px] font-medium text-gray-400 italic",children:"Admin only"})})]})]},t.id)})})]})}),V>1&&e.jsxs("div",{className:"px-5 py-3 border-t border-gray-100 flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"text-xs text-gray-400",children:"Rows per page:"}),e.jsxs("select",{value:S,onChange:t=>{Be(Number(t.target.value)),C(1)},className:"h-7 px-2 text-[11px] font-bold text-gray-600 bg-gray-50 border border-gray-200 rounded outline-none focus:border-emerald-500 transition-all cursor-pointer",children:[e.jsx("option",{value:10,children:"10"}),e.jsx("option",{value:15,children:"15"}),e.jsx("option",{value:20,children:"20"}),e.jsx("option",{value:50,children:"50"})]})]}),e.jsxs("p",{className:"text-xs text-gray-400",children:["Showing ",(v-1)*S+1,"–",Math.min(v*S,A.length)," of ",A.length]})]}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx("button",{onClick:()=>C(t=>Math.max(1,t-1)),disabled:v===1,className:"px-2.5 py-1 text-xs font-medium text-gray-500 bg-white border border-gray-200 rounded-md hover:bg-gray-50 disabled:opacity-40 disabled:cursor-not-allowed transition-all",children:"Prev"}),Array.from({length:V},(t,s)=>s+1).map(t=>e.jsx("button",{onClick:()=>C(t),className:`w-7 h-7 text-xs font-medium rounded-md transition-all ${t===v?"bg-[#006B3F] text-white shadow-sm":"text-gray-500 hover:bg-gray-50"}`,children:t},t)),e.jsx("button",{onClick:()=>C(t=>Math.min(V,t+1)),disabled:v===V,className:"px-2.5 py-1 text-xs font-medium text-gray-500 bg-white border border-gray-200 rounded-md hover:bg-gray-50 disabled:opacity-40 disabled:cursor-not-allowed transition-all",children:"Next"})]})]})]})]}),O&&e.jsx(Le,{message:O.message,type:O.type,onDismiss:()=>l(null)}),I.length>0&&e.jsx("div",{className:"fixed inset-0 z-[100] flex items-center justify-center p-4 bg-black/40 backdrop-blur-sm",children:e.jsxs("div",{className:"bg-white rounded-xl w-full max-w-5xl max-h-[85vh] flex flex-col shadow-2xl overflow-hidden border border-gray-200",children:[e.jsxs("div",{className:"px-6 py-5 border-b border-gray-100 flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("h2",{className:"text-lg font-bold text-gray-900",children:"Import Preview"}),e.jsxs("p",{className:"text-sm text-gray-500 mt-0.5",children:[I.length," records ready to import"]})]}),e.jsx("button",{onClick:()=>$([]),className:"p-1.5 hover:bg-gray-100 rounded-lg transition-colors",children:e.jsx(le,{className:"h-5 w-5 rotate-45 text-gray-400"})})]}),e.jsx("div",{className:"flex-1 overflow-auto",children:e.jsxs("table",{className:"w-full text-sm",children:[e.jsx("thead",{className:"bg-gray-50 border-b border-gray-200 sticky top-0 z-10",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-5 py-3 text-left text-[11px] font-semibold text-gray-500 uppercase tracking-wider",children:"Site Name"}),e.jsx("th",{className:"px-4 py-3 text-right text-[11px] font-semibold text-gray-500 uppercase tracking-wider",children:"Contract"}),e.jsx("th",{className:"px-4 py-3 text-right text-[11px] font-semibold text-gray-500 uppercase tracking-wider",children:"Fee"}),e.jsx("th",{className:"px-4 py-3 text-right text-[11px] font-semibold text-gray-500 uppercase tracking-wider",children:"Billed"}),e.jsx("th",{className:"px-4 py-3 text-right text-[11px] font-semibold text-gray-500 uppercase tracking-wider",children:"Billed Fee"}),e.jsx("th",{className:"px-4 py-3 text-right text-[11px] font-semibold text-gray-500 uppercase tracking-wider",children:"Net Var"})]})}),e.jsx("tbody",{className:"divide-y divide-gray-100",children:I.map((t,s)=>{const a=(t.contractAmount||0)+(t.contractManagementFee||0),o=(t.billedAmount||0)+(t.billedManagementFee||0)-a,i=o>=0;return e.jsxs("tr",{className:"hover:bg-gray-50/50 transition-colors",children:[e.jsxs("td",{className:"px-5 py-3",children:[e.jsx("div",{className:"font-semibold text-gray-900",children:t.siteName}),e.jsx("div",{className:"text-[11px] text-gray-400 mt-0.5",children:t.companyName})]}),e.jsx("td",{className:"px-4 py-3 text-right font-mono text-gray-600",children:p(t.contractAmount||0)}),e.jsx("td",{className:"px-4 py-3 text-right font-mono text-gray-600",children:p(t.contractManagementFee||0)}),e.jsx("td",{className:"px-4 py-3 text-right font-mono font-semibold text-gray-900",children:p(t.billedAmount||0)}),e.jsx("td",{className:"px-4 py-3 text-right font-mono font-semibold text-gray-900",children:p(t.billedManagementFee||0)}),e.jsxs("td",{className:`px-4 py-3 text-right font-mono font-bold ${i?"text-emerald-600":"text-rose-600"}`,children:[i?"+":"",p(o)]})]},s)})})]})}),e.jsxs("div",{className:"px-6 py-4 border-t border-gray-100 bg-gray-50/50 flex justify-end gap-3",children:[e.jsx("button",{onClick:()=>$([]),className:"px-5 py-2 text-sm font-semibold text-gray-600 bg-white border border-gray-200 rounded-lg hover:bg-gray-50 transition-all",children:"Cancel"}),e.jsxs("button",{onClick:ve,disabled:oe,className:"inline-flex items-center gap-1.5 px-6 py-2 text-sm font-bold text-white bg-[#006B3F] rounded-lg hover:bg-[#005632] transition-all shadow-sm disabled:opacity-50",children:[oe&&e.jsx(W,{className:"h-3.5 w-3.5 animate-spin"}),"Confirm Import"]})]})]})}),d.size>0&&e.jsx("div",{className:"fixed bottom-6 left-1/2 -translate-x-1/2 z-50 animate-in fade-in slide-in-from-bottom-4 duration-300",children:e.jsxs("div",{className:"bg-gray-900 text-white px-6 py-3 rounded-full shadow-2xl flex items-center gap-6",children:[e.jsxs("span",{className:"text-sm font-medium border-r border-gray-700 pr-6",children:[d.size," records selected"]}),e.jsxs("div",{className:"flex items-center gap-3",children:[x==="active"?e.jsxs("button",{onClick:()=>{L(!0),R(!0)},className:"flex items-center gap-2 px-4 py-1.5 bg-red-500 hover:bg-red-600 rounded-full text-xs font-bold transition-all",children:[e.jsx(U,{size:14}),"Delete Selected"]}):e.jsxs(e.Fragment,{children:[e.jsxs("button",{onClick:Re,disabled:P==="bulk",className:"flex items-center gap-2 px-4 py-1.5 bg-emerald-600 hover:bg-emerald-700 rounded-full text-xs font-bold transition-all disabled:opacity-50",children:[e.jsx(Ge,{size:14,className:P==="bulk"?"animate-spin":""}),"Restore Selected"]}),e.jsxs("button",{onClick:Ae,disabled:!Y,className:"flex items-center gap-2 px-4 py-1.5 bg-rose-600 hover:bg-rose-700 rounded-full text-xs font-bold transition-all disabled:opacity-50",children:[e.jsx(He,{size:14}),"Permanently Delete"]})]}),e.jsx("button",{onClick:()=>b(new Set),className:"px-4 py-1.5 hover:bg-white/10 rounded-full text-xs font-medium transition-all",children:"Cancel"})]})]})}),Ie&&e.jsx("div",{className:"fixed inset-0 bg-black/60 backdrop-blur-sm z-[110] flex items-center justify-center p-4",children:e.jsx("div",{className:"bg-white rounded-2xl shadow-2xl max-w-md w-full overflow-hidden animate-in zoom-in-95 duration-200",children:e.jsxs("div",{className:"p-6",children:[e.jsxs("div",{className:"flex items-center gap-4 mb-6",children:[e.jsx("div",{className:"w-12 h-12 bg-red-100 rounded-xl flex items-center justify-center text-red-600",children:e.jsx(U,{size:24})}),e.jsxs("div",{children:[e.jsx("h3",{className:"text-xl font-bold text-gray-900",children:te?`Delete ${d.size} Records`:"Delete Record"}),e.jsx("p",{className:"text-sm text-gray-500 mt-1",children:"Records will be moved to the Deletion Log."})]})]}),!te&&D&&e.jsxs("div",{className:"bg-gray-50 rounded-xl p-4 mb-6 border border-gray-100",children:[e.jsx("p",{className:"text-xs font-bold text-gray-400 uppercase tracking-wider mb-2",children:"Selected Site"}),e.jsx("p",{className:"text-sm font-semibold text-gray-900",children:D.siteName}),e.jsx("p",{className:"text-xs text-gray-500 mt-0.5",children:D.companyName})]}),e.jsxs("div",{className:"mb-6",children:[e.jsx("label",{className:"block text-sm font-semibold text-gray-700 mb-2",children:"Reason for Deletion"}),e.jsx("textarea",{value:G,onChange:t=>H(t.target.value),placeholder:"Enter reason...",className:"w-full h-24 px-4 py-3 bg-gray-50 border-2 border-transparent focus:border-red-500 rounded-xl outline-none transition-all resize-none text-sm"})]}),e.jsxs("div",{className:"bg-amber-50 rounded-xl p-4 border border-amber-100 mb-6 flex items-start gap-3",children:[e.jsx(Ye,{className:"text-amber-600 flex-shrink-0 mt-0.5",size:16}),e.jsx("p",{className:"text-xs text-amber-800 leading-relaxed font-medium",children:"Records can be restored from the Deletion Log within 7 days. After 7 days, they will be permanently deleted."})]}),e.jsxs("div",{className:"flex gap-3",children:[e.jsx("button",{onClick:()=>{R(!1),q(null),L(!1)},className:"flex-1 py-3 px-4 bg-gray-100 hover:bg-gray-200 text-gray-700 rounded-xl text-sm font-bold transition-all",children:"Cancel"}),e.jsx("button",{onClick:()=>Fe(G),disabled:!G.trim()||pe,className:"flex-2 py-3 px-6 bg-red-600 hover:bg-red-700 disabled:opacity-50 disabled:cursor-not-allowed text-white rounded-xl text-sm font-bold shadow-lg shadow-red-200 transition-all flex items-center justify-center gap-2",children:pe?"Deleting...":"Confirm Deletion"})]})]})})})]})};export{ot as default};
