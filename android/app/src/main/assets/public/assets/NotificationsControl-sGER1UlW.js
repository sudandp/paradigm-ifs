import{j as e,T as J,B as u,p as j,m,I as K}from"./index-D5q3SS3D.js";import{b as i}from"./react-vendor-BUaIliXj.js";import{A as Q}from"./AdminPageHeader-wINx_pXe.js";import{S as g}from"./Select-Dz12MdxG.js";import{p as A,a4 as C,b4 as U,ao as Z,X as ee,aw as k,L as se,b5 as ae,b as F,T as L,b6 as te,U as le,ar as ie,e as S,z as re,k as ne,a5 as ce,b7 as de,aI as oe,B as O,F as me,S as B,m as ue,b8 as pe,at as xe}from"./ui-vendor-B8EvWqdc.js";import"./pdf-vendor-CB_F1AVu.js";import"./capacitor-vendor-CqiIOUn1.js";import"./utils-vendor-DmorxLnX.js";import"./supabase-7WG3J4rU.js";const P=[{value:"check_in",label:"Check-in (Punch In)",icon:k},{value:"check_out",label:"Check-out (Punch Out)",icon:se},{value:"break_in",label:"Break Start",icon:ae},{value:"break_out",label:"Break End",icon:F},{value:"violation",label:"Geofencing Violation",icon:L},{value:"field_report",label:"Field Report Submission",icon:te},{value:"onboarding_submitted",label:"New Enrollment Submission",icon:le},{value:"onboarding_verified",label:"Enrollment Verified",icon:ie},{value:"onboarding_rejected",label:"Enrollment Rejected / Change Request",icon:S},{value:"task_assigned",label:"Task Assigned",icon:re},{value:"task_completed",label:"Task Completed",icon:ne},{value:"leave_request",label:"Leave Request Applied",icon:ce},{value:"leave_approved",label:"Leave Approved",icon:k},{value:"leave_rejected",label:"Leave Rejected",icon:S},{value:"salary_request",label:"Salary Change Request",icon:de},{value:"salary_approved",label:"Salary Change Approved",icon:k},{value:"salary_rejected",label:"Salary Change Rejected",icon:S},{value:"support_ticket",label:"New Support Ticket",icon:oe},{value:"support_response",label:"Support Response Received",icon:O},{value:"billing_invoice",label:"Invoice Generated",icon:me},{value:"punch_unlock_request",label:"Punch Unlock Request",icon:B},{value:"ot_punch",label:"Overtime (OT) Punch",icon:F},{value:"security_alert",label:"Emergency / Security Alert",icon:B}],D=[{value:"direct_manager",label:"Direct Reporting Manager"},{value:"hr",label:"HR Admin"},{value:"ops_manager",label:"Operations Manager"},{value:"admin",label:"System Administrator"},{value:"finance",label:"Finance Team"}],he=[{value:"info",label:"Information"},{value:"security",label:"Security Alert"},{value:"task_assigned",label:"Task Update"},{value:"greeting",label:"General / Greeting"}],Ce=()=>{const[f,T]=i.useState("rules"),[c,p]=i.useState([]),[q,M]=i.useState([]),[N,$]=i.useState([]),[G,H]=i.useState(!0),[E,v]=i.useState(!1),[d,I]=i.useState(!1),[y,l]=i.useState(null),[n,x]=i.useState({eventType:"check_in",recipientRole:"direct_manager",isEnabled:!0,sendAlert:!1}),[a,h]=i.useState({role:"",userIds:[],title:"",message:"",type:"info"});i.useEffect(()=>{(async()=>{try{const[t,o,b]=await Promise.all([m.getNotificationRules(),m.getRoles(),m.getUsers()]);p(t),M(o),$(b.sort((R,r)=>(R.name||"").localeCompare(r.name||"")))}catch{l({message:"Failed to load data.",type:"error"})}finally{H(!1)}})()},[]);const V=async()=>{v(!0);try{const s=await m.saveNotificationRule(n);d?(p(c.map(t=>t.id===s.id?s:t)),l({message:"Rule updated successfully.",type:"success"})):(p([s,...c]),l({message:"Rule added successfully.",type:"success"})),w()}catch{l({message:d?"Failed to update rule.":"Failed to add rule.",type:"error"})}finally{v(!1)}},W=s=>{x({id:s.id,eventType:s.eventType,recipientRole:s.recipientRole,recipientUserId:s.recipientUserId,isEnabled:s.isEnabled}),I(!0),window.innerWidth<1024&&window.scrollTo({top:0,behavior:"smooth"})},w=()=>{x({eventType:"check_in",recipientRole:"direct_manager",isEnabled:!0,sendAlert:!1}),I(!1)},X=async s=>{try{const t=await m.saveNotificationRule({...s,isEnabled:!s.isEnabled});p(c.map(o=>o.id===s.id?t:o))}catch{l({message:"Failed to update rule.",type:"error"})}},Y=async s=>{if(confirm("Are you sure you want to delete this rule?"))try{await m.deleteNotificationRule(s),p(c.filter(t=>t.id!==s)),l({message:"Rule deleted.",type:"success"})}catch{l({message:"Failed to delete rule.",type:"error"})}},z=async()=>{if(!a.message){l({message:"Please enter a message.",type:"error"});return}v(!0);try{await m.broadcastNotification(a),l({message:"Broadcast sent successfully!",type:"success"}),h({role:"",userIds:[],title:"",message:"",type:"info"})}catch{l({message:"Failed to send broadcast.",type:"error"})}finally{v(!1)}};return G?e.jsx("div",{className:"flex items-center justify-center min-h-[400px]",children:e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-emerald-500"})}):e.jsxs("div",{className:"space-y-6 pb-20",children:[y&&e.jsx(J,{message:y.message,type:y.type,onDismiss:()=>l(null)}),e.jsx(Q,{title:"Notification Management",children:e.jsxs("div",{className:"flex gap-2",children:[e.jsxs(u,{variant:"secondary",onClick:()=>T("rules"),className:f==="rules"?"bg-accent text-white":"",children:[e.jsx(A,{className:"mr-2 h-4 w-4"})," Rules"]}),e.jsxs(u,{variant:"secondary",onClick:()=>T("broadcast"),className:f==="broadcast"?"bg-accent text-white":"",children:[e.jsx(C,{className:"mr-2 h-4 w-4"})," Broadcast"]})]})}),f==="rules"?e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-3 gap-8",children:[e.jsxs("div",{className:"lg:col-span-1 space-y-6",children:[e.jsxs("section",{className:`bg-card p-6 rounded-xl border shadow-sm transition-all duration-300 ${d?"border-accent ring-1 ring-accent/20":"border-border"}`,children:[e.jsxs("h3",{className:"text-lg font-semibold mb-4 flex items-center justify-between",children:[e.jsxs("span",{className:"flex items-center",children:[d?e.jsx(U,{className:"mr-2 h-5 w-5 text-accent"}):e.jsx(Z,{className:"mr-2 h-5 w-5 text-accent"}),d?"Edit Dispatch Rule":"New Dispatch Rule"]}),d&&e.jsx("button",{onClick:w,className:"text-muted hover:text-primary-text p-1",children:e.jsx(ee,{className:"h-4 w-4"})})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsx(g,{label:"When event occurs...",value:n.eventType,onChange:s=>x({...n,eventType:s.target.value}),children:P.map(s=>e.jsx("option",{value:s.value,children:s.label},s.value))}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("p",{className:"text-sm font-medium text-primary-text",children:"Notify this recipient..."}),e.jsxs(g,{value:n.recipientRole||"",onChange:s=>x({...n,recipientRole:s.target.value,recipientUserId:void 0}),children:[e.jsx("option",{value:"",children:"Select Role"}),D.map(s=>e.jsx("option",{value:s.value,children:s.label},s.value))]}),e.jsxs("div",{className:"relative flex items-center py-2",children:[e.jsx("div",{className:"flex-grow border-t border-border"}),e.jsx("span",{className:"flex-shrink mx-4 text-xs text-muted uppercase",children:"Or Specific User"}),e.jsx("div",{className:"flex-grow border-t border-border"})]}),e.jsxs(g,{value:n.recipientUserId||"",onChange:s=>x({...n,recipientUserId:s.target.value,recipientRole:void 0}),children:[e.jsx("option",{value:"",children:"Select User"}),e.jsx("option",{value:"all",children:"All Users"}),N.map(s=>e.jsx("option",{value:s.id,children:s.name},s.id))]})]}),e.jsxs("div",{className:"space-y-4 pt-2",children:[e.jsx(j,{id:"newRuleSendAlert",label:"Trigger standard Alert / Warning UI",checked:n.sendAlert,onChange:s=>x({...n,sendAlert:s.target.checked})}),e.jsx(u,{className:"w-full",onClick:V,isLoading:E,children:d?"Update Rule":"Create Rule"}),d&&e.jsx(u,{variant:"secondary",className:"w-full",onClick:w,children:"Cancel Edit"})]})]})]}),e.jsx("div",{className:"p-4 bg-accent/5 rounded-xl border border-accent/10",children:e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx(ue,{className:"h-5 w-5 text-accent mt-0.5"}),e.jsxs("div",{className:"text-sm text-primary-text/80 space-y-2",children:[e.jsx("p",{children:"Rules define automatic notification routing based on system events."}),e.jsxs("p",{children:[e.jsx("strong",{children:"Example:"}),' If you set "Violation" to "HR Admin", every geofencing violation will trigger an alert to all HR users.']})]})]})})]}),e.jsxs("div",{className:"lg:col-span-2 space-y-4",children:[e.jsx("div",{className:"flex items-center justify-between mb-4",children:e.jsxs("h3",{className:"text-lg font-semibold flex items-center",children:[e.jsx(pe,{className:"mr-2 h-5 w-5 text-muted"})," Active Rules (",c.length,")"]})}),c.map(s=>{const t=P.find(r=>r.value===s.eventType),o=t?.icon||O,b=s.recipientUserId?N.find(r=>r.id===s.recipientUserId):null,R=D.find(r=>r.value===s.recipientRole);return e.jsx("div",{className:`bg-card p-4 rounded-xl border transition-all ${s.isEnabled?"border-border":"border-dashed opacity-60"}`,children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx("div",{className:`p-2 rounded-lg ${s.isEnabled?"bg-accent/10 text-accent":"bg-muted/10 text-muted"}`,children:e.jsx(o,{className:"h-5 w-5"})}),e.jsxs("div",{children:[e.jsx("p",{className:"font-semibold text-primary-text",children:t?.label||s.eventType}),e.jsxs("p",{className:"text-sm text-muted",children:["Notifies: ",e.jsx("span",{className:"font-medium text-emerald-600",children:s.recipientUserId==="all"?"All Users":b?`User: ${b.name}`:R?.label||s.recipientRole})]})]})]}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsxs("div",{className:"flex items-center gap-4 border-r border-border px-4",children:[e.jsx(u,{variant:"icon",onClick:()=>W(s),className:"text-accent hover:bg-accent/5 h-8 w-8",title:"Edit Rule",children:e.jsx(U,{className:"h-4 w-4"})}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"text-[10px] text-muted uppercase font-bold tracking-wider",children:"Alert"}),e.jsx(j,{id:`alert-${s.id}`,label:"",checked:s.sendAlert,onChange:async()=>{try{const r=await m.saveNotificationRule({...s,sendAlert:!s.sendAlert});p(c.map(_=>_.id===s.id?r:_))}catch{l({message:"Failed to update alert setting.",type:"error"})}}})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"text-[10px] text-muted uppercase font-bold tracking-wider",children:"Active"}),e.jsx(j,{id:`rule-${s.id}`,label:"",checked:s.isEnabled,onChange:()=>X(s)})]})]}),e.jsx(u,{variant:"icon",onClick:()=>Y(s.id),className:"text-red-500 hover:bg-red-50 h-8 w-8",title:"Delete Rule",children:e.jsx(xe,{className:"h-4 w-4"})})]})]})},s.id)}),c.length===0&&e.jsxs("div",{className:"text-center py-20 bg-card rounded-xl border border-dashed border-border",children:[e.jsx(A,{className:"h-12 w-12 text-muted mx-auto mb-4 opacity-20"}),e.jsx("p",{className:"text-muted",children:"No dispatch rules configured yet."})]})]})]}):e.jsxs("div",{className:"max-w-3xl mx-auto space-y-6",children:[e.jsxs("section",{className:"bg-card p-8 rounded-2xl border border-border shadow-lg",children:[e.jsxs("div",{className:"flex items-center gap-4 mb-8",children:[e.jsx("div",{className:"p-3 bg-emerald-500 rounded-2xl text-white shadow-emerald-200 shadow-xl",children:e.jsx(C,{className:"h-6 w-6"})}),e.jsxs("div",{children:[e.jsx("h3",{className:"text-xl font-bold",children:"Compose Broadcast"}),e.jsx("p",{className:"text-muted text-sm",children:"Send a custom notification to targeted groups."})]})]}),e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:[e.jsxs(g,{label:"Target Audience",value:a.role,onChange:s=>h({...a,role:s.target.value,userIds:[]}),children:[e.jsx("option",{value:"",children:"Specific Users"}),e.jsx("option",{value:"all",children:"Everyone"}),q.map(s=>e.jsx("option",{value:s.id,children:s.displayName},s.id))]}),e.jsx(g,{label:"Alert Level",value:a.type,onChange:s=>h({...a,type:s.target.value}),children:he.map(s=>e.jsx("option",{value:s.value,children:s.label},s.value))})]}),!a.role&&e.jsxs("div",{className:"space-y-2",children:[e.jsx("p",{className:"text-sm font-medium text-primary-text",children:"Select Recipients"}),e.jsx("div",{className:"grid grid-cols-2 sm:grid-cols-3 gap-2 max-h-40 overflow-y-auto p-3 border border-border rounded-xl bg-page/50",children:N.map(s=>e.jsx(j,{label:s.name,className:"hover:bg-white rounded-lg transition-colors p-1",labelClassName:"text-xs truncate",checked:a.userIds.includes(s.id),onChange:t=>{const o=t.target.checked?[...a.userIds,s.id]:a.userIds.filter(b=>b!==s.id);h({...a,userIds:o})}},s.id))})]}),e.jsx(K,{label:"Subject / Title",placeholder:"e.g. Office Closure Notice",value:a.title,onChange:s=>h({...a,title:s.target.value})}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("p",{className:"text-sm font-medium text-primary-text",children:"Message Content"}),e.jsx("textarea",{className:"w-full h-32 p-4 rounded-xl border border-border focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 bg-white",placeholder:"Type your message here...",value:a.message,onChange:s=>h({...a,message:s.target.value})})]}),e.jsxs(u,{className:"w-full h-12 text-lg shadow-emerald-100 shadow-xl",onClick:z,isLoading:E,disabled:!a.message,children:[e.jsx(C,{className:"mr-2 h-5 w-5"})," Send Notification"]})]})]}),e.jsxs("div",{className:"p-6 bg-amber-50 rounded-2xl border border-amber-200 flex gap-4",children:[e.jsx(L,{className:"h-6 w-6 text-amber-600 shrink-0"}),e.jsxs("div",{children:[e.jsx("h4",{className:"font-bold text-amber-800",children:"Broadcast Caution"}),e.jsx("p",{className:"text-amber-700 text-sm",children:"Manual broadcasts are sent immediately to the selected users' notification centers. Use this tool responsibly for critical updates or universal reminders."})]})]})]})]})};export{Ce as default};
