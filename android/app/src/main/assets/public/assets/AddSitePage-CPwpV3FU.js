import{k as R,c as Q,o as V,m as A,j as e,I as y,T as G,B as q,d as _,Q as H,e as L}from"./index-D5q3SS3D.js";import{u as J,b as t}from"./react-vendor-BUaIliXj.js";import{S as v}from"./Select-Dz12MdxG.js";import{D as F,a2 as P}from"./ui-vendor-B8EvWqdc.js";import"./pdf-vendor-CB_F1AVu.js";import"./capacitor-vendor-CqiIOUn1.js";import"./utils-vendor-DmorxLnX.js";import"./supabase-7WG3J4rU.js";const K=_({groupId:L().required("Please select a group"),companyId:L().required("Please select a company"),clientId:L().required("Please select a client"),manpowerCount:H().typeError("Must be a number").min(0,"Cannot be negative").required("Manpower count is required")}).defined(),ae=()=>{const C=J(),D=R("(max-width: 767px)"),[h,T]=t.useState([]),[w,E]=t.useState(!0),[c,I]=t.useState(!1),[m,u]=t.useState(""),[M,i]=t.useState(!1),[o,l]=t.useState(null),g=t.useRef(null),{register:d,handleSubmit:N,watch:z,formState:{errors:r},setValue:n}=Q({resolver:V(K)}),p=z("groupId"),x=z("companyId");t.useEffect(()=>{E(!0),A.getOrganizationStructure().then(T).catch(()=>l({message:"Failed to load organization structure.",type:"error"})).finally(()=>E(!1))},[]),t.useEffect(()=>{n("companyId",""),n("clientId",""),u("")},[p,n]),t.useEffect(()=>{n("clientId",""),u("")},[x,n]),t.useEffect(()=>{const s=a=>{g.current&&!g.current.contains(a.target)&&i(!1)};return document.addEventListener("mousedown",s),()=>document.removeEventListener("mousedown",s)},[]);const f=t.useMemo(()=>h.find(s=>s.id===p)?.companies||[],[h,p]),b=t.useMemo(()=>f.find(s=>s.id===x)?.entities||[],[f,x]),j=t.useMemo(()=>m?b.filter(s=>s.name.toLowerCase().includes(m.toLowerCase())):b,[b,m]),O=s=>{n("clientId",s.id,{shouldValidate:!0}),u(s.name),i(!1)},S=async s=>{const a=b.find(k=>k.id===s.clientId);if(a){I(!0);try{if((await A.getOrganizations()).some(B=>B.id===a.organizationId)){l({message:"A site for this client already exists.",type:"error"}),I(!1);return}const $={id:a.organizationId||`site_${Date.now()}`,shortName:a.name,fullName:a.name,address:a.location||a.registeredAddress||"",manpowerApprovedCount:s.manpowerCount};await A.createOrganization($),l({message:"Site added successfully!",type:"success"}),setTimeout(()=>C("/admin/sites"),1500)}catch{l({message:"Failed to add site. Please try again.",type:"error"})}finally{I(!1)}}};return D?e.jsxs("div",{className:"h-full flex flex-col",children:[e.jsx("header",{className:"p-4 flex-shrink-0 fo-mobile-header",children:e.jsx("h1",{children:"Add Site"})}),e.jsx("main",{className:"flex-1 overflow-y-auto p-4",children:e.jsxs("div",{className:"bg-card rounded-2xl p-6 space-y-6",children:[e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"inline-block bg-accent-light p-3 rounded-full mb-2",children:e.jsx(F,{className:"h-8 w-8 text-accent-dark"})}),e.jsx("h2",{className:"text-xl font-bold text-primary-text",children:"Add Site from Client"}),e.jsx("p",{className:"text-sm text-gray-400",children:"Create a new site from an existing client entity."})]}),w?e.jsx("div",{className:"flex justify-center py-8",children:e.jsx(P,{className:"h-8 w-8 animate-spin text-accent"})}):e.jsxs("form",{onSubmit:N(S),className:"space-y-4",children:[e.jsxs(v,{label:"Group",id:"groupId",registration:d("groupId"),error:r.groupId?.message,children:[e.jsx("option",{value:"",children:"Select a Group"}),h.map(s=>e.jsx("option",{value:s.id,children:s.name},s.id))]}),e.jsxs(v,{label:"Company",id:"companyId",registration:d("companyId"),error:r.companyId?.message,disabled:!p,children:[e.jsx("option",{value:"",children:"Select a Company"}),f.map(s=>e.jsx("option",{value:s.id,children:s.name},s.id))]}),e.jsxs("div",{className:"relative",ref:g,children:[e.jsx(y,{label:"Client",id:"clientSearch",value:m,onChange:s=>{u(s.target.value),i(!0),n("clientId","")},onFocus:()=>i(!0),disabled:!x,error:r.clientId?.message,autoComplete:"off"}),M&&j.length>0&&e.jsx("ul",{className:"absolute z-10 w-full bg-card border border-border rounded-lg mt-1 max-h-48 overflow-y-auto shadow-lg",children:j.map(s=>e.jsx("li",{onClick:()=>O(s),className:"px-3 py-2 text-sm cursor-pointer hover:bg-page",children:s.name},s.id))})]}),e.jsx(y,{label:"Approved Manpower Count",id:"manpowerCount",type:"number",registration:d("manpowerCount"),error:r.manpowerCount?.message})]})]})}),e.jsxs("footer",{className:"p-4 flex-shrink-0 flex items-center gap-4",children:[e.jsx("button",{type:"button",onClick:()=>C("/admin/sites"),disabled:c,className:"fo-btn-secondary px-6",children:"Cancel"}),e.jsx("button",{type:"submit",onClick:N(S),disabled:c||w,className:"fo-btn-primary flex-1",children:c?"Adding...":"Add Site"})]}),o&&e.jsx(G,{message:o.message,type:o.type,onDismiss:()=>l(null)})]}):e.jsxs("div",{className:"p-4 md:p-6",children:[e.jsxs("div",{className:"bg-card p-8 rounded-xl shadow-card w-full",children:[e.jsxs("div",{className:"flex items-center mb-6",children:[e.jsx("div",{className:"bg-accent-light p-3 rounded-full mr-4",children:e.jsx(F,{className:"h-8 w-8 text-accent-dark"})}),e.jsxs("div",{children:[e.jsx("h2",{className:"text-2xl font-bold text-primary-text",children:"Add Site from Client"}),e.jsx("p",{className:"text-muted",children:"Create a new site from an existing client entity."})]})]}),w?e.jsx("div",{className:"flex justify-center py-12",children:e.jsx(P,{className:"h-8 w-8 animate-spin text-accent"})}):e.jsxs("form",{onSubmit:N(S),className:"space-y-6",children:[e.jsxs(v,{label:"Group",id:"groupId",registration:d("groupId"),error:r.groupId?.message,children:[e.jsx("option",{value:"",children:"Select a Group"}),h.map(s=>e.jsx("option",{value:s.id,children:s.name},s.id))]}),e.jsxs(v,{label:"Company",id:"companyId",registration:d("companyId"),error:r.companyId?.message,disabled:!p,children:[e.jsx("option",{value:"",children:"Select a Company"}),f.map(s=>e.jsx("option",{value:s.id,children:s.name},s.id))]}),e.jsxs("div",{className:"relative",ref:g,children:[e.jsx(y,{label:"Client",id:"clientSearch",value:m,onChange:s=>{u(s.target.value),i(!0),n("clientId","")},onFocus:()=>i(!0),disabled:!x,error:r.clientId?.message,autoComplete:"off"}),M&&j.length>0&&e.jsx("ul",{className:"absolute z-10 w-full bg-card border border-border rounded-lg mt-1 max-h-48 overflow-y-auto shadow-lg",children:j.map(s=>e.jsx("li",{onClick:()=>O(s),className:"px-3 py-2 text-sm cursor-pointer hover:bg-page",children:s.name},s.id))})]}),e.jsx(y,{label:"Approved Manpower Count",id:"manpowerCount",type:"number",registration:d("manpowerCount"),error:r.manpowerCount?.message}),e.jsxs("div",{className:"mt-8 pt-6 border-t flex justify-end gap-3",children:[e.jsx(q,{type:"button",onClick:()=>C("/admin/sites"),variant:"secondary",disabled:c,children:"Cancel"}),e.jsx(q,{type:"submit",isLoading:c,children:"Add Site"})]})]})]}),o&&e.jsx(G,{message:o.message,type:o.type,onDismiss:()=>l(null)})]})};export{ae as default};
