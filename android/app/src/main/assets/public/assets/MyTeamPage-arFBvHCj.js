import{$ as _,a0 as B,u as ce,U as de,z as me,m as c,j as e,B as v}from"./index-D5q3SS3D.js";import{b as o,L as H}from"./react-vendor-BUaIliXj.js";import{L as p}from"./leaflet-src-BVmFvWPy.js";import{C as w}from"./capacitor-vendor-CqiIOUn1.js";import{P as pe}from"./Pagination-DXf7cs0z.js";import{z as ue,aj as ge,b as z,d as xe,e as fe,U as he,j as be,O as ve}from"./ui-vendor-B8EvWqdc.js";import{k as O,m as U}from"./utils-vendor-DmorxLnX.js";import"./pdf-vendor-CB_F1AVu.js";import"./supabase-7WG3J4rU.js";const W={startTracking:(a,f)=>{console.log(`Starting tracking with interval: ${a} mins for user: ${f}`),w.getPlatform()==="android"?window.Android&&window.Android.startTracking?window.Android.startTracking(a,_,B,f):console.warn("Android Native Interface not found"):w.getPlatform()==="ios"?window.webkit?.messageHandlers?.startTracking&&window.webkit.messageHandlers.startTracking.postMessage({interval:a,url:_,key:B,userId:f}):console.log("Web platform: Tracking simulation started")},stopTracking:()=>{console.log("Stopping tracking"),w.getPlatform()==="android"?window.Android&&window.Android.stopTracking&&window.Android.stopTracking():w.getPlatform()==="ios"&&window.webkit?.messageHandlers?.stopTracking&&window.webkit.messageHandlers.stopTracking.postMessage({})}},we=`
  .custom-user-marker {
    width: 48px;
    height: 48px;
    background-size: cover;
    background-position: center;
    border: 3px solid #10b981;
    border-radius: 12px;
    position: relative;
    background-color: white;
    filter: drop-shadow(0 4px 6px rgba(0, 0, 0, 0.1));
  }
  .custom-user-marker::after {
    content: '';
    position: absolute;
    bottom: -10px;
    left: 50%;
    transform: translateX(-50%);
    width: 0;
    height: 0;
    border-left: 8px solid transparent;
    border-right: 8px solid transparent;
    border-top: 10px solid #10b981;
  }
  .user-marker-initials {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 100%;
    height: 100%;
    font-weight: bold;
    color: #10b981;
    font-size: 18px;
    text-transform: uppercase;
  }
  .leaflet-popup-content-wrapper {
    border-radius: 12px;
    padding: 4px;
  }
  .marker-popup-content {
    padding: 8px;
  }
  .marker-popup-name {
    font-weight: 700;
    margin: 0;
    color: #1f2937;
  }
  .marker-popup-status {
    font-size: 11px;
    color: #6b7280;
    margin: 4px 0 0;
  }
`,$e=()=>{const{user:a}=ce(),{theme:f}=de(),{isMobile:j,isTablet:u}=me(),[y,F]=o.useState([]),[N,G]=o.useState({}),[V,k]=o.useState(!0),[b,Q]=o.useState(""),[m,X]=o.useState("All"),[K,Z]=o.useState({}),[I,q]=o.useState({}),[S,J]=o.useState(1),[T,Y]=o.useState(12),[h,R]=o.useState(15),[E,P]=o.useState(!1),[A,M]=o.useState([]),l=o.useRef(null),C=o.useRef(null),L=o.useRef(p.layerGroup()),ee=o.useRef(null);o.useEffect(()=>{const t=document.createElement("style");return t.type="text/css",t.innerText=we,document.head.appendChild(t),se(),re(),te(),()=>{document.head.removeChild(t),l.current&&(l.current.remove(),l.current=null)}},[]);const te=async()=>{try{const{settings:t}=await c.getInitialAppData();if(t?.office?.trackingIntervalMinutes){const r=t.office.trackingIntervalMinutes;R(r),a&&W.startTracking(r,a.id)}}catch(t){console.error("Error fetching settings:",t)}},se=async()=>{if(a)try{y.length===0&&k(!0);let t=[];["admin","super_admin"].includes(a.role)?t=await c.getUsers():t=await c.getTeamMembers(a.id),F(t),k(!1);const r=t.map(s=>s.id);c.getTeamLocations(r).then(s=>{q(s);const n={};Object.values(s).forEach(({state:i,city:x})=>{n[i]||(n[i]=[]),n[i].includes(x)||n[i].push(x)});const d={};Object.keys(n).sort().forEach(i=>{d[i]=n[i].sort()}),Z(d)}).catch(s=>{console.error("Error fetching team locations:",s)}),c.getLatestLocations(r).then(s=>{G(s)}).catch(s=>{console.error("Error fetching latest locations:",s)})}catch(t){console.error("Error fetching team data:",t),k(!1)}},re=async()=>{if(!(!a||a.role==="field_staff"))try{const t=["admin","super_admin"].includes(a.role),r=await c.getAttendanceUnlockRequests(t?void 0:a.id);M(r.filter(s=>s.userId!==a.id))}catch(t){console.error("Error fetching unlock requests:",t)}},D=async(t,r)=>{try{await c.respondToUnlockRequest(t,r),M(s=>s.filter(n=>n.id!==t))}catch(s){console.error("Error responding to request:",s)}},ae=async()=>{if(!(!a||a.role!=="admin")){P(!0);try{const{settings:t}=await c.getInitialAppData(),r={...t};r.office&&(r.office={...r.office,trackingIntervalMinutes:h}),r.field&&(r.field={...r.field,trackingIntervalMinutes:h}),r.site&&(r.site={...r.site,trackingIntervalMinutes:h}),await c.updateAttendanceSettings(r),a&&W.startTracking(h,a.id),alert("Tracking interval updated successfully")}catch(t){console.error("Failed to update interval:",t),alert("Failed to update tracking interval")}finally{P(!1)}}};o.useEffect(()=>{if(C.current&&!l.current){const t="https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",r='&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',s=p.map(C.current,{zoomControl:!1,fadeAnimation:!1}).setView([12.9716,77.5946],12);l.current=s,ee.current=p.tileLayer(t,{attribution:r,maxZoom:19,zIndex:1}).addTo(s),L.current.addTo(s),p.control.zoom({position:"bottomright"}).addTo(s),setTimeout(()=>{s.invalidateSize(),setTimeout(()=>s.invalidateSize(),500)},200)}},[]),o.useEffect(()=>{l.current&&setTimeout(()=>l.current?.invalidateSize(),100)},[f]);const g=o.useMemo(()=>y.filter(t=>{const r=t.name.toLowerCase().includes(b.toLowerCase())||t.role.toLowerCase().includes(b.toLowerCase().replace(/\s+/g,"_")),s=I[t.id];let n=m==="All";if(!n&&s){if(m.startsWith("state:")){const d=m.replace("state:","");n=s.state===d}else if(m.startsWith("city:")){const d=m.split(":"),i=d[1],x=d[2];n=s.state===i&&s.city===x}}return r&&n}),[y,b,m,I]);return o.useEffect(()=>{if(!l.current)return;L.current.clearLayers();const t=[];if(g.forEach(r=>{const s=N[r.id];if(s&&s.latitude&&s.longitude){const n=r.name.split(" ").map(le=>le[0]).join("").substring(0,2),i=s&&O(new Date(s.timestamp))?"#10b981":"#ef4444",x=r.photoUrl&&(r.photoUrl.startsWith("http")||r.photoUrl.startsWith("data:")),oe=`
          <div class="custom-user-marker" style="border-color: ${i}; overflow: hidden;">
            <div class="user-marker-initials" style="color: ${i}">${n}</div>
            ${x?`<img src="${r.photoUrl}" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; z-index: 10;" onerror="this.style.display='none'" />`:""}
          </div>
        `,ne=p.divIcon({className:"",html:oe,iconSize:[48,48],iconAnchor:[24,58],popupAnchor:[0,-58]}),$=p.marker([s.latitude,s.longitude],{icon:ne}),ie=`
          <div class="marker-popup-content">
            <p class="marker-popup-name">${r.name}</p>
            <p class="marker-popup-status">Last active ${U(new Date(s.timestamp))} ago</p>
          </div>
        `;$.bindPopup(ie),L.current.addLayer($),t.push($)}}),t.length>0){const r=p.featureGroup(t);l.current.fitBounds(r.getBounds().pad(.3))}},[g,N]),e.jsxs("div",{className:`flex flex-col h-full bg-background overflow-hidden ${u?"p-2":"p-6 md:p-8"} space-y-6`,children:[e.jsxs("div",{className:`flex flex-col ${j?"gap-4":"gap-6"}`,children:[e.jsxs("div",{className:"flex flex-col md:flex-row md:items-center justify-between gap-4",children:[e.jsxs("div",{children:[e.jsx("h1",{className:`${u?"text-lg":"text-2xl"} font-bold text-primary-text`,children:"My Team"}),!u&&e.jsx("p",{className:"text-sm text-muted",children:"Real-time status and locations of your field personnel."})]}),e.jsxs("div",{className:"flex flex-wrap items-center gap-3 w-full md:w-auto",children:[["admin","developer"].includes(a?.role||"")&&e.jsx(H,{to:"/my-team/reporting",className:"w-full sm:w-auto",children:e.jsxs(v,{variant:"outline",size:"sm",className:"w-full whitespace-nowrap",children:[e.jsx(ue,{className:"w-4 h-4 mr-2"}),"Manage Structure"]})}),e.jsxs("div",{className:"flex flex-col sm:flex-row items-center gap-3 w-full md:w-auto",children:[e.jsxs("select",{id:"location-filter",name:"locationFilter",value:m,onChange:t=>X(t.target.value),className:"w-full sm:w-48 px-3 py-2 bg-card border border-border rounded-xl focus:ring-2 focus:ring-accent focus:border-transparent outline-none transition-all text-sm appearance-none cursor-pointer",children:[e.jsx("option",{value:"All",children:"All Locations"}),Object.entries(K).map(([t,r])=>e.jsxs("optgroup",{label:t,children:[e.jsxs("option",{value:`state:${t}`,children:["All ",t]}),r.map(s=>e.jsx("option",{value:`city:${t}:${s}`,children:s},`${t}-${s}`))]},t))]}),e.jsxs("div",{className:"relative w-full md:w-64",children:[e.jsx(ge,{className:"absolute left-3 top-1/2 -translate-y-1/2 text-muted w-4 h-4"}),e.jsx("input",{id:"team-search",name:"teamSearch",type:"text",placeholder:"Search team member...",value:b,onChange:t=>Q(t.target.value),className:"w-full !pl-10 pr-4 py-2 bg-card border border-border rounded-xl focus:ring-2 focus:ring-accent focus:border-transparent outline-none transition-all text-sm"})]})]})]})]}),a?.role==="admin"&&e.jsxs("div",{className:`flex items-center gap-3 p-3 rounded-xl border ${j?"flex-col items-stretch bg-red-50/50":"bg-red-50 border-red-200 w-fit"}`,children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(z,{className:"w-4 h-4 text-red-600"}),e.jsx("span",{className:"text-sm font-medium text-red-700 whitespace-nowrap",children:"Tracking Interval (mins):"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("input",{id:"tracking-interval",name:"trackingInterval",type:"number",min:"1",max:"60",value:h,onChange:t=>R(parseInt(t.target.value)||15),className:"w-20 h-9 text-sm border-gray-300 rounded-lg focus:ring-red-500 focus:border-red-500 bg-white !text-gray-900"}),e.jsx(v,{size:"sm",variant:"primary",onClick:ae,disabled:E,className:"h-9 px-4 text-xs bg-red-600 hover:bg-red-700 border-none rounded-lg",children:E?"Saving...":"Set"})]})]}),A.length>0&&e.jsxs("div",{className:"space-y-4",children:[e.jsxs("h2",{className:"text-sm font-bold text-amber-600 flex items-center gap-2",children:[e.jsx(z,{className:"w-4 h-4"}),"Pending Unlock Requests (",A.length,")"]}),e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4",children:A.map(t=>e.jsxs("div",{className:"bg-amber-50 border border-amber-100 rounded-2xl p-4 shadow-sm space-y-3",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsxs("div",{className:"w-10 h-10 rounded-xl bg-amber-100 flex items-center justify-center font-bold text-amber-700 overflow-hidden relative",children:[t.userName.charAt(0),t.userPhoto&&e.jsx("img",{src:t.userPhoto,alt:t.userName,className:"absolute inset-0 w-full h-full object-cover",onError:r=>{r.target.style.display="none"}})]}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("p",{className:"text-sm font-bold text-gray-900 truncate",children:t.userName}),e.jsxs("p",{className:"text-[10px] text-amber-700",children:[U(new Date(t.requestedAt))," ago"]})]})]}),e.jsx("div",{className:"bg-white/50 rounded-xl p-3 border border-amber-100/50",children:e.jsxs("p",{className:"text-xs text-gray-700 italic",children:['"',t.reason,'"']})}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs(v,{size:"sm",className:"flex-1 bg-emerald-600 hover:bg-emerald-700 border-none text-[10px] uppercase font-bold",onClick:()=>D(t.id,"approved"),children:[e.jsx(xe,{className:"w-3 h-3 mr-1"})," Approve"]}),e.jsxs(v,{size:"sm",variant:"outline",className:"flex-1 border-amber-200 text-amber-700 hover:bg-amber-100 text-[10px] uppercase font-bold",onClick:()=>D(t.id,"rejected"),children:[e.jsx(fe,{className:"w-3 h-3 mr-1"})," Reject"]})]})]},t.id))})]})]}),e.jsx("div",{className:`relative rounded-2xl overflow-hidden border border-border shadow-sm bg-card transition-all duration-300 ${j?"h-72":"h-[400px]"}`,children:e.jsx("div",{ref:C,className:"w-full h-full z-0"})}),e.jsx("div",{className:`${u?"mt-4 px-2":"flex items-center justify-between mt-4 px-2"}`,children:e.jsxs("h2",{className:`${u?"text-sm":"text-lg"} font-bold text-primary-text flex items-center gap-2`,children:["Team Members",e.jsx("span",{className:"bg-accent/10 text-accent text-xs px-2 py-0.5 rounded-full",children:g.length})]})}),V?e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4 pb-8",children:[1,2,3,4].map(t=>e.jsx("div",{className:"h-32 bg-card animate-pulse rounded-2xl border border-border"},t))}):g.length===0?e.jsxs("div",{className:"flex flex-col items-center justify-center py-12 text-muted bg-card rounded-2xl border border-dashed border-border",children:[e.jsx(he,{className:"w-12 h-12 mb-3 opacity-20"}),e.jsx("p",{children:"No team members found."})]}):e.jsxs("div",{className:`flex flex-col ${u?"gap-3":"gap-6"} pb-24`,children:[e.jsx("div",{className:"grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4",children:g.slice((S-1)*T,S*T).map(t=>{const r=N[t.id];return e.jsxs(H,{to:`/my-team/${t.id}`,className:"group bg-card border border-border rounded-2xl p-4 hover:border-accent hover:shadow-lg transition-all duration-300 transform hover:-translate-y-1",children:[e.jsxs("div",{className:"flex items-start gap-4",children:[e.jsxs("div",{className:"relative",children:[e.jsxs("div",{className:"w-12 h-12 rounded-xl bg-accent/10 text-accent flex items-center justify-center font-bold text-lg ring-2 ring-background overflow-hidden relative",children:[t.name.charAt(0),t.photoUrl&&e.jsx("img",{src:t.photoUrl,alt:t.name,className:"absolute inset-0 w-full h-full object-cover z-10",onError:s=>{s.target.style.display="none"}})]}),e.jsx("div",{className:`absolute -bottom-1 -right-1 w-4 h-4 rounded-full border-2 border-card z-20 ${r&&O(new Date(r.timestamp))?"bg-green-500 shadow-[0_0_8px_rgba(34,197,94,0.4)]":"bg-red-500 shadow-[0_0_8px_rgba(239,44,44,0.4)]"}`})]}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("h3",{className:"font-bold text-primary-text truncate group-hover:text-accent transition-colors",children:t.name}),e.jsx("p",{className:"text-xs text-muted mb-2 truncate",children:t.role.split("_").map(s=>s.charAt(0).toUpperCase()+s.slice(1)).join(" ")}),e.jsxs("div",{className:"flex items-center gap-1.5 text-xs text-muted",children:[e.jsx(z,{className:"w-3.5 h-3.5"}),e.jsx("span",{children:r?`Active ${U(new Date(r.timestamp))} ago`:"No recent activity"})]})]})]}),e.jsxs("div",{className:"mt-4 pt-3 border-t border-border flex items-center justify-between text-xs font-medium text-accent",children:[e.jsx("span",{children:"View Details"}),e.jsx(be,{className:"w-4 h-4"})]})]},t.id)})}),e.jsx(pe,{currentPage:S,totalItems:g.length,pageSize:T,onPageChange:J,onPageSizeChange:Y})]}),["admin","hr","developer"].includes(a?.role||"")&&e.jsx("button",{className:"fixed bottom-8 right-8 w-14 h-14 bg-emerald-600 text-white rounded-full shadow-lg hover:bg-emerald-700 hover:scale-110 transition-all duration-300 flex items-center justify-center z-50 group",children:e.jsx(ve,{className:"w-6 h-6 group-hover:rotate-12 transition-transform"})})]})};export{$e as default};
