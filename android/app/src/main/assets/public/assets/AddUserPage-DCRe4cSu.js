import{k as W,c as G,o as H,j as e,I as r,T as E,B as C,d as P,m as x,e as n,Q as u,R}from"./index-D5q3SS3D.js";import{u as J,l as K,b as h}from"./react-vendor-BUaIliXj.js";import{S as v}from"./Select-Dz12MdxG.js";import{n as F,f as X}from"./ui-vendor-B8EvWqdc.js";import"./pdf-vendor-CB_F1AVu.js";import"./capacitor-vendor-CqiIOUn1.js";import"./utils-vendor-DmorxLnX.js";import"./supabase-7WG3J4rU.js";const Z=P({id:n().optional(),name:n().required("Name is required"),email:n().email("Invalid email").required("Email is required"),role:n().required("Role is required"),password:n().min(6,"Password must be at least 6 characters").required("Password is required for new users"),phone:n().optional().nullable(),noSiteAssignment:R().optional(),organizationId:n().when(["role","noSiteAssignment"],{is:(s,m)=>s==="site_manager"&&!m,then:s=>s.required("Site manager must be assigned to a site."),otherwise:s=>s.optional()}).nullable(),organizationName:n().optional().nullable(),reportingManagerId:n().optional().nullable(),photoUrl:n().optional().nullable(),biometricId:n().optional().nullable(),earnedLeaveOpeningBalance:u().optional().nullable().transform(s=>isNaN(s)?0:s).default(0),earnedLeaveOpeningDate:n().optional().nullable(),sickLeaveOpeningBalance:u().optional().nullable().transform(s=>isNaN(s)?0:s).default(0),sickLeaveOpeningDate:n().optional().nullable(),compOffOpeningBalance:u().optional().nullable().transform(s=>isNaN(s)?0:s).default(0),compOffOpeningDate:n().optional().nullable(),floatingLeaveOpeningBalance:u().optional().nullable().transform(s=>isNaN(s)?0:s).default(0),floatingLeaveOpeningDate:n().optional().nullable()}).defined(),ee=P({id:n().optional(),name:n().required("Name is required"),email:n().email("Invalid email").required("Email is required"),role:n().required("Role is required"),phone:n().optional().nullable(),noSiteAssignment:R().optional(),organizationId:n().when(["role","noSiteAssignment"],{is:(s,m)=>s==="site_manager"&&!m,then:s=>s.required("Site manager must be assigned to a site."),otherwise:s=>s.optional()}).nullable(),organizationName:n().optional().nullable(),reportingManagerId:n().optional().nullable(),photoUrl:n().optional().nullable(),biometricId:n().optional().nullable(),earnedLeaveOpeningBalance:u().optional().nullable().transform(s=>isNaN(s)?0:s).default(0),earnedLeaveOpeningDate:n().optional().nullable(),sickLeaveOpeningBalance:u().optional().nullable().transform(s=>isNaN(s)?0:s).default(0),sickLeaveOpeningDate:n().optional().nullable(),compOffOpeningBalance:u().optional().nullable().transform(s=>isNaN(s)?0:s).default(0),compOffOpeningDate:n().optional().nullable(),floatingLeaveOpeningBalance:u().optional().nullable().transform(s=>isNaN(s)?0:s).default(0),floatingLeaveOpeningDate:n().optional().nullable()}).defined(),de=()=>{const s=J(),{id:m}=K(),o=!!m,M=W("(max-width: 767px)"),[N,k]=h.useState(!1),[O,T]=h.useState([]),[z,$]=h.useState([]),[f,_]=h.useState([]),[j,y]=h.useState(null),[ae,Q]=h.useState(null),Y=o?ee:Z,{register:i,handleSubmit:D,formState:{errors:t},reset:w,watch:l,setValue:I}=G({resolver:H(Y)});l("role"),h.useEffect(()=>{(async()=>{try{const[p,d,c]=await Promise.all([x.getOrganizations(),x.getRoles(),x.getBiometricDevices?x.getBiometricDevices():Promise.resolve([])]);if(T(p),$(d),_(c),o&&m){const b=(await x.getUsers()).find(U=>U.id===m);b&&(Q(b),w(b))}else w({name:"",email:"",role:"field_staff"})}catch{y({message:"Failed to load form data.",type:"error"})}})()},[m,o,w]);const A=a=>{const p=a.target.value,d=O.find(c=>c.id===p);I("organizationId",p),I("organizationName",d?.shortName||""),p&&I("noSiteAssignment",!1)},S=async a=>{k(!0);const p=d=>{const c={...d};return Object.keys(c).forEach(g=>{(c[g]===""||c[g]===void 0)&&(c[g]=null)}),c};try{if(o&&m){const{password:d,noSiteAssignment:c,...g}=a,b=p(g);await x.updateUser(m,b),y({message:"User updated successfully!",type:"success"})}else{const{name:d,email:c,password:g,role:b,noSiteAssignment:U,...V}=a;if(!g)throw new Error("Password is required when creating a new user");const L=await x.createAuthUser({name:d,email:c,password:g,role:b}),q=p(V);if(Object.keys(q).length>0)try{await x.updateUser(L.id,q)}catch(B){console.warn("Failed to update additional user fields after creation:",B)}try{await x.createNotification({userId:L.id,message:`Welcome ${L.name}! Your account has been created.`,type:"greeting"})}catch(B){console.warn("Failed to create welcome notification (possible RLS violation):",B)}y({message:"User created successfully! They can now sign in with their credentials.",type:"success"})}setTimeout(()=>s("/admin/users"),2e3)}catch(d){console.error("Submit Error:",d),y({message:d.message||"Failed to save user.",type:"error"})}finally{k(!1)}};return M?e.jsxs("div",{className:"h-full flex flex-col",children:[e.jsx("header",{className:"p-4 flex-shrink-0 fo-mobile-header",children:e.jsx("h1",{children:o?"Edit User":"Add User"})}),e.jsx("main",{className:"flex-1 overflow-y-auto p-4",children:e.jsxs("div",{className:"bg-card rounded-2xl p-6 space-y-6",children:[e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"inline-block bg-accent-light p-3 rounded-full mb-2",children:e.jsx(F,{className:"h-8 w-8 text-accent-dark"})}),e.jsx("h2",{className:"text-xl font-bold text-primary-text",children:o?"Edit User":"Add New User"}),e.jsx("p",{className:"text-sm text-gray-400",children:o?"Update user information below.":"Create a new user account with initial credentials."})]}),e.jsxs("form",{onSubmit:D(S),className:"space-y-4",children:[e.jsx(r,{label:"Full Name",id:"name",registration:i("name"),error:t.name?.message}),e.jsx(r,{label:"Email",id:"email",type:"email",registration:i("email"),error:t.email?.message}),e.jsx(v,{label:"Role",id:"role",registration:i("role"),error:t.role?.message,children:z.map(a=>e.jsx("option",{value:a.id,children:a.displayName},a.id))}),l("organizationId")&&f.filter(a=>a.organizationId===l("organizationId")).length>0&&e.jsx(r,{label:"Biometric Device ID (eSSL ID) (Optional)",id:"biometricId",registration:i("biometricId"),error:t.biometricId?.message,placeholder:"e.g. 101"}),!o&&e.jsx(r,{label:"Password",id:"password",type:"password",registration:i("password"),error:t.password?.message}),e.jsxs(v,{label:"Assigned Site",id:"organizationId",registration:i("organizationId"),error:t.organizationId?.message,onChange:A,disabled:l("noSiteAssignment"),children:[e.jsx("option",{value:"",children:"Select a Site"}),O.map(a=>e.jsx("option",{value:a.id,children:a.shortName},a.id))]}),!l("organizationId")&&e.jsxs("div",{className:"flex items-center gap-2 mt-2 px-1",children:[e.jsx("input",{type:"checkbox",id:"noSiteAssignment",...i("noSiteAssignment"),className:"h-4 w-4 rounded border-gray-300 text-accent focus:ring-accent"}),e.jsx("label",{htmlFor:"noSiteAssignment",className:"text-sm text-muted cursor-pointer",children:"This user does not require a site assignment"})]}),l("organizationId")&&e.jsxs("div",{className:"bg-gray-50 p-4 rounded-lg border border-gray-200 mt-2",children:[e.jsxs("h4",{className:"text-sm font-semibold text-primary-text mb-2 flex items-center gap-2",children:[e.jsx("span",{className:"h-2 w-2 rounded-full bg-accent"}),"Devices at Site"]}),e.jsx("div",{className:"space-y-1",children:f.filter(a=>a.organizationId===l("organizationId")).length>0?f.filter(a=>a.organizationId===l("organizationId")).map(a=>e.jsxs("p",{className:"text-xs text-muted flex justify-between",children:[e.jsx("span",{children:a.name}),e.jsx("span",{className:"font-mono",children:a.sn})]},a.id)):e.jsxs("div",{className:"space-y-2",children:[e.jsx("p",{className:"text-xs text-muted italic",children:"No biometric devices found."}),e.jsx("p",{className:"text-[10px] text-accent-dark bg-accent/5 p-2 rounded border border-accent/10",children:"Mobile app check-in/out will be used for this site. Biometric ID is not mandatory."})]})})]}),e.jsxs("div",{className:"pt-4 border-t border-gray-100 space-y-6",children:[e.jsxs("div",{children:[e.jsx("h3",{className:"text-sm font-semibold text-primary-text mb-4",children:"Earned Leave Initial Balance"}),e.jsxs("div",{className:"space-y-4",children:[e.jsx(r,{label:"Opening Balance (Days)",type:"number",step:"0.5",registration:i("earnedLeaveOpeningBalance"),error:t.earnedLeaveOpeningBalance?.message}),e.jsx(r,{label:"Opening Date",type:"date",registration:i("earnedLeaveOpeningDate"),error:t.earnedLeaveOpeningDate?.message})]})]}),e.jsxs("div",{children:[e.jsx("h3",{className:"text-sm font-semibold text-primary-text mb-4",children:"Sick Leave Initial Balance"}),e.jsxs("div",{className:"space-y-4",children:[e.jsx(r,{label:"Opening Balance (Days)",type:"number",step:"0.5",registration:i("sickLeaveOpeningBalance"),error:t.sickLeaveOpeningBalance?.message}),e.jsx(r,{label:"Opening Date",type:"date",registration:i("sickLeaveOpeningDate"),error:t.sickLeaveOpeningDate?.message})]})]}),e.jsxs("div",{children:[e.jsx("h3",{className:"text-sm font-semibold text-primary-text mb-4",children:"Comp Off Initial Balance"}),e.jsxs("div",{className:"space-y-4",children:[e.jsx(r,{label:"Opening Balance (Days)",type:"number",step:"0.5",registration:i("compOffOpeningBalance"),error:t.compOffOpeningBalance?.message}),e.jsx(r,{label:"Opening Date",type:"date",registration:i("compOffOpeningDate"),error:t.compOffOpeningDate?.message})]})]}),e.jsxs("div",{children:[e.jsx("h3",{className:"text-sm font-semibold text-primary-text mb-4",children:"Floating Leave Initial Balance"}),e.jsxs("div",{className:"space-y-4",children:[e.jsx(r,{label:"Opening Balance (Days)",type:"number",step:"0.5",registration:i("floatingLeaveOpeningBalance"),error:t.floatingLeaveOpeningBalance?.message}),e.jsx(r,{label:"Opening Date",type:"date",registration:i("floatingLeaveOpeningDate"),error:t.floatingLeaveOpeningDate?.message})]})]})]})]})]})}),e.jsxs("footer",{className:"p-4 flex-shrink-0 flex items-center gap-4",children:[e.jsx("button",{type:"button",onClick:()=>s("/admin/users"),disabled:N,className:"fo-btn-secondary px-6",children:"Cancel"}),e.jsx("button",{type:"submit",onClick:D(S),disabled:N,className:"fo-btn-primary flex-1",children:N?"Saving...":o?"Save Changes":"Create User"})]}),j&&e.jsx(E,{message:j.message,type:j.type,onDismiss:()=>y(null)})]}):e.jsxs("div",{className:"p-4 md:p-6",children:[e.jsxs("div",{className:"bg-card p-8 rounded-xl shadow-card w-full",children:[e.jsxs("div",{className:"flex items-center mb-6",children:[e.jsx("div",{className:"bg-accent-light p-3 rounded-full mr-4",children:e.jsx(F,{className:"h-8 w-8 text-accent-dark"})}),e.jsxs("div",{children:[e.jsx("h2",{className:"text-2xl font-bold text-primary-text",children:o?"Edit User":"Add New User"}),e.jsx("p",{className:"text-muted",children:o?"Update user information below.":"Create a new user account with initial credentials."})]})]}),e.jsxs("form",{onSubmit:D(S),className:"space-y-6",children:[e.jsx(r,{label:"Full Name",id:"name",registration:i("name"),error:t.name?.message}),e.jsx(r,{label:"Email",id:"email",type:"email",registration:i("email"),error:t.email?.message}),e.jsx(v,{label:"Role",id:"role",registration:i("role"),error:t.role?.message,children:z.map(a=>e.jsx("option",{value:a.id,children:a.displayName},a.id))}),l("organizationId")&&f.filter(a=>a.organizationId===l("organizationId")).length>0&&e.jsx(r,{label:"Biometric Device ID (eSSL ID) (Optional)",id:"biometricId",registration:i("biometricId"),error:t.biometricId?.message,placeholder:"e.g. 101"}),!o&&e.jsx(r,{label:"Password",id:"password",type:"password",registration:i("password"),error:t.password?.message}),e.jsxs(v,{label:"Assigned Site",id:"organizationId",registration:i("organizationId"),error:t.organizationId?.message,onChange:A,disabled:l("noSiteAssignment"),children:[e.jsx("option",{value:"",children:"Select a Site (Location)"}),O.map(a=>e.jsx("option",{value:a.id,children:a.shortName},a.id))]}),!l("organizationId")&&e.jsxs("div",{className:"flex items-center gap-2 mt-2 px-1 bg-amber-50/50 p-2 rounded-lg border border-amber-100/50",children:[e.jsx("input",{type:"checkbox",id:"noSiteAssignmentDesktop",...i("noSiteAssignment"),className:"h-4 w-4 rounded border-gray-300 text-accent focus:ring-accent"}),e.jsx("label",{htmlFor:"noSiteAssignmentDesktop",className:"text-sm text-amber-800 cursor-pointer font-medium",children:"I confirm this user does not require a site assignment (Declaration)"})]}),l("organizationId")&&e.jsxs("div",{className:"bg-gray-50 p-4 rounded-lg border border-gray-200",children:[e.jsxs("h4",{className:"text-sm font-semibold text-primary-text mb-2 flex items-center gap-2",children:[e.jsx("span",{className:"h-2 w-2 rounded-full bg-accent"}),"Biometric Devices at this Site"]}),e.jsx("div",{className:"space-y-2",children:f.filter(a=>a.organizationId===l("organizationId")).length>0?f.filter(a=>a.organizationId===l("organizationId")).map(a=>e.jsxs("div",{className:"text-xs flex justify-between items-center bg-white p-2 rounded border border-gray-100",children:[e.jsx("span",{className:"font-medium",children:a.name}),e.jsx("span",{className:"text-muted font-mono",children:a.sn})]},a.id)):e.jsxs("div",{className:"space-y-2",children:[e.jsx("p",{className:"text-xs text-muted italic",children:"No biometric devices found at this site."}),e.jsxs("p",{className:"text-xs text-accent-dark bg-accent/5 p-3 rounded-lg border border-accent/20",children:[e.jsx("strong",{children:"Note:"})," Mobile app check-in/out will be used for this site as no biometric devices are available. You can leave the Biometric Device ID empty."]})]})})]}),e.jsxs("div",{className:"pt-6 border-t border-gray-100 space-y-8",children:[e.jsxs("h3",{className:"text-xl font-bold text-primary-text flex items-center gap-2 mb-2",children:[e.jsx(X,{className:"h-6 w-6 text-accent"}),"Leave Balance Initialization"]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-x-12 gap-y-10",children:[e.jsxs("div",{className:"space-y-4",children:[e.jsx("h4",{className:"font-semibold text-emerald-700 bg-emerald-50 px-3 py-1.5 rounded-lg inline-block text-sm",children:"Earned Leave"}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsx(r,{label:"Opening Balance (Days)",type:"number",step:"0.5",registration:i("earnedLeaveOpeningBalance"),error:t.earnedLeaveOpeningBalance?.message,description:"Initial balance."}),e.jsx(r,{label:"Opening Date",type:"date",registration:i("earnedLeaveOpeningDate"),error:t.earnedLeaveOpeningDate?.message,description:"Start date."})]})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsx("h4",{className:"font-semibold text-blue-700 bg-blue-50 px-3 py-1.5 rounded-lg inline-block text-sm",children:"Sick Leave"}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsx(r,{label:"Opening Balance (Days)",type:"number",step:"0.5",registration:i("sickLeaveOpeningBalance"),error:t.sickLeaveOpeningBalance?.message,description:"Initial balance."}),e.jsx(r,{label:"Opening Date",type:"date",registration:i("sickLeaveOpeningDate"),error:t.sickLeaveOpeningDate?.message,description:"Start date."})]})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsx("h4",{className:"font-semibold text-amber-700 bg-amber-50 px-3 py-1.5 rounded-lg inline-block text-sm",children:"Comp Off"}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsx(r,{label:"Opening Balance (Days)",type:"number",step:"0.5",registration:i("compOffOpeningBalance"),error:t.compOffOpeningBalance?.message,description:"Initial balance."}),e.jsx(r,{label:"Opening Date",type:"date",registration:i("compOffOpeningDate"),error:t.compOffOpeningDate?.message,description:"Start date."})]})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsx("h4",{className:"font-semibold text-purple-700 bg-purple-50 px-3 py-1.5 rounded-lg inline-block text-sm",children:"Floating Leave"}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsx(r,{label:"Opening Balance (Days)",type:"number",step:"0.5",registration:i("floatingLeaveOpeningBalance"),error:t.floatingLeaveOpeningBalance?.message,description:"Initial balance."}),e.jsx(r,{label:"Opening Date",type:"date",registration:i("floatingLeaveOpeningDate"),error:t.floatingLeaveOpeningDate?.message,description:"Start date."})]})]})]})]}),e.jsxs("div",{className:"mt-8 pt-6 border-t flex justify-end gap-3",children:[e.jsx(C,{type:"button",onClick:()=>s("/admin/users"),variant:"secondary",disabled:N,children:"Cancel"}),e.jsx(C,{type:"submit",isLoading:N,children:o?"Save Changes":"Create User"})]})]})]}),j&&e.jsx(E,{message:j.message,type:j.type,onDismiss:()=>y(null)})]})};export{de as default};
