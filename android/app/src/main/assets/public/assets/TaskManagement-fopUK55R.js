import{c as de,o as ce,d as me,j as e,C as xe,B as f,S as ue,e as pe,u as ge,U as he,k as be,m as $,T as fe,I as ye}from"./index-D5q3SS3D.js";import{R as je,u as Ne,b as l}from"./react-vendor-BUaIliXj.js";import{u as T}from"./taskStore-CL2IH4rv.js";import{M as ve}from"./Modal-CR2aBU6L.js";import{U as we}from"./UploadDocument-BAL6UInC.js";import{P as De}from"./Pagination-DXf7cs0z.js";import{L as Te}from"./LoadingScreen-_hPz2y_i.js";import{X as Ce,ao as Se,aj as Pe,as as K,at as W,d as Y}from"./ui-vendor-B8EvWqdc.js";import{f as Z,F as b}from"./utils-vendor-DmorxLnX.js";import"./pdf-vendor-CB_F1AVu.js";import"./capacitor-vendor-CqiIOUn1.js";import"./supabase-7WG3J4rU.js";import"./CameraCaptureModal-DQDGRnEP.js";const Fe=me({completionNotes:pe().required("Completion notes are required").min(10,"Please provide more detail."),completionPhoto:ue().required("A photo proof of completion is required.").nullable()}).defined(),Le=({isOpen:s,onClose:r,task:x,setToast:n})=>{const{updateTask:m}=T(),[C,c]=je.useState(!1),{handleSubmit:g,formState:{errors:p},reset:a,control:y}=de({resolver:ce(Fe),defaultValues:{completionNotes:"",completionPhoto:null}}),S=async u=>{c(!0);try{await m(x.id,{...u,status:"Done"}),n({message:"Task completed successfully!",type:"success"}),r()}catch{n({message:"Failed to complete task.",type:"error"})}finally{c(!1)}};return s?e.jsx("div",{className:"fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50",onClick:r,children:e.jsx("div",{className:"bg-card rounded-xl shadow-card p-6 w-full max-w-lg m-4 animate-fade-in-scale",onClick:u=>u.stopPropagation(),children:e.jsxs("form",{onSubmit:g(S),children:[e.jsxs("h3",{className:"text-lg font-bold text-primary-text",children:["Complete Task: ",x.name]}),e.jsx("p",{className:"text-sm text-muted mb-4",children:"Provide a summary and photo proof of your work."}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{htmlFor:"completionNotes",className:"block text-sm font-medium text-muted",children:"Completion Notes"}),e.jsx("textarea",{id:"completionNotes",rows:4,...y.register("completionNotes"),className:`mt-1 bg-card border ${p.completionNotes?"border-red-500":"border-border"} rounded-lg px-3 py-2.5 w-full sm:text-sm focus:ring-1 focus:ring-accent`}),p.completionNotes&&e.jsx("p",{className:"mt-1 text-xs text-red-600",children:p.completionNotes.message})]}),e.jsx(xe,{name:"completionPhoto",control:y,render:({field:u})=>e.jsx(we,{label:"Upload Photo Proof",file:u.value,onFileChange:u.onChange,allowedTypes:["image/jpeg","image/png"]})}),p.completionPhoto&&e.jsx("p",{className:"mt-1 text-xs text-red-600",children:p.completionPhoto.message})]}),e.jsxs("div",{className:"mt-6 flex justify-end space-x-3",children:[e.jsx(f,{type:"button",onClick:r,variant:"secondary",children:"Cancel"}),e.jsx(f,{type:"submit",isLoading:C,children:"Mark as Done"})]})]})})}):null},Ie=s=>{const r=new Date;r.setHours(0,0,0,0);const x=c=>c?new Date(c):null;if(s.status==="Done"||!s.dueDate)return{date:s.dueDate?Z(x(s.dueDate),"dd MMM, yyyy"):"-",isOverdue:!1};let n=null;const m=x(s.dueDate);switch(s.escalationStatus){case"None":n=s.escalationLevel1DurationDays?b(m,s.escalationLevel1DurationDays):m;break;case"Level 1":if(s.escalationLevel1DurationDays&&s.escalationLevel2DurationDays){const c=b(m,s.escalationLevel1DurationDays);n=b(c,s.escalationLevel2DurationDays)}break;case"Level 2":if(s.escalationLevel1DurationDays&&s.escalationLevel2DurationDays&&s.escalationEmailDurationDays){const c=b(m,s.escalationLevel1DurationDays),g=b(c,s.escalationLevel2DurationDays);n=b(g,s.escalationEmailDurationDays)}break}n||(n=m);const C=n?n<r:!1;return{date:Z(n,"dd MMM, yyyy"),isOverdue:C}},Ve=()=>{const s=Ne(),{user:r}=ge(),{tasks:x,isLoading:n,error:m,fetchTasks:C,deleteTask:c,runAutomaticEscalations:g}=T(),{theme:p}=he(),a=p==="dark",[y,S]=l.useState(!1),[u,P]=l.useState(!1),[j,A]=l.useState(null),[L,N]=l.useState(null),[_,ee]=l.useState(0),[I,k]=l.useState(1),[F,te]=l.useState(20),[v,E]=l.useState(""),[M,O]=l.useState([]),[w,U]=l.useState("all"),[D,z]=l.useState("all"),[h,q]=l.useState("all"),d=be("(max-width: 767px)"),H=l.useCallback(async()=>{T.setState({isLoading:!0});try{const t=await $.getTasks({page:I,pageSize:F});await new Promise(o=>setTimeout(o,1e4)),T.setState({tasks:t.data,isLoading:!1}),ee(t.total)}catch{await new Promise(o=>setTimeout(o,1e4)),T.setState({isLoading:!1}),N({message:"Failed to fetch tasks.",type:"error"})}},[I,F]);l.useEffect(()=>{(async()=>{if(r)if(["admin","hr","developer"].includes(r.role))$.getUsers().then(i=>O(i));else{const i=await $.getTeamMembers(r.id);O([r,...i])}await H(),await g()})()},[r,H,g]);const B=l.useId(),R=l.useId(),Q=l.useId();l.useEffect(()=>{k(1)},[F]);const se=()=>{s("/tasks/add")},V=t=>{s(`/tasks/edit/${t.id}`)},X=t=>{A(t),S(!0)},G=t=>{A(t),P(!0)},ae=async()=>{if(j)try{await c(j.id),N({message:"Task deleted.",type:"success"}),P(!1)}catch{N({message:"Failed to delete task.",type:"error"})}},le=l.useMemo(()=>{const t=r&&["admin","hr","developer"].includes(r.role),o=M.map(i=>i.id);return x.filter(i=>{if(!t&&i.assignedToId&&!o.includes(i.assignedToId)||w!=="all"&&i.status!==w||D!=="all"&&i.priority!==D)return!1;if(h==="unassigned"){if(i.assignedToId)return!1}else if(h!=="all"&&i.assignedToId!==h)return!1;return!(v&&!i.name.toLowerCase().includes(v.toLowerCase()))})},[x,w,D,h,r,M,v]),re=()=>{U("all"),z("all"),q("all")},ie=w!=="all"||D!=="all"||h!=="all",J=t=>{const o={High:a?"bg-red-500/20 text-red-400":"bg-red-100 text-red-800",Medium:a?"bg-yellow-500/20 text-yellow-400":"bg-yellow-100 text-yellow-800",Low:a?"bg-blue-500/20 text-blue-400":"bg-blue-100 text-blue-800"};return e.jsx("span",{className:`px-2.5 py-0.5 inline-flex text-xs leading-5 font-semibold rounded-full ${o[t]}`,children:t})},oe=t=>{const o={"To Do":a?"bg-gray-500/20 text-gray-300":"bg-gray-100 text-gray-800","In Progress":a?"bg-indigo-500/20 text-indigo-300":"bg-indigo-100 text-indigo-800",Done:a?"bg-green-500/20 text-green-300":"bg-green-100 text-green-800"};return e.jsx("span",{className:`px-2.5 py-0.5 inline-flex text-xs leading-5 font-semibold rounded-full ${o[t]}`,children:t})},ne=t=>{if(t==="None")return null;const o={None:"","Level 1":a?"bg-orange-500/20 text-orange-400":"bg-orange-100 text-orange-800","Level 2":a?"bg-amber-500/20 text-amber-400":"bg-amber-100 text-amber-800","Email Sent":a?"bg-purple-500/20 text-purple-400":"bg-purple-100 text-purple-800"};return e.jsx("span",{className:`px-2 py-0.5 text-xs font-medium rounded-full ${o[t]}`,children:t})};return n?e.jsx(Te,{message:"Fetching tasks..."}):e.jsxs("div",{className:`min-h-screen ${d?"bg-[#041b0f] text-white p-4 pb-24":`p-4 ${a?"bg-[#041b0f] border border-white/10":"md:bg-card"} md:p-6 md:rounded-xl md:shadow-card`}`,children:[L&&e.jsx(fe,{message:L.message,type:L.type,onDismiss:()=>N(null)}),y&&j&&e.jsx(Le,{isOpen:y,onClose:()=>S(!1),task:j,setToast:N}),e.jsxs(ve,{isOpen:u,onClose:()=>P(!1),onConfirm:ae,title:"Confirm Deletion",children:['Are you sure you want to delete the task "',j?.name,'"?']}),e.jsx("div",{className:"mb-6",children:e.jsx("h1",{className:`text-2xl font-bold ${d||a?"text-white":"text-gray-900"}`,children:"Task Management"})}),e.jsxs("div",{className:"flex flex-col md:flex-row gap-4 mb-6 md:items-end justify-between",children:[e.jsxs("div",{className:"flex-1 grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{htmlFor:B,className:`text-sm font-medium ${d||a?"text-gray-300":"text-gray-700"}`,children:"Filter by Status"}),e.jsxs("select",{id:B,name:"statusFilter",className:`w-full rounded-lg border px-3 py-2 outline-none focus:ring-2 focus:ring-emerald-500 ${d||a?"bg-[#152b1b] border-white/10 text-white":"bg-white border-gray-300 text-gray-900"}`,value:w,onChange:t=>U(t.target.value),children:[e.jsx("option",{value:"all",children:"All Statuses"}),e.jsx("option",{value:"To Do",children:"To Do"}),e.jsx("option",{value:"In Progress",children:"In Progress"}),e.jsx("option",{value:"Done",children:"Done"})]})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{htmlFor:R,className:`text-sm font-medium ${d||a?"text-gray-300":"text-gray-700"}`,children:"Filter by Priority"}),e.jsxs("select",{id:R,name:"priorityFilter",className:`w-full rounded-lg border px-3 py-2 outline-none focus:ring-2 focus:ring-emerald-500 ${d||a?"bg-[#152b1b] border-white/10 text-white":"bg-white border-gray-300 text-gray-900"}`,value:D,onChange:t=>z(t.target.value),children:[e.jsx("option",{value:"all",children:"All Priorities"}),e.jsx("option",{value:"Low",children:"Low"}),e.jsx("option",{value:"Medium",children:"Medium"}),e.jsx("option",{value:"High",children:"High"})]})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{htmlFor:Q,className:`text-sm font-medium ${d||a?"text-gray-300":"text-gray-700"}`,children:"Filter by Assignee"}),e.jsxs("select",{id:Q,name:"assignedToFilter",className:`w-full rounded-lg border px-3 py-2 outline-none focus:ring-2 focus:ring-emerald-500 ${d||a?"bg-[#152b1b] border-white/10 text-white":"bg-white border-gray-300 text-gray-900"}`,value:h,onChange:t=>q(t.target.value),children:[e.jsx("option",{value:"all",children:"All Users"}),e.jsx("option",{value:"unassigned",children:"Unassigned"}),M.map(t=>e.jsx("option",{value:t.id,children:t.name},t.id))]})]})]}),e.jsxs("div",{className:"flex items-center gap-2 flex-shrink-0 mt-4 md:mt-0",children:[(ie||v)&&e.jsxs(f,{variant:"secondary",onClick:()=>{re(),E("")},children:[e.jsx(Ce,{className:"mr-2 h-4 w-4"})," Clear All"]}),e.jsxs("button",{onClick:se,className:`flex items-center justify-center transition-colors ${d?"bg-[#32CD32] hover:bg-[#28a428] text-[#0D1A0D] font-bold border-none shadow-none text-sm py-3 px-6 rounded-xl":"bg-emerald-600 text-white hover:bg-emerald-700 rounded-lg px-6 py-2.5 font-medium"}`,children:[e.jsx(Se,{className:"mr-2 h-5 w-5"})," Add Task"]})]})]}),e.jsx("div",{className:"mb-6",children:e.jsx(ye,{placeholder:"Search tasks by name...",value:v,onChange:t=>E(t.target.value),icon:e.jsx(Pe,{className:"h-4 w-4"})})}),m&&e.jsx("p",{className:"text-red-500 mb-4",children:m}),e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"min-w-full responsive-table",children:[e.jsx("thead",{className:d?"hidden":a?"bg-white/5 text-white":"bg-page",children:e.jsxs("tr",{children:[e.jsx("th",{scope:"col",className:"px-6 py-3 text-left text-xs font-medium text-muted uppercase",children:"Task Name"}),e.jsx("th",{scope:"col",className:"px-6 py-3 text-left text-xs font-medium text-muted uppercase",children:"Priority"}),e.jsx("th",{scope:"col",className:"px-6 py-3 text-left text-xs font-medium text-muted uppercase",children:"Next Due Date"}),e.jsx("th",{scope:"col",className:"px-6 py-3 text-left text-xs font-medium text-muted uppercase",children:"Assigned To"}),e.jsx("th",{scope:"col",className:"px-6 py-3 text-left text-xs font-medium text-muted uppercase",children:"Status"}),e.jsx("th",{scope:"col",className:"px-6 py-3 text-left text-xs font-medium text-muted uppercase",children:"Escalation"}),e.jsx("th",{scope:"col",className:"px-6 py-3 text-left text-xs font-medium text-muted uppercase",children:"Actions"})]})}),e.jsx("tbody",{className:`divide-y md:divide-y-0 ${d?"divide-white/10 space-y-4 block":a?"divide-white/10 bg-[#041b0f]":"divide-border md:bg-card"}`,children:le.map(t=>{const{date:o,isOverdue:i}=Ie(t);return d?e.jsxs("div",{className:"bg-[#152b1b] p-4 rounded-xl border border-white/5 mb-4",children:[e.jsxs("div",{className:"flex justify-between items-start mb-3",children:[e.jsxs("div",{children:[e.jsx("h3",{className:"font-semibold text-white text-lg",children:t.name}),e.jsxs("p",{className:"text-sm text-gray-400 mt-1",children:["Due: ",e.jsx("span",{className:i?"text-red-400 font-bold":"",children:o||"-"})]})]}),J(t.priority)]}),e.jsxs("div",{className:"grid grid-cols-2 gap-2 text-sm mb-4",children:[e.jsxs("div",{children:[e.jsx("span",{className:"text-gray-500 block text-xs",children:"Assigned To"}),e.jsx("span",{className:"text-gray-300",children:t.assignedToName||"-"})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-gray-500 block text-xs",children:"Status"}),e.jsx("span",{className:"text-gray-300",children:t.status})]})]}),e.jsxs("div",{className:"flex justify-end gap-2 border-t border-white/10 pt-3",children:[e.jsx("button",{onClick:()=>V(t),className:"p-2 text-gray-400 hover:text-white bg-white/5 rounded-lg",children:e.jsx(K,{className:"h-4 w-4"})}),e.jsx("button",{onClick:()=>G(t),className:"p-2 text-red-400 hover:text-red-300 bg-red-500/10 rounded-lg",children:e.jsx(W,{className:"h-4 w-4"})}),t.assignedToId===r?.id&&t.status!=="Done"&&e.jsxs("button",{onClick:()=>X(t),className:"flex items-center px-3 py-2 bg-emerald-500/10 text-emerald-400 rounded-lg text-sm font-medium",children:[e.jsx(Y,{className:"h-4 w-4 mr-1.5"})," Complete"]})]})]},t.id):e.jsxs("tr",{className:i?"bg-red-50":a?"text-gray-300 hover:bg-white/5":"",children:[e.jsx("td",{"data-label":"Task Name",className:"px-6 py-4 font-medium",children:t.name}),e.jsx("td",{"data-label":"Priority",className:"px-6 py-4",children:J(t.priority)}),e.jsx("td",{"data-label":"Next Due Date",className:`px-6 py-4 text-sm ${i?"font-bold text-red-600":"text-muted"}`,children:o||"-"}),e.jsx("td",{"data-label":"Assigned To",className:"px-6 py-4 text-sm text-muted",children:t.assignedToName||"-"}),e.jsx("td",{"data-label":"Status",className:"px-6 py-4 text-sm text-muted",children:oe(t.status)}),e.jsx("td",{"data-label":"Escalation",className:"px-6 py-4 text-sm text-muted",children:ne(t.escalationStatus)}),e.jsx("td",{"data-label":"Actions",className:"px-6 py-4",children:e.jsxs("div",{className:"flex items-center gap-2 justify-end md:justify-start",children:[e.jsx(f,{variant:"icon",size:"sm",onClick:()=>V(t),title:"Edit Task",children:e.jsx(K,{className:"h-4 w-4"})}),e.jsx(f,{variant:"icon",size:"sm",onClick:()=>G(t),title:"Delete Task",children:e.jsx(W,{className:"h-4 w-4 text-red-600"})}),t.assignedToId===r?.id&&t.status!=="Done"&&e.jsxs(f,{variant:"outline",size:"sm",onClick:()=>X(t),children:[e.jsx(Y,{className:"h-4 w-4 mr-2"})," Complete"]})]})})]},t.id)})})]})}),e.jsx(De,{currentPage:I,totalItems:_,pageSize:F,onPageChange:k,onPageSizeChange:te,className:"mt-6"})]})};export{Ve as default};
