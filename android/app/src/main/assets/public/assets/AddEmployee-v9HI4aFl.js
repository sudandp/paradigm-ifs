import{j as e,h as Z,u as ee,l as te,k as se,m as R,T as K,B as P}from"./index-D5q3SS3D.js";import{b as o,R as W,u as ae,e as ne,j as re,O as X}from"./react-vendor-BUaIliXj.js";import{g as q,i as ie,j as oe,U as le,M as ce,D as de,z as ue,ac as me,I as fe,ad as ge,ae as be,af as pe,J as he,ag as xe,ah as ye,ai as ve,a2 as J,H as je,d as we}from"./ui-vendor-B8EvWqdc.js";import{M as Ne}from"./Modal-CR2aBU6L.js";import"./pdf-vendor-CB_F1AVu.js";import"./capacitor-vendor-CqiIOUn1.js";import"./utils-vendor-DmorxLnX.js";import"./supabase-7WG3J4rU.js";const Q=({steps:n,currentStepIndex:f,onStepClick:a,highestStepReached:y,isMobileOptimized:g=!1})=>{const[N,k]=o.useState(0),b=4,C=Math.ceil(n.length/b);o.useEffect(()=>{if(g){const s=Math.floor(f/b);k(s)}},[f,g,b]);const A=()=>{k(s=>Math.min(s+1,C-1))},D=()=>{k(s=>Math.max(s-1,0))},v=o.useMemo(()=>{if(!g)return[];const s=N*b,p=s+b;return Array.from({length:n.length},(h,c)=>c).slice(s,p)},[N,b,n.length,g]);if(!g){const s=f>0?f/(n.length-1)*100:0,h=100/n.length/2;return e.jsx("nav",{"aria-label":"Onboarding Progress",className:"py-4",children:e.jsxs("div",{className:"relative",children:[e.jsxs("div",{className:"absolute top-4 h-1",style:{left:`${h}%`,right:`${h}%`},children:[e.jsx("div",{className:"w-full h-full bg-border rounded-full"}),e.jsx("div",{className:"absolute top-0 left-0 h-full bg-accent rounded-full transition-all duration-500 ease-in-out",style:{width:`${s}%`}})]}),e.jsx("ol",{role:"list",className:"relative flex items-center",children:n.map((c,l)=>{const x=l<f,d=l===f,j=l<=y;return e.jsx("li",{className:"flex-1",children:e.jsxs("div",{className:"relative flex flex-col items-center group",children:[e.jsx("button",{type:"button",onClick:()=>j&&a(l),disabled:!j,className:"flex flex-col items-center focus:outline-none focus-visible:ring-2 focus-visible:ring-offset-2 focus-visible:ring-accent-dark rounded-full disabled:cursor-not-allowed","aria-current":d?"step":void 0,title:c.label,children:e.jsx("div",{className:`relative flex items-center justify-center w-9 h-9 rounded-full transition-all duration-300 border-2 z-10 ${x?"bg-accent border-accent text-white":""} ${d?"bg-card border-accent text-accent scale-110":""} ${!x&&!d?"bg-card border-border text-muted":""} ${j?"group-hover:border-accent-dark":""}`,children:x?e.jsx(q,{className:"w-5 h-5"}):W.createElement(c.icon,{className:"w-5 h-5"})})}),e.jsx("span",{className:`hidden sm:block absolute top-12 w-24 text-center text-xs transition-colors duration-300 ${d?"text-accent font-bold":"text-muted"} ${j?"group-hover:text-primary-text":""}`,children:c.label})]})},c.key)})})]})})}return e.jsxs("nav",{"aria-label":"Onboarding Progress",className:"bg-card rounded-2xl mx-4 my-2 p-2 flex items-center gap-1",children:[e.jsx("button",{type:"button",onClick:D,disabled:N===0,className:"p-2 rounded-full disabled:opacity-30 disabled:cursor-not-allowed text-white hover:bg-white/10","aria-label":"Previous steps",children:e.jsx(ie,{className:"h-6 w-6"})}),e.jsx("div",{className:"flex-1 overflow-hidden",children:e.jsx("ol",{role:"list",className:"flex items-center justify-around",children:v.map(s=>{const p=n[s],h=s<f,c=s===f,l=s<=y;return e.jsx("li",{className:"flex-shrink-0",children:e.jsx("div",{className:"relative flex flex-col items-center group",children:e.jsx("button",{type:"button",onClick:()=>l&&a(s),disabled:!l,className:"flex flex-col items-center focus:outline-none focus-visible:ring-2 focus-visible:ring-offset-2 focus-visible:ring-offset-[#041b0f] focus-visible:ring-emerald-400 rounded-full disabled:cursor-not-allowed","aria-current":c?"step":void 0,title:p.label,children:e.jsx("div",{className:`relative flex items-center justify-center w-10 h-10 rounded-full transition-all duration-300 border-2 z-10
                      ${h?"bg-green-600 border-green-600 text-white":""}
                      ${c?"bg-transparent border-green-500 text-white scale-110":""}
                      ${!h&&!c?`bg-transparent ${l?"border-gray-500 text-gray-400 group-hover:border-emerald-400":"border-gray-700 text-gray-600 opacity-50"}`:""}`,children:h?e.jsx(q,{className:"w-6 h-6 text-white"}):W.createElement(p.icon,{className:"w-6 h-6"})})})})},p.key)})})}),e.jsx("button",{type:"button",onClick:A,disabled:N>=C-1,className:"p-2 rounded-full disabled:opacity-30 disabled:cursor-not-allowed text-white hover:bg-white/10","aria-label":"Next steps",children:e.jsx(oe,{className:"h-6 w-6"})})]})},V=[{key:"personal",label:"Personal",icon:le},{key:"address",label:"Address",icon:ce},{key:"organization",label:"Organization",icon:de},{key:"family",label:"Family",icon:ue},{key:"education",label:"Education",icon:me},{key:"bank",label:"Bank",icon:fe},{key:"uan",label:"UAN/PF",icon:ge},{key:"esi",label:"ESI",icon:be},{key:"gmc",label:"GMC",icon:pe},{key:"uniform",label:"Uniform",icon:he},{key:"documents",label:"Documents",icon:xe},{key:"biometrics",label:"Biometrics",icon:ye},{key:"review",label:"Review",icon:ve}],u=V.map(n=>n.key),Te=()=>{const n=ae(),f=ne(),{data:a,reset:y,setData:g}=Z(),{user:N}=ee(),{salaryThreshold:k}=te(),[b,C]=o.useState(!1),[A,D]=o.useState(!0),[v,s]=o.useState(null),[p]=re(),[h,c]=o.useState(!1),[l,x]=o.useState("idle"),d=o.useRef(null),j=se("(max-width: 767px)"),O=o.useRef(null),$=f.pathname.split("/").pop(),i=o.useMemo(()=>u.indexOf($),[$]),[B,F]=o.useState(0);o.useEffect(()=>{const t=a.personal.firstName==="Ravi"&&a.status==="draft";if(a.status!=="draft"||t){F(u.length-1);return}const r=sessionStorage.getItem(`onboarding_progress_${a.id}`),w=r?parseInt(r,10):0,m=Math.max(w,i);F(m),i>w&&sessionStorage.setItem(`onboarding_progress_${a.id}`,String(i))},[a,i]);const U=o.useMemo(()=>V.map((t,r)=>({...t,status:r<i?"complete":r===i?"current":"upcoming"})),[i]);o.useEffect(()=>{const t=p.get("id");t?(async w=>{D(!0);try{const m=await R.getOnboardingDataById(w);m?(g(m),x("saved")):(s({message:"Could not find submission data.",type:"error"}),y())}catch(m){console.error("Failed to fetch submission data",m),s({message:"Failed to load submission data.",type:"error"}),y()}finally{D(!1)}})(t):D(!1)},[p,g,y]);const M=o.useCallback(async()=>{x("saving");try{const{draftId:t}=await R.saveDraft(a);t!==a.id&&g({...a,id:t}),x("saved")}catch{s({message:"Auto-save failed. Check your connection.",type:"error"}),x("dirty")}},[a,g]);o.useEffect(()=>((!a.id||a.id.startsWith("draft_")||a.status==="draft")&&!A&&(l!=="saving"&&x("dirty"),d.current&&clearTimeout(d.current),d.current=window.setTimeout(()=>{M()},2e3)),()=>{d.current&&clearTimeout(d.current)}),[a,A,M,l]);const I=async()=>{d.current&&clearTimeout(d.current),await M();const t=O.current;if(O.current=null,t)n(`/onboarding/add/${t}`);else if(i<u.length-1){let r=i+1;$==="esi"&&u[r]==="gmc"&&(a.personal.salary!=null&&a.personal.salary>k||r++),r<u.length&&n(`/onboarding/add/${u[r]}`)}},_=t=>{t<=B&&n(`/onboarding/add/${u[t]}`)},G=()=>{if(i>0){let t=i-1;$==="uniform"&&u[t]==="gmc"&&(a.personal.salary!=null&&a.personal.salary>k||t--),t>=0?n(`/onboarding/add/${u[t]}`):n("/onboarding/select-organization")}else n("/onboarding/select-organization")},z=async()=>{C(!0);const t={...a,status:"pending"};try{!!a.id&&!a.id.startsWith("draft_")?(await R.updateOnboarding(t),s({message:"Application updated successfully!",type:"success"})):(await R.submitOnboarding(t),s({message:"Application submitted successfully!",type:"success"})),setTimeout(()=>{y(),N?.role==="site_manager"?n("/site/dashboard"):n("/onboarding")},2e3)}catch{s({message:"Failed to submit application.",type:"error"}),C(!1)}},Y=()=>{sessionStorage.removeItem(`onboarding_progress_${a.id}`),y(),c(!1),n("/onboarding/add/personal",{replace:!0}),s({message:"Form has been cleared.",type:"success"})},L=t=>{if(t.key!=="ArrowUp"&&t.key!=="ArrowDown"&&t.key!=="Enter")return;const r=t.target;if(t.key==="Enter"&&r.tagName!=="TEXTAREA"&&r.tagName!=="BUTTON"&&t.preventDefault(),t.key==="Enter"&&r.tagName==="BUTTON"||(t.key==="ArrowUp"||t.key==="ArrowDown")&&(r.tagName==="TEXTAREA"||r.type==="number"))return;const w=t.currentTarget,m=Array.from(w.querySelectorAll('input:not([type="hidden"]):not([readonly]), select, textarea, button')).filter(E=>!E.hasAttribute("disabled")&&E.offsetParent!==null),T=m.indexOf(document.activeElement);if(T===-1)return;(t.key==="ArrowUp"||t.key==="ArrowDown")&&t.preventDefault();let S=T;if(t.key==="ArrowUp"?S=T-1:S=T+1,S>=0&&S<m.length)m[S].focus();else if(t.key==="Enter"&&S>=m.length){const E=document.getElementById("save-and-next-button");E&&E.click()}};if(A)return e.jsxs("div",{className:"flex justify-center items-center h-full text-muted",children:[e.jsx(J,{className:"h-8 w-8 animate-spin mr-4"}),e.jsx("p",{children:"Loading application data..."})]});const H=u[i]==="review";return j?e.jsxs("div",{className:"h-full flex flex-col",children:[v&&e.jsx(K,{message:v.message,type:v.type,onDismiss:()=>s(null)}),e.jsx(Q,{steps:U,currentStepIndex:i,onStepClick:_,highestStepReached:B,isMobileOptimized:!0}),e.jsx("main",{className:"flex-1 overflow-y-auto p-4 pb-28",onKeyDown:L,children:e.jsx("div",{className:"bg-card p-6 rounded-2xl",children:e.jsx(X,{context:{onValidated:I,onSubmit:z,isSubmitting:b,setToast:s}})})}),e.jsxs("footer",{className:"fixed bottom-0 left-0 right-0 p-4 flex items-center justify-between gap-2 bg-card border-t border-[#123820] z-10",children:[e.jsx(P,{type:"button",onClick:G,variant:"secondary",children:"Back"}),e.jsx(P,{type:"button",onClick:()=>n("/onboarding"),variant:"secondary",className:"!p-3 !rounded-full","aria-label":"Go to Home",children:e.jsx(je,{className:"h-5 w-5"})}),e.jsx(P,{id:"save-and-next-button",type:"submit",form:`${u[i]}-form`,children:H?"Submit":"Next"})]})]}):e.jsx("div",{className:"p-4 md:p-0",children:e.jsxs("div",{className:`transition-opacity duration-300 ${b?"opacity-50 pointer-events-none":""}`,children:[v&&e.jsx(K,{message:v.message,type:v.type,onDismiss:()=>s(null)}),e.jsx(Ne,{isOpen:h,onClose:()=>c(!1),onConfirm:Y,title:"Confirm Clear Form",children:"Are you sure you want to clear all data entered in this form? This action cannot be undone."}),e.jsx(Q,{steps:U,currentStepIndex:i,onStepClick:_,highestStepReached:B,isMobileOptimized:j}),e.jsx("div",{className:"mt-8 bg-card p-6 sm:p-8 rounded-xl shadow-card",onKeyDown:L,children:e.jsx(X,{context:{onValidated:I,onSubmit:z,isSubmitting:b,setToast:s}})}),e.jsxs("div",{className:"mt-8 flex justify-between items-center",children:[e.jsx(P,{onClick:G,disabled:i===0,variant:"secondary",children:"Back"}),e.jsxs("div",{className:"flex flex-wrap gap-4 justify-end items-center",children:[e.jsxs("div",{className:"flex items-center gap-2 text-sm text-muted italic transition-opacity duration-300 min-h-[20px]",children:[l==="saving"&&e.jsxs(e.Fragment,{children:[e.jsx(J,{className:"h-4 w-4 animate-spin"}),e.jsx("span",{children:"Saving..."})]}),l==="saved"&&e.jsxs(e.Fragment,{children:[e.jsx(we,{className:"h-4 w-4 text-accent"}),e.jsx("span",{children:"Draft saved"})]}),l==="dirty"&&e.jsx("span",{className:"text-gray-500",children:"Unsaved changes"})]}),!H&&e.jsx(P,{id:"save-and-next-button",type:"submit",form:`${u[i]}-form`,children:"Save & Next"})]})]})]})})};export{Te as default};
