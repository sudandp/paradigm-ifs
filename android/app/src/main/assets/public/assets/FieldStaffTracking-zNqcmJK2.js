import{k as B,m as C,j as e,U,J as G}from"./index-D5q3SS3D.js";import{b as n}from"./react-vendor-BUaIliXj.js";import{D as z}from"./DatePicker-D2ulOwJx.js";import{S as _}from"./Select-Dz12MdxG.js";import{L as c}from"./leaflet-src-BVmFvWPy.js";import{P as W}from"./Pagination-DXf7cs0z.js";import{bH as H,N as q,bI as J,a2 as K,M as A}from"./ui-vendor-B8EvWqdc.js";import{f as S}from"./utils-vendor-DmorxLnX.js";import"./pdf-vendor-CB_F1AVu.js";import"./capacitor-vendor-CqiIOUn1.js";import"./supabase-7WG3J4rU.js";const P=(s,i)=>i==="field"?{"check-in":"Check In","check-out":"Check Out","break-in":"Break In","break-out":"Break Out"}[s]||s.replace("-"," "):{"check-in":"Punch In","check-out":"Punch Out","break-in":"Break In","break-out":"Break Out"}[s]||s.replace("-"," "),$=({lat:s,lng:i,fallback:a,knownLocations:m})=>{const[l,d]=n.useState(null),[x,u]=n.useState(!1),h=n.useMemo(()=>{if(!s||!i||m.length===0)return null;const p=[...m].sort((t,o)=>t.radius-o.radius);for(const t of p)if(c.latLng(s,i).distanceTo(c.latLng(t.latitude,t.longitude))<=t.radius)return t.name;return null},[s,i,m]);return n.useEffect(()=>{if(h){d(h);return}(async()=>{const t=!a||a.includes("GPS")||a.includes("Location");if(!(s!==0&&i!==0&&t)){d(a);return}try{u(!0);const f=await G(s,i);d(f)}catch{d(a||`${s.toFixed(4)}, ${i.toFixed(4)}`)}finally{u(!1)}})()},[s,i,a,h]),x?e.jsx("span",{className:"animate-pulse text-accent/50",children:"Resolving address..."}):e.jsx("span",{children:l||a||`${s.toFixed(4)}, ${i.toFixed(4)}`})},Q=({events:s,users:i})=>{const a=n.useRef(null),m=n.useRef(null),l=n.useRef(c.layerGroup()),d=n.useRef(null),{theme:x}=U();return n.useEffect(()=>{m.current&&!a.current&&(a.current=c.map(m.current,{zoomControl:!1}).setView([12.9716,77.5946],12),l.current.addTo(a.current),c.control.zoom({position:"bottomright"}).addTo(a.current)),setTimeout(()=>a.current?.invalidateSize(),100)},[]),n.useEffect(()=>{if(!a.current)return;const u=x==="dark",t=u?"https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png":"https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",o=u?'&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>':'&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors';d.current?(d.current.setUrl(t),a.current.attributionControl.setPrefix(o)):d.current=c.tileLayer(t,{attribution:o}).addTo(a.current)},[x]),n.useEffect(()=>{l.current.clearLayers();const u=new Map;s.forEach(t=>{if(t.latitude&&t.longitude){const o=u.get(t.userId);(!o||new Date(t.timestamp)>new Date(o.timestamp))&&u.set(t.userId,t)}});const h=new Map(i.map(t=>[t.id,t])),p=[];if(u.forEach(t=>{const o=h.get(t.userId);if(o&&t.latitude&&t.longitude){const f=c.divIcon({className:"",html:`<div class="user-marker" style="background-image: url(${o.photoUrl||`https://i.pravatar.cc/150?u=${o.id}`})"></div>`,iconSize:[48,48],iconAnchor:[24,56],popupAnchor:[0,-56]}),j=c.marker([t.latitude,t.longitude],{icon:f});j.bindPopup(`
                    <div class="user-marker-popup">
                        <p class="popup-name">${o.name}</p>
                        <p class="popup-time">Last seen: ${S(new Date(t.timestamp),"hh:mm a")}</p>
                    </div>
                `),l.current.addLayer(j),p.push(j)}}),p.length>0&&a.current){const t=c.featureGroup(p);a.current.fitBounds(t.getBounds().pad(.5))}else a.current&&a.current.setView([12.9716,77.5946],12)},[s,i]),e.jsx("div",{ref:m,style:{height:"600px",width:"100%",borderRadius:"1rem",zIndex:0}})},X=({events:s,selectedUser:i})=>{const a=n.useRef(null),m=n.useRef(null),l=n.useRef(null),d=n.useRef(null),x=n.useRef(c.layerGroup()),u=n.useRef(null),{theme:h}=U(),p=n.useMemo(()=>s.filter(t=>t.userId===i&&t.latitude&&t.longitude).sort((t,o)=>new Date(t.timestamp).getTime()-new Date(o.timestamp).getTime()),[s,i]);return n.useEffect(()=>{m.current&&!a.current&&(a.current=c.map(m.current,{zoomControl:!1}).setView([12.9716,77.5946],12),x.current.addTo(a.current),c.control.zoom({position:"bottomright"}).addTo(a.current)),setTimeout(()=>a.current?.invalidateSize(),100)},[]),n.useEffect(()=>{if(!a.current)return;const t=h==="dark",j=t?"https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png":"https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",g=t?'&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>':'&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors';u.current?(u.current.setUrl(j),a.current.attributionControl.setPrefix(g)):u.current=c.tileLayer(j,{attribution:g}).addTo(a.current)},[h]),n.useEffect(()=>{if(!a.current)return;if(x.current.clearLayers(),l.current&&(a.current.removeLayer(l.current),l.current=null),d.current&&(a.current.removeLayer(d.current),d.current=null),p.length===0){a.current.setView([12.9716,77.5946],12);return}const t=p.map(N=>[N.latitude,N.longitude]);l.current=c.polyline(t,{color:"#00BFA6",weight:4}).addTo(a.current);const o=t[0],f=t[t.length-1],j=c.marker(o,{icon:c.divIcon({className:"",html:'<div style="width:16px;height:16px;border-radius:50%;background-color:#00BFA6;border:2px solid white;"></div>',iconSize:[16,16],iconAnchor:[8,8]})}),g=c.marker(f,{icon:c.divIcon({className:"",html:'<div style="width:16px;height:16px;border-radius:50%;background-color:#EF4444;border:2px solid white;"></div>',iconSize:[16,16],iconAnchor:[8,8]})});x.current.addLayer(j),x.current.addLayer(g);let L=t[0][0],v=t[0][0],M=t[0][1],b=t[0][1];t.forEach(([N,w])=>{L=Math.min(L,N),v=Math.max(v,N),M=Math.min(M,w),b=Math.max(b,w)});const R=[L,M],T=[v,b];d.current=c.rectangle([R,T],{color:"#FFB700",weight:2,fillOpacity:.1}).addTo(a.current);const D=c.latLngBounds(R,T);a.current.fitBounds(D.pad(.2))},[p]),e.jsx("div",{ref:m,style:{height:"600px",width:"100%",borderRadius:"1rem",zIndex:0}})},Y=({event:s,knownLocations:i})=>e.jsxs("div",{className:"bg-card rounded-2xl border border-border overflow-hidden shadow-sm",children:[e.jsxs("div",{className:"p-3 bg-page flex justify-between items-center",children:[e.jsx("span",{className:"text-sm font-medium text-muted",children:"User"}),e.jsx("span",{className:"font-semibold text-primary-text",children:s.userName})]}),e.jsxs("div",{className:"p-3 space-y-3 text-sm",children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("span",{className:"text-muted font-medium",children:"Event"}),e.jsx("span",{className:"font-semibold text-primary-text",children:P(s.type,s.workType)})]}),e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("span",{className:"text-muted font-medium",children:"Timestamp"}),e.jsx("span",{className:"text-primary-text",children:S(new Date(s.timestamp),"dd MMM, yy - hh:mm a")})]}),e.jsxs("div",{className:"flex justify-between items-start",children:[e.jsx("span",{className:"text-muted font-medium",children:"Location"}),e.jsxs("div",{className:"flex flex-col items-end gap-1 text-right",children:[s.latitude&&s.longitude?e.jsx("div",{className:"font-semibold text-primary-text",children:e.jsx($,{lat:s.latitude,lng:s.longitude,fallback:s.locationName,knownLocations:i})}):s.locationName&&e.jsx("span",{className:"font-semibold text-primary-text",children:s.locationName}),s.latitude&&s.longitude?e.jsxs("a",{href:`https://www.google.com/maps/search/?api=1&query=${s.latitude},${s.longitude}`,target:"_blank",rel:"noopener noreferrer",className:"flex items-center text-accent hover:underline text-xs",children:[e.jsx(A,{className:"h-3 w-3 mr-1"})," View Map"]}):!s.locationName&&e.jsx("span",{className:"text-primary-text font-medium",children:"-"})]})]})]})]}),de=()=>{const[s,i]=n.useState("list"),[a,m]=n.useState([]),[l,d]=n.useState([]),[x,u]=n.useState([]),[h,p]=n.useState(!0),[t,o]=n.useState(S(new Date,"yyyy-MM-dd")),[f,j]=n.useState(S(new Date,"yyyy-MM-dd")),[g,L]=n.useState("all"),[v,M]=n.useState(1),[b,R]=n.useState(20),T=B("(max-width: 767px)"),D=n.useMemo(()=>l.filter(r=>r.role==="field_staff"),[l]),N=n.useCallback(async()=>{p(!0);try{const r=new Date(t);r.setHours(0,0,0,0);const k=new Date(f);k.setHours(23,59,59,999);const[y,I,V]=await Promise.all([C.getAllAttendanceEvents(r.toISOString(),k.toISOString()),C.getUsers(),C.getLocations()]);m(y),d(I),u(V)}catch(r){console.error("Failed to fetch tracking data",r)}finally{p(!1)}},[t,f]);n.useEffect(()=>{N()},[N]);const w=n.useMemo(()=>{let r=a;g!=="all"&&(r=r.filter(y=>y.userId===g));const k=new Map(l.map(y=>[y.id,y]));return r.map(y=>({...y,userName:k.get(y.userId)?.name||"Unknown User"})).sort((y,I)=>new Date(I.timestamp).getTime()-new Date(y.timestamp).getTime())},[a,l,g]),E=n.useMemo(()=>{const r=(v-1)*b;return w.slice(r,r+b)},[w,v,b]);n.useEffect(()=>{M(1)},[g,t,f,b]);const O=n.useMemo(()=>{const r=new Set(w.map(k=>k.userId));return l.filter(k=>r.has(k.id))},[w,l]),F=()=>h?e.jsx("div",{className:"flex justify-center items-center h-96",children:e.jsx(K,{className:"h-8 w-8 animate-spin text-accent"})}):s==="map"?e.jsx(Q,{events:w,users:O}):s==="route"?g==="all"?e.jsx("div",{className:"text-center py-10 text-muted",children:"Please select a specific user to view their route coverage."}):e.jsx(X,{events:w,selectedUser:g}):T?e.jsx("div",{className:"space-y-3",children:E.length===0?e.jsx("div",{className:"text-center py-10 text-muted",children:"No events found."}):E.map(r=>e.jsx(Y,{event:r,knownLocations:x},r.id))}):e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"min-w-full divide-y divide-border responsive-table",children:[e.jsx("thead",{className:"bg-page",children:e.jsxs("tr",{children:[e.jsx("th",{scope:"col",className:"px-6 py-3 text-left text-xs font-medium text-muted uppercase",style:{width:"15%"},children:"User"}),e.jsx("th",{scope:"col",className:"px-6 py-3 text-left text-xs font-medium text-muted uppercase",style:{width:"12%"},children:"Event"}),e.jsx("th",{scope:"col",className:"px-6 py-3 text-left text-xs font-medium text-muted uppercase",style:{width:"18%"},children:"Timestamp"}),e.jsx("th",{scope:"col",className:"px-6 py-3 text-left text-xs font-medium text-muted uppercase",style:{width:"55%",maxWidth:"400px"},children:"Location"})]})}),e.jsx("tbody",{children:E.length===0?e.jsx("tr",{children:e.jsx("td",{colSpan:4,className:"text-center py-10 text-muted",children:"No events found."})}):E.map(r=>e.jsxs("tr",{children:[e.jsx("td",{"data-label":"User",className:"px-6 py-4 font-medium",style:{width:"15%"},children:r.userName}),e.jsx("td",{"data-label":"Event",className:"px-6 py-4",style:{width:"12%"},children:P(r.type,r.workType)}),e.jsx("td",{"data-label":"Timestamp",className:"px-6 py-4 text-sm text-muted",style:{width:"18%"},children:S(new Date(r.timestamp),"dd MMM, yyyy - hh:mm a")}),e.jsx("td",{"data-label":"Location",className:"px-6 py-4 text-sm text-muted",style:{width:"55%",maxWidth:"400px"},children:e.jsxs("div",{className:"flex flex-col gap-1 break-words",children:[r.latitude&&r.longitude?e.jsx("div",{className:"font-medium text-primary-text break-words",children:e.jsx($,{lat:r.latitude,lng:r.longitude,fallback:r.locationName,knownLocations:x})}):r.locationName&&e.jsx("span",{className:"font-medium text-primary-text break-words",children:r.locationName}),r.latitude&&r.longitude?e.jsxs("a",{href:`https://www.google.com/maps/search/?api=1&query=${r.latitude},${r.longitude}`,target:"_blank",rel:"noopener noreferrer",className:"flex items-center text-accent hover:underline text-xs flex-shrink-0",children:[e.jsx(A,{className:"h-3 w-3 mr-1 flex-shrink-0"})," View Map"]}):!r.locationName&&"-"]})})]},r.id))})]})});return e.jsxs("div",{className:"p-4 border-0 shadow-none md:bg-card md:p-6 md:rounded-xl md:shadow-card",children:[e.jsxs("div",{className:"mb-6",children:[e.jsxs("div",{className:"flex flex-col sm:flex-row justify-between sm:items-center gap-4",children:[e.jsx("h2",{className:"text-2xl font-bold text-primary-text flex-shrink-0",children:"User Activity Tracking"}),e.jsxs("div",{className:"flex flex-col sm:flex-row items-start sm:items-center gap-2 w-full flex-1 justify-end flex-wrap max-w-full",children:[e.jsx("div",{className:"w-full sm:w-32",children:e.jsx(z,{label:"",id:"start-date",value:t,onChange:o})}),e.jsx("div",{className:"w-full sm:w-32",children:e.jsx(z,{label:"",id:"end-date",value:f,onChange:j})}),e.jsx("div",{className:"w-full sm:w-40",children:e.jsxs(_,{label:"",id:"user-select",value:g,onChange:r=>L(r.target.value),children:[e.jsx("option",{value:"all",children:"All Users"}),D.map(r=>e.jsx("option",{value:r.id,children:r.name},r.id))]})})]})]}),e.jsx("div",{className:"mt-4",children:e.jsxs("div",{className:"bg-page p-1 rounded-full flex items-center flex-wrap w-full justify-start gap-1",children:[e.jsxs("button",{onClick:()=>i("list"),className:`px-3 py-1 text-sm font-semibold rounded-full flex items-center gap-2 transition-colors duration-200 ${s==="list"?"bg-accent text-white shadow-sm":"text-muted hover:text-primary-text"}`,children:[e.jsx(H,{className:"h-4 w-4"}),"List View"]}),e.jsxs("button",{onClick:()=>i("map"),className:`px-3 py-1 text-sm font-semibold rounded-full flex items-center gap-2 transition-colors duration-200 ${s==="map"?"bg-accent text-white shadow-sm":"text-muted hover:text-primary-text"}`,children:[e.jsx(q,{className:"h-4 w-4"}),"Map View"]}),e.jsxs("button",{onClick:()=>i("route"),className:`px-3 py-1 text-sm font-semibold rounded-full flex items-center gap-2 transition-colors duration-200 ${s==="route"?"bg-accent text-white shadow-sm":"text-muted hover:text-primary-text"}`,children:[e.jsx(J,{className:"h-4 w-4"}),"Route View"]})]})})]}),e.jsx("div",{className:"mt-6",children:F()}),s==="list"&&!h&&w.length>0&&e.jsx(W,{currentPage:v,totalItems:w.length,pageSize:b,onPageChange:M,onPageSizeChange:R,className:"mt-6"})]})};export{de as default};
