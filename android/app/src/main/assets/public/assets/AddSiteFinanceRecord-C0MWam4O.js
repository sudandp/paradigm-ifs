import{c as se,j as e,C as f,I as b,T as ne,m as d,s as re}from"./index-D5q3SS3D.js";import{u as ce,l as oe,b as m,R as le}from"./react-vendor-BUaIliXj.js";import{S as ie}from"./SearchableSelect-B7rWk5GL.js";import{R as de,w as me,bG as ue,D as ge,I as M,f as pe,a2 as xe,aJ as fe}from"./ui-vendor-B8EvWqdc.js";import{f as A,c as P}from"./utils-vendor-DmorxLnX.js";import"./pdf-vendor-CB_F1AVu.js";import"./capacitor-vendor-CqiIOUn1.js";import"./supabase-7WG3J4rU.js";const Fe=()=>{const h=ce(),{id:u}=oe(),F=!!u,[T,j]=m.useState(!1),[S,g]=m.useState(null),[E,V]=m.useState([]),[L,$]=m.useState([]),[U,_]=m.useState([]),[D,w]=m.useState(null),[o,G]=m.useState(null),[y,q]=m.useState(null),{control:x,handleSubmit:z,setValue:l,watch:k,reset:O,formState:{errors:be}}=se({defaultValues:{contractAmount:"",contractManagementFee:"",billedAmount:"",billedManagementFee:"",status:"pending",billingMonth:A(P(new Date),"yyyy-MM-dd")}}),[H,J,W,Q]=k(["contractAmount","contractManagementFee","billedAmount","billedManagementFee"]),X=Number(H)||0,Z=Number(J)||0,C=Number(W)||0,B=Number(Q)||0,ee=C-X,ae=B-Z,v=ee+ae,I=v>=0;m.useEffect(()=>{l("totalBilledAmount",C+B)},[C,B,l]),m.useEffect(()=>{(async()=>{j(!0);try{const[a,r,c,N]=await Promise.all([d.getOrganizations(),d.getSiteInvoiceDefaults(),d.getUniqueTrackerSites(),d.getSiteInvoiceRecords()]),i=Array.isArray(a)?a:a.data||[];V(i),_(r);const s=[...c];N.forEach(n=>{n.siteName&&!s.find(R=>R.name===n.siteName)&&s.push({id:n.siteId||n.siteName,name:n.siteName})}),$(s);const{data:{user:p}}=await re.auth.getUser();if(p){const n=p.user_metadata?.full_name||p.email?.split("@")[0]||"Unknown",R=await d.getUserById(p.id);G({id:p.id,name:n,role:R?.role||"user"})}if(F&&u){const n=await d.getSiteFinanceRecord(u);n?(O({siteId:n.siteId,siteName:n.siteName,billingMonth:n.billingMonth,companyName:n.companyName,contractAmount:n.contractAmount,contractManagementFee:n.contractManagementFee,billedAmount:n.billedAmount,billedManagementFee:n.billedManagementFee,status:n.status}),q({createdBy:n.createdBy,createdByName:n.createdByName,createdAt:n.createdAt,updatedBy:n.updatedBy,updatedAt:n.updatedAt,updatedByName:n.updatedByName})):(g({message:"Record not found",type:"error"}),h("/finance?tab=site"))}}catch(a){console.error("Error loading data:",a),g({message:"Failed to load form data",type:"error"})}finally{j(!1)}})()},[F,u,O,h]);const te=async t=>{j(!0);try{const a=t.billingMonth?new Date(t.billingMonth):new Date,r=A(P(a),"yyyy-MM-dd"),c={...t,billingMonth:r,id:u};!u&&o?(c.createdBy=o.id,c.createdByName=o.name,c.createdByRole=o.role):u&&o&&(c.updatedBy=o.id,c.updatedByName=o.name,c.updatedAt=new Date().toISOString());const N=new Date(c.billingMonth||new Date).getFullYear();if((c.contractAmount!==D?.contractAmount||c.contractManagementFee!==D?.contractManagementFee||c.companyName!==D?.companyName)&&c.siteId&&c.contractAmount!==void 0&&c.contractManagementFee!==void 0&&c.companyName)try{await d.upsertSiteContract(c.siteId,N,{contractAmount:c.contractAmount,contractManagementFee:c.contractManagementFee,companyName:c.companyName,createdBy:o.id,createdByName:o.name});const s=await d.getSiteInvoiceDefaults();_(s)}catch(s){console.error("Failed to update site contract defaults:",s)}await d.saveSiteFinanceRecord(c),g({message:"Finance record saved successfully",type:"success"}),setTimeout(()=>h("/finance?tab=site"),1e3)}catch(a){console.error("Save error:",a),g({message:"Failed to save record",type:"error"})}finally{j(!1)}},Y=le.useMemo(()=>{const t=new Map;return E.forEach(a=>{t.set(a.id,a.shortName)}),L.forEach(a=>{a.name&&t.set(a.id,a.name)}),Array.from(t.entries()).map(([a,r])=>({id:a,name:r})).sort((a,r)=>a.name.localeCompare(r.name))},[E,L]),K=async(t,a)=>{l("siteId",t),l("siteName",a);const r=new Date(k("billingMonth")||new Date).getFullYear(),c=U.find(s=>(s.siteId===t||s.siteName===a)&&s.billingYear===r),N=U.find(s=>(s.siteId===t||s.siteName===a)&&(s.billingYear===null||s.billingYear===void 0)),i=c||N;if(i)w(i),l("companyName",i.companyName),i.contractAmount&&l("contractAmount",i.contractAmount),i.contractManagementFee&&l("contractManagementFee",i.contractManagementFee);else try{const s=await d.getLastFinanceRecordForSite(t);if(s){const p={siteId:t,siteName:a,companyName:s.companyName,contractAmount:s.contractAmount,contractManagementFee:s.contractManagementFee};w(p),l("companyName",s.companyName),s.contractAmount&&l("contractAmount",s.contractAmount),s.contractManagementFee&&l("contractManagementFee",s.contractManagementFee),g({message:"Auto-filled from previous record",type:"success"})}else w(null),g({message:"No previous records found for auto-fill",type:"error"})}catch(s){console.error("Error fetching fallback record:",s),w(null)}};return e.jsxs("div",{className:"w-full p-4 md:p-8 space-y-6",children:[e.jsxs("button",{onClick:()=>h("/finance?tab=site"),className:"flex items-center text-xs font-bold text-gray-400 hover:text-primary transition-all group",children:[e.jsx(de,{className:"h-4 w-4 mr-1.5"}),"Back to Tracker"]}),e.jsxs("div",{className:"bg-white rounded-3xl shadow-sm border border-gray-100 p-8",children:[e.jsxs("div",{className:"flex items-center gap-4 mb-8",children:[e.jsx("div",{className:"p-3 bg-gray-50 rounded-2xl",children:e.jsx(me,{className:"h-6 w-6 text-gray-600"})}),e.jsxs("div",{children:[e.jsx("h2",{className:"text-2xl font-black text-gray-900 leading-none",children:"Add New Record"}),e.jsx("p",{className:"text-sm text-gray-500 mt-1.5",children:"Fill in the site billing details below to calculate variations."})]})]}),e.jsxs("form",{onSubmit:z(te),className:"space-y-8",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-8",children:[e.jsx("div",{className:"space-y-2",children:e.jsx(ie,{label:"Select Site",placeholder:"Select or type site name...",options:Y.map(t=>({id:t.id,name:t.name})),value:k("siteName")||"",onChange:t=>{const a=Y.find(r=>r.name===t);a?K(a.id,a.name):K(t,t)},allowCustom:!0,labelClassName:"text-emerald-500 uppercase tracking-wider ml-1"})}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("label",{className:"text-xs font-bold text-gray-500 uppercase tracking-wider ml-1",children:"Billing Date"}),e.jsx(f,{name:"billingMonth",control:x,render:({field:t})=>e.jsx(b,{type:"date",...t,value:t.value?t.value.split("T")[0]:"",disabled:!1,className:"h-12 !pl-4 border-gray-200 focus:border-emerald-500"})})]})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-8",children:[e.jsxs("div",{className:"bg-white rounded-3xl border border-gray-100 p-8 shadow-[0_4px_20px_-4px_rgba(0,0,0,0.05)]",children:[e.jsx("h3",{className:"text-xs font-black text-emerald-500 uppercase tracking-widest mb-6 flex items-center justify-between gap-2",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(ue,{className:"h-4 w-4"})," CONTRACT DETAILS"]})}),e.jsxs("div",{className:"space-y-6",children:[e.jsx(f,{name:"companyName",control:x,render:({field:t})=>e.jsx(b,{label:"Company Name",type:"text",icon:e.jsx(ge,{className:"h-4 w-4"}),placeholder:"Auto-filled...",...t,className:"bg-white border-gray-200 focus:border-emerald-500"})}),e.jsx(f,{name:"contractAmount",control:x,render:({field:t})=>e.jsx(b,{label:"Contract Amount",type:"number",inputMode:"numeric",icon:e.jsx(M,{className:"h-4 w-4"}),placeholder:"0",...t,className:"bg-white border-gray-200 focus:border-emerald-500",onChange:a=>{const r=a.target.value;t.onChange(r===""?"":Number(r))},onFocus:a=>a.target.select(),onKeyDown:a=>{["e","E","+","-"].includes(a.key)&&a.preventDefault()}})}),e.jsx(f,{name:"contractManagementFee",control:x,render:({field:t})=>e.jsx(b,{label:"Management Fee",type:"number",inputMode:"numeric",icon:e.jsx(M,{className:"h-4 w-4"}),placeholder:"0",...t,className:"bg-white border-gray-200 focus:border-emerald-500",onChange:a=>{const r=a.target.value;t.onChange(r===""?"":Number(r))},onFocus:a=>a.target.select(),onKeyDown:a=>{["e","E","+","-"].includes(a.key)&&a.preventDefault()}})})]})]}),e.jsxs("div",{className:"bg-white rounded-3xl border border-gray-100 p-8 shadow-[0_4px_20px_-4px_rgba(0,0,0,0.05)]",children:[e.jsxs("h3",{className:"text-xs font-black text-orange-500 uppercase tracking-widest mb-6 flex items-center gap-2",children:[e.jsx(pe,{className:"h-4 w-4"})," BILLING DETAILS"]}),e.jsxs("div",{className:"space-y-6",children:[e.jsx(f,{name:"billedAmount",control:x,render:({field:t})=>e.jsx(b,{label:"Billed Amount",type:"number",inputMode:"numeric",icon:e.jsx(M,{className:"h-4 w-4"}),placeholder:"0",...t,onChange:a=>{const r=a.target.value;t.onChange(r===""?"":Number(r))},onFocus:a=>a.target.select(),onKeyDown:a=>{["e","E","+","-"].includes(a.key)&&a.preventDefault()}})}),e.jsx(f,{name:"billedManagementFee",control:x,render:({field:t})=>e.jsx(b,{label:"Management Fee",type:"number",inputMode:"numeric",icon:e.jsx(M,{className:"h-4 w-4"}),placeholder:"0",...t,onChange:a=>{const r=a.target.value;t.onChange(r===""?"":Number(r))},onFocus:a=>a.target.select(),onKeyDown:a=>{["e","E","+","-"].includes(a.key)&&a.preventDefault()}})})]})]})]}),F&&y&&e.jsxs("div",{className:"bg-gray-50 rounded-2xl p-6 border border-gray-200",children:[e.jsx("h3",{className:"text-xs font-black text-gray-400 uppercase tracking-widest mb-4",children:"Record History"}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4 text-xs",children:[e.jsxs("div",{children:[e.jsx("span",{className:"block font-bold text-gray-500 mb-0.5",children:"Created By"}),e.jsx("span",{className:"text-gray-900 font-medium",children:y.createdByName||"Unknown"}),e.jsx("span",{className:"text-gray-400 ml-2",children:y.createdAt?A(new Date(y.createdAt),"dd MMM yyyy, hh:mm a"):"-"})]}),y.updatedAt&&e.jsxs("div",{children:[e.jsx("span",{className:"block font-bold text-gray-500 mb-0.5",children:"Last Updated"}),e.jsxs("span",{className:"text-gray-900 font-medium",children:[o?.name," (You)"]}),e.jsx("span",{className:"text-gray-400 ml-2",children:A(new Date,"dd MMM yyyy")})]})]})]}),e.jsxs("div",{className:"bg-white rounded-3xl border border-gray-300 p-6 flex flex-col md:flex-row items-center justify-between gap-4 shadow-sm",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx("span",{className:"text-[10px] font-black text-gray-400 uppercase tracking-[0.2em]",children:"CALCULATED VARIATION"}),e.jsxs("div",{className:`text-4xl font-black flex items-center ${v>=0?"text-emerald-500":"text-rose-500"}`,children:[v>=0?"+":"-","â‚¹",Math.abs(v).toLocaleString("en-IN")]})]}),e.jsxs("div",{className:"flex flex-col items-end gap-1.5",children:[e.jsx("span",{className:"text-[10px] font-black text-gray-400 uppercase tracking-[0.2em] w-full text-right",children:"VARIATION STATUS"}),e.jsxs("div",{className:`flex items-center gap-2 px-6 py-2 rounded-full text-xs font-black uppercase transition-all ${I?"bg-emerald-100 text-emerald-800":"bg-rose-100 text-rose-800"}`,children:[e.jsx("div",{className:`w-1.5 h-1.5 rounded-full ${I?"bg-emerald-500":"bg-rose-500"}`}),I?"PROFIT":"LOSS"]})]})]}),e.jsxs("div",{className:"flex justify-end gap-3 pt-4",children:[e.jsx("button",{type:"button",onClick:()=>h("/finance?tab=site"),className:"px-8 h-12 rounded-xl text-sm font-bold text-gray-500 hover:bg-gray-50 transition-colors",children:"Cancel"}),e.jsxs("button",{type:"submit",disabled:T,className:"px-8 h-12 rounded-xl text-sm font-bold bg-[#006B3F] text-white hover:bg-[#005632] transition-colors shadow-lg shadow-emerald-900/10 flex items-center",children:[T?e.jsx(xe,{className:"h-5 w-5 animate-spin mr-2"}):e.jsx(fe,{className:"h-5 w-5 mr-2"}),"Save Record"]})]})]})]}),S&&e.jsx(ne,{message:S.message,type:S.type,onDismiss:()=>g(null)})]})};export{Fe as default};
